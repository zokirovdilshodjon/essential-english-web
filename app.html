<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Essential English PRO</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d1117;--s1:#161b27;--s2:#1c2438;--s3:#232d42;
  --border:#2a3550;--text:#e8f0fe;--muted:#7a8fad;
  --accent:#7c5af6;--al:#a07cf8;
  --blue:#4f9cf9;--green:#4fdf8a;--purple:#c084fc;
  --orange:#f97b4f;--gold:#f5c542;--red:#f85149;
}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:'Nunito',sans-serif;min-height:100vh;overflow-x:hidden;
  background-image:radial-gradient(ellipse 60% 40% at 0% 0%,rgba(124,90,246,.07) 0,transparent 60%),
    radial-gradient(ellipse 50% 50% at 100% 100%,rgba(192,132,252,.06) 0,transparent 60%);}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(124,90,246,.03) 1px,transparent 1px),
    linear-gradient(90deg,rgba(124,90,246,.03) 1px,transparent 1px);background-size:32px 32px;}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
#app{display:grid;grid-template-rows:auto 1fr auto;min-height:100vh;max-width:480px;margin:0 auto;position:relative;z-index:1}
.topbar{background:rgba(13,17,23,.95);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);
  padding:10px 16px 8px;position:sticky;top:0;z-index:100;}
.tb-row{display:flex;align-items:center;gap:10px}
.tb-av{width:40px;height:40px;border-radius:50%;background:var(--s2);border:2px solid var(--accent);
  overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.tb-av img{width:80%;height:80%;object-fit:contain}
.tb-info{flex:1;min-width:0}
.tb-name{font-weight:800;font-size:14px;line-height:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tb-sub{font-size:11px;color:var(--muted);margin-top:2px;display:flex;align-items:center;gap:6px}
.badge{padding:2px 8px;border-radius:20px;font-size:10px;font-weight:800}
.badge.beginner{background:rgba(79,223,138,.15);color:var(--green)}
.badge.intermediate{background:rgba(79,156,249,.15);color:var(--blue)}
.badge.advanced{background:rgba(192,132,252,.15);color:var(--purple)}
.tb-right{display:flex;align-items:center;gap:7px}
.streak{display:flex;align-items:center;gap:4px;background:rgba(245,197,66,.1);border:1px solid rgba(245,197,66,.2);
  padding:4px 9px;border-radius:20px;font-size:12px;font-weight:800;color:var(--gold);}
.xp-chip{background:rgba(124,90,246,.1);border:1px solid rgba(124,90,246,.2);
  padding:4px 9px;border-radius:20px;font-size:12px;font-weight:800;color:var(--al);}
.prog-bar-wrap{padding:7px 16px 5px}
.prog-labels{display:flex;justify-content:space-between;font-size:10px;color:var(--muted);font-weight:700;margin-bottom:4px}
.prog-track{height:4px;background:var(--s2);border-radius:10px;overflow:hidden}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--purple));border-radius:10px;transition:width .8s cubic-bezier(.34,1.56,.64,1)}
.scroll-area{overflow-y:auto;padding:14px 16px 4px}
.sec{margin-bottom:20px}
.sec-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.sec-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:800;display:flex;align-items:center;gap:6px}
.sec-link{font-size:12px;color:var(--blue);cursor:pointer;font-weight:700}
.unit-row{display:flex;gap:6px;margin-bottom:10px;overflow-x:auto;padding-bottom:2px}
.unit-row::-webkit-scrollbar{display:none}
.unit-pill{flex-shrink:0;padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;
  background:var(--s2);border:1.5px solid var(--border);color:var(--muted);cursor:pointer;transition:all .2s;}
.unit-pill.active{background:rgba(124,90,246,.12);border-color:var(--accent);color:var(--al)}
.unit-pill.done{background:rgba(79,223,138,.08);border-color:var(--green);color:var(--green)}
.fc-outer{perspective:1200px;margin-bottom:10px}
.fc{width:100%;height:168px;cursor:pointer;
  transform-style:preserve-3d;transition:transform .5s cubic-bezier(.34,1.56,.64,1);position:relative;}
.fc.flipped{transform:rotateY(180deg)}
.fc-face{position:absolute;inset:0;background:linear-gradient(135deg,var(--s2),var(--s3));
  border:1px solid var(--border);border-radius:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:20px;backface-visibility:hidden;-webkit-backface-visibility:hidden;box-shadow:0 8px 24px rgba(0,0,0,.3);}
.fc-back{transform:rotateY(180deg)}
.fc-pos{position:absolute;top:12px;left:14px;font-size:10px;font-weight:800;text-transform:uppercase;
  letter-spacing:.08em;padding:2px 8px;border-radius:20px;background:rgba(124,90,246,.12);color:var(--al);}
.fc-utag{position:absolute;top:12px;right:14px;font-size:10px;color:var(--muted);font-weight:700}
.fc-word{font-family:'Syne',sans-serif;font-size:34px;font-weight:800;color:var(--blue);margin-bottom:4px;letter-spacing:-.01em}
.fc-hint{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:4px}
.fc-trans{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--purple);margin-bottom:4px}
.fc-def{font-size:12px;color:var(--muted);text-align:center;line-height:1.5;margin-bottom:4px}
.fc-eg{font-size:11px;color:rgba(192,132,252,.7);font-style:italic;text-align:center;line-height:1.4}
.fc-ctrl{display:flex;align-items:center;justify-content:space-between}
.fc-nav{display:flex;align-items:center;gap:8px}
.fc-btn{width:36px;height:36px;border-radius:50%;background:var(--s2);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;font-size:16px;}
.fc-btn:hover{border-color:var(--blue);background:rgba(79,156,249,.1)}
.fc-count{font-size:12px;color:var(--muted);font-weight:700;min-width:44px;text-align:center}
.audio-btn{display:flex;align-items:center;gap:5px;padding:8px 13px;
  background:rgba(79,223,138,.08);border:1px solid rgba(79,223,138,.2);
  border-radius:20px;font-size:12px;font-weight:700;color:var(--green);cursor:pointer;transition:all .2s;}
.audio-btn:hover{background:rgba(79,223,138,.15)}
.games-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.game-card{background:var(--s1);border:1px solid var(--border);border-radius:14px;
  padding:14px 10px;text-align:center;cursor:pointer;transition:all .25s;position:relative;overflow:hidden;}
.game-card::after{content:'';position:absolute;inset:0;opacity:0;transition:opacity .3s}
.game-card:nth-child(1)::after{background:radial-gradient(circle at 50% 110%,rgba(249,123,79,.18),transparent 65%)}
.game-card:nth-child(2)::after{background:radial-gradient(circle at 50% 110%,rgba(79,156,249,.18),transparent 65%)}
.game-card:nth-child(3)::after{background:radial-gradient(circle at 50% 110%,rgba(79,223,138,.18),transparent 65%)}
.game-card:hover{transform:translateY(-3px)}
.game-card:hover::after{opacity:1}
.g-icon{font-size:26px;margin-bottom:5px}
.g-name{font-size:11px;font-weight:800;line-height:1.2}
.g-desc{font-size:10px;color:var(--muted);margin-top:2px}
.gr-list{display:flex;flex-direction:column;gap:7px}
.gr-item{background:var(--s1);border:1px solid var(--border);border-radius:13px;padding:12px 14px;
  display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .2s;}
.gr-item:hover{border-color:var(--purple);background:rgba(192,132,252,.04)}
.gr-ico{width:36px;height:36px;border-radius:9px;background:rgba(192,132,252,.1);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
.gr-txt{flex:1}
.gr-title{font-size:13px;font-weight:700}
.gr-sub{font-size:11px;color:var(--muted);margin-top:1px}
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
.stat{background:var(--s1);border:1px solid var(--border);border-radius:13px;padding:13px 10px;text-align:center}
.stat-n{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:2px}
.stat-l{font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.04em}
.lb-list{display:flex;flex-direction:column;gap:5px}
.lb-row{display:flex;align-items:center;gap:9px;background:var(--s1);border:1px solid var(--border);border-radius:11px;padding:9px 13px}
.lb-row.me{border-color:var(--accent);background:rgba(124,90,246,.06)}
.lb-rank{width:22px;text-align:center;font-family:'Syne',sans-serif;font-size:13px;font-weight:800;flex-shrink:0}
.lb-av{width:32px;height:32px;border-radius:50%;background:var(--s2);overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.lb-av img{width:80%;height:80%;object-fit:contain}
.lb-name{flex:1;font-size:13px;font-weight:700}
.lb-xp{font-size:13px;font-weight:800;color:var(--gold)}
.wl-item{display:flex;align-items:center;justify-content:space-between;background:var(--s2);border-radius:10px;padding:10px 12px;margin-bottom:5px}
.wl-w{font-size:14px;font-weight:700;color:var(--blue)}
.wl-t{font-size:12px;color:var(--muted);margin-top:1px}
.wl-p{font-size:10px;padding:2px 8px;border-radius:20px;background:rgba(192,132,252,.1);color:var(--purple);font-weight:700}
.battle-hero{background:linear-gradient(135deg,rgba(249,123,79,.08),rgba(192,132,252,.06));
  border:1px solid rgba(249,123,79,.2);border-radius:18px;padding:18px;text-align:center;margin-bottom:14px;}
.bh-vs{font-family:'Syne',sans-serif;font-size:34px;font-weight:800;
  background:linear-gradient(90deg,var(--orange),var(--purple));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px}
.bh-players{display:flex;align-items:center;justify-content:center;gap:16px}
.bh-player{text-align:center}
.bh-av{width:48px;height:48px;border-radius:50%;background:var(--s2);border:2px solid var(--border);
  margin:0 auto 4px;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:20px;}
.bh-av img{width:80%;height:80%;object-fit:contain}
.bh-pname{font-size:11px;font-weight:700;color:var(--muted)}
.bh-score{font-size:22px;font-weight:800;color:var(--orange)}
.btn-p{width:100%;padding:13px;border:none;border-radius:12px;
  background:linear-gradient(135deg,var(--orange),#c75a2f);color:white;
  font-size:15px;font-weight:800;font-family:'Nunito',sans-serif;
  cursor:pointer;margin-bottom:7px;transition:transform .2s;
  box-shadow:0 6px 20px rgba(249,123,79,.25);}
.btn-p:hover{transform:translateY(-2px)}
.btn-s{width:100%;padding:12px;background:var(--s2);border:1.5px solid var(--border);
  border-radius:12px;font-size:13px;font-weight:700;font-family:'Nunito',sans-serif;
  color:var(--text);cursor:pointer;transition:all .2s;margin-bottom:7px;}
.btn-s:hover{border-color:var(--blue)}
.bottomnav{background:rgba(13,17,23,.95);backdrop-filter:blur(16px);border-top:1px solid var(--border);
  display:flex;padding:6px 4px;padding-bottom:max(6px,env(safe-area-inset-bottom));
  position:sticky;bottom:0;z-index:100;}
.nav-b{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;
  padding:5px 2px;border-radius:10px;border:none;background:transparent;
  color:var(--muted);font-family:'Nunito',sans-serif;cursor:pointer;transition:all .2s;}
.nav-b.active{color:var(--accent)}
.nav-b-icon{font-size:19px;line-height:1}
.nav-b-label{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.04em}
.tab-pages>div{display:none}
.tab-pages>div.active{display:block;animation:fadeIn .25s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);
  z-index:200;display:none;align-items:flex-end;justify-content:center;}
.overlay.open{display:flex;animation:fadeIn .2s ease}
.sheet{width:100%;max-width:480px;max-height:90vh;background:var(--s1);
  border:1px solid var(--border);border-radius:22px 22px 0 0;overflow-y:auto;position:relative;
  animation:sheetUp .3s cubic-bezier(.34,1.56,.64,1);}
@keyframes sheetUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sh{width:36px;height:3px;background:var(--border);border-radius:3px;margin:10px auto 14px}
.sb{padding:0 20px 28px}
.st{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:14px}
.sc{position:absolute;top:13px;right:16px;width:30px;height:30px;border-radius:50%;
  background:var(--s2);border:1px solid var(--border);display:flex;align-items:center;
  justify-content:center;cursor:pointer;font-size:14px;color:var(--muted);transition:all .2s;}
.sc:hover{color:var(--text)}
.gsbar{display:flex;justify-content:space-between;background:var(--s2);border-radius:11px;padding:10px 14px;margin-bottom:14px;font-size:12px;font-weight:700}
.gword{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;color:var(--blue);
  text-align:center;padding:18px;background:var(--s2);border-radius:14px;margin-bottom:14px;}
.gopts{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.gopt{padding:12px;background:var(--s2);border:1.5px solid var(--border);
  border-radius:11px;text-align:center;cursor:pointer;font-size:12px;font-weight:700;
  transition:all .2s;font-family:'Nunito',sans-serif;color:var(--text);}
.gopt:hover{border-color:var(--blue)}
.gopt.correct{border-color:var(--green);background:rgba(79,223,138,.12);color:var(--green)}
.gopt.wrong{border-color:var(--red);background:rgba(248,81,73,.12);color:var(--red)}
.match-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.mw{padding:11px;background:var(--s2);border:1.5px solid var(--border);border-radius:11px;text-align:center;cursor:pointer;font-size:12px;font-weight:700;transition:all .2s}
.mw.selected{border-color:var(--blue);background:rgba(79,156,249,.1)}
.mw.matched{border-color:var(--green);background:rgba(79,223,138,.1);color:var(--green);pointer-events:none}
.mw.bad{border-color:var(--red);background:rgba(248,81,73,.1);color:var(--red)}
.a-hint{font-size:16px;font-weight:800;color:var(--purple);text-align:center;margin-bottom:8px}
.a-slots{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;min-height:52px;padding:8px;background:var(--s2);border-radius:12px;margin-bottom:10px}
.a-slot{width:40px;height:44px;background:var(--border);border-radius:9px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:18px;font-weight:800;cursor:pointer;transition:all .2s}
.a-slot:hover{background:rgba(248,81,73,.2)}
.a-letters{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-bottom:12px}
.a-tile{width:40px;height:44px;background:var(--s2);border:1.5px solid var(--border);border-radius:9px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:18px;font-weight:800;cursor:pointer;transition:all .2s;user-select:none}
.a-tile:hover{border-color:var(--blue);transform:translateY(-2px)}
.a-tile.used{opacity:.25;pointer-events:none}
.gr-rule{background:rgba(192,132,252,.07);border:1px solid rgba(192,132,252,.15);border-radius:12px;padding:14px;font-size:13px;line-height:1.8;margin-bottom:12px}
.gr-eg{background:var(--s2);border-left:3px solid var(--purple);border-radius:0 9px 9px 0;padding:9px 13px;font-size:12px;font-style:italic;color:var(--purple);margin-bottom:7px}
.qopt{padding:10px 13px;background:var(--s2);border:1.5px solid var(--border);border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;transition:all .2s;font-family:'Nunito',sans-serif;color:var(--text);text-align:left;margin-bottom:6px;width:100%}
.qopt:hover{border-color:var(--purple)}
.qopt.correct{border-color:var(--green);background:rgba(79,223,138,.1);color:var(--green)}
.qopt.wrong{border-color:var(--red);background:rgba(248,81,73,.1);color:var(--red)}
.sinp{width:100%;padding:10px 13px;background:var(--s2);border:1.5px solid var(--border);border-radius:11px;font-size:13px;font-family:'Nunito',sans-serif;color:var(--text);outline:none;margin-bottom:10px}
.sinp:focus{border-color:var(--blue)}
.sinp::placeholder{color:var(--muted)}
.toast{position:fixed;bottom:76px;left:50%;transform:translateX(-50%);background:var(--s1);border:1px solid var(--border);border-radius:20px;padding:9px 18px;font-size:12px;font-weight:700;z-index:500;white-space:nowrap;animation:tIn .3s ease,tOut .3s 2.2s forwards;box-shadow:0 8px 24px rgba(0,0,0,.5);}
@keyframes tIn{from{opacity:0;transform:translateX(-50%) translateY(8px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
@keyframes tOut{to{opacity:0}}
.xp-pop{position:fixed;top:70px;right:14px;z-index:400;background:var(--gold);color:#080d14;padding:7px 14px;border-radius:20px;font-weight:800;font-size:13px;animation:xpIn .6s cubic-bezier(.34,1.56,.64,1) both,tOut .4s 1.6s forwards;pointer-events:none;}
@keyframes xpIn{from{opacity:0;transform:translateY(16px) scale(.7)}to{opacity:1;transform:translateY(0) scale(1)}}
/* BATTLE MATCHMAKING */
.match-status{text-align:center;padding:20px;background:rgba(124,90,246,.06);border:1px solid rgba(124,90,246,.2);border-radius:16px;margin-bottom:14px}
.match-spinner{font-size:40px;animation:spin 1s linear infinite;display:block;margin-bottom:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.battle-mode-btn{padding:12px;background:var(--s2);border:1.5px solid var(--border);border-radius:12px;font-size:13px;font-weight:700;font-family:'Nunito',sans-serif;color:var(--text);cursor:pointer;transition:all .2s;width:100%;margin-bottom:8px;text-align:left;display:flex;align-items:center;gap:10px}
.battle-mode-btn:hover{border-color:var(--orange)}
.battle-mode-btn .bm-icon{font-size:22px}
</style>
</head>
<body>

<script>
// ============================================================
// SO'ZLAR BAZASI (inline fallback)
// ============================================================
const WORDS_DB = {
  beginner: {
    unit_1: [
      {word:"afraid",translation:"qo'rqqan",definition:"feeling fear",example:"The woman was afraid.",part_of_speech:"adjective"},
      {word:"angry",translation:"g'azablangan",definition:"feeling strong annoyance",example:"He was angry about the delay.",part_of_speech:"adjective"},
      {word:"beautiful",translation:"go'zal",definition:"pleasing to the senses",example:"She wore a beautiful dress.",part_of_speech:"adjective"},
      {word:"calm",translation:"tinch",definition:"not showing nervousness",example:"He remained calm.",part_of_speech:"adjective"},
      {word:"happy",translation:"xursand",definition:"feeling pleasure",example:"I am happy to help you.",part_of_speech:"adjective"},
      {word:"kind",translation:"mehribon",definition:"friendly nature",example:"He was kind to strangers.",part_of_speech:"adjective"},
      {word:"strong",translation:"kuchli",definition:"great physical power",example:"She is very strong.",part_of_speech:"adjective"},
      {word:"quiet",translation:"jim, sokin",definition:"making little noise",example:"Be quiet in the library.",part_of_speech:"adjective"},
    ],
    unit_2: [
      {word:"achieve",translation:"erishmoq",definition:"successfully bring about",example:"You can achieve your goals.",part_of_speech:"verb"},
      {word:"believe",translation:"ishonmoq",definition:"accept as true",example:"I believe in you.",part_of_speech:"verb"},
      {word:"create",translation:"yaratmoq",definition:"bring into existence",example:"She loves to create art.",part_of_speech:"verb"},
      {word:"decide",translation:"qaror qilmoq",definition:"come to a resolution",example:"He decided to leave.",part_of_speech:"verb"},
      {word:"explore",translation:"kashf etmoq",definition:"investigate and discover",example:"Let's explore the city.",part_of_speech:"verb"},
      {word:"forget",translation:"unutmoq",definition:"fail to remember",example:"Don't forget to call me.",part_of_speech:"verb"},
      {word:"help",translation:"yordam bermoq",definition:"make easier for someone",example:"Can you help me?",part_of_speech:"verb"},
      {word:"imagine",translation:"tasavvur qilmoq",definition:"form a mental image",example:"Imagine a perfect world.",part_of_speech:"verb"},
    ],
    unit_3: [
      {word:"freedom",translation:"ozodlik",definition:"power to act as one wants",example:"Freedom is important.",part_of_speech:"noun"},
      {word:"knowledge",translation:"bilim",definition:"facts and skills acquired",example:"Knowledge is power.",part_of_speech:"noun"},
      {word:"success",translation:"muvaffaqiyat",definition:"achievement of aim",example:"Hard work leads to success.",part_of_speech:"noun"},
      {word:"challenge",translation:"qiyinchilik",definition:"a difficult task",example:"Every challenge makes us stronger.",part_of_speech:"noun"},
      {word:"family",translation:"oila",definition:"a group of related people",example:"My family is supportive.",part_of_speech:"noun"},
      {word:"friend",translation:"do'st",definition:"a person you like and trust",example:"She is my best friend.",part_of_speech:"noun"},
      {word:"journey",translation:"sayohat",definition:"an act of traveling",example:"Life is a journey.",part_of_speech:"noun"},
      {word:"music",translation:"musiqa",definition:"vocal or instrumental sound",example:"I love music.",part_of_speech:"noun"},
    ],
    unit_4: [
      {word:"ability",translation:"qobiliyat",definition:"capacity to do something",example:"She has great ability.",part_of_speech:"noun"},
      {word:"adventure",translation:"sarguzasht",definition:"an exciting experience",example:"Life is an adventure.",part_of_speech:"noun"},
      {word:"clever",translation:"aqlli",definition:"quick to understand",example:"He is a clever student.",part_of_speech:"adjective"},
      {word:"dangerous",translation:"xavfli",definition:"able to cause harm",example:"That road is dangerous.",part_of_speech:"adjective"},
      {word:"eager",translation:"ishtiyoqmand",definition:"wanting to do very much",example:"She is eager to learn.",part_of_speech:"adjective"},
      {word:"famous",translation:"mashhur",definition:"known by many people",example:"He is a famous singer.",part_of_speech:"adjective"},
      {word:"grateful",translation:"minnatdor",definition:"feeling thankful",example:"I am grateful for your help.",part_of_speech:"adjective"},
      {word:"honest",translation:"halol",definition:"free of deceit",example:"Always be honest.",part_of_speech:"adjective"},
    ],
    unit_5: [
      {word:"improve",translation:"yaxshilamoq",definition:"make better",example:"I want to improve my English.",part_of_speech:"verb"},
      {word:"increase",translation:"oshirmoq",definition:"make larger",example:"Prices increased last year.",part_of_speech:"verb"},
      {word:"inspire",translation:"ilhomlanmoq",definition:"fill with the urge",example:"She inspires everyone around her.",part_of_speech:"verb"},
      {word:"manage",translation:"boshqarmoq",definition:"be in charge of",example:"He manages the team well.",part_of_speech:"verb"},
      {word:"notice",translation:"payqamoq",definition:"become aware of",example:"Did you notice the change?",part_of_speech:"verb"},
      {word:"prepare",translation:"tayyorlamoq",definition:"make ready",example:"Prepare for the exam.",part_of_speech:"verb"},
      {word:"reduce",translation:"kamaytirmoq",definition:"make smaller",example:"We need to reduce waste.",part_of_speech:"verb"},
      {word:"support",translation:"qo'llab-quvvatlamoq",definition:"bear all or part of",example:"Please support me.",part_of_speech:"verb"},
    ],
  },
  intermediate: {
    unit_1: [
      {word:"ambiguous",translation:"noaniq, ikki ma'noli",definition:"open to more than one interpretation",example:"The instructions were ambiguous.",part_of_speech:"adjective"},
      {word:"competent",translation:"malakali",definition:"having the necessary ability",example:"She is a competent engineer.",part_of_speech:"adjective"},
      {word:"diligent",translation:"mehnatsevar",definition:"having care in one's work",example:"He is a diligent student.",part_of_speech:"adjective"},
      {word:"eloquent",translation:"notiq, chechan",definition:"fluent or persuasive",example:"She gave an eloquent speech.",part_of_speech:"adjective"},
      {word:"flexible",translation:"moslashuvchan",definition:"able to change easily",example:"We need a flexible approach.",part_of_speech:"adjective"},
      {word:"genuine",translation:"haqiqiy",definition:"truly what it's said to be",example:"This is a genuine concern.",part_of_speech:"adjective"},
      {word:"innovative",translation:"yangilikchi",definition:"featuring new ideas",example:"They used an innovative method.",part_of_speech:"adjective"},
      {word:"persistent",translation:"qat'iyatli",definition:"continuing despite difficulty",example:"Be persistent in your efforts.",part_of_speech:"adjective"},
    ],
    unit_2: [
      {word:"accomplish",translation:"amalga oshirmoq",definition:"achieve or complete successfully",example:"She accomplished her mission.",part_of_speech:"verb"},
      {word:"analyze",translation:"tahlil qilmoq",definition:"examine in detail",example:"Let's analyze the data.",part_of_speech:"verb"},
      {word:"collaborate",translation:"hamkorlik qilmoq",definition:"work jointly with others",example:"We need to collaborate on this.",part_of_speech:"verb"},
      {word:"demonstrate",translation:"ko'rsatmoq",definition:"show or prove clearly",example:"He demonstrated the technique.",part_of_speech:"verb"},
      {word:"evaluate",translation:"baholamoq",definition:"form an idea of the quality",example:"We need to evaluate the results.",part_of_speech:"verb"},
      {word:"negotiate",translation:"muzokaralar olib bormoq",definition:"try to reach an agreement",example:"They negotiated a better deal.",part_of_speech:"verb"},
      {word:"prioritize",translation:"ustuvorlik bermoq",definition:"designate as most important",example:"Prioritize your tasks.",part_of_speech:"verb"},
      {word:"summarize",translation:"xulosa qilmoq",definition:"give a brief statement",example:"Please summarize the article.",part_of_speech:"verb"},
    ],
    unit_3: [
      {word:"abstract",translation:"mavhum",definition:"not based on concrete things",example:"He spoke in abstract terms.",part_of_speech:"adjective"},
      {word:"crucial",translation:"hal qiluvchi",definition:"of vital importance",example:"This is a crucial decision.",part_of_speech:"adjective"},
      {word:"dynamic",translation:"dinamik",definition:"positive and full of energy",example:"She has a dynamic personality.",part_of_speech:"adjective"},
      {word:"efficient",translation:"samarali",definition:"achieving maximum productivity",example:"We need an efficient system.",part_of_speech:"adjective"},
      {word:"fundamental",translation:"asosiy",definition:"forming a necessary base",example:"Trust is fundamental.",part_of_speech:"adjective"},
      {word:"hypothesis",translation:"faraz",definition:"a proposed explanation",example:"Test your hypothesis first.",part_of_speech:"noun"},
      {word:"indicate",translation:"ko'rsatmoq",definition:"point out, show",example:"Data indicates a trend.",part_of_speech:"verb"},
      {word:"justify",translation:"asoslash",definition:"show to be right",example:"Can you justify this decision?",part_of_speech:"verb"},
    ],
  },
  advanced: {
    unit_1: [
      {word:"ubiquitous",translation:"hamma joyda mavjud",definition:"present everywhere",example:"Smartphones have become ubiquitous.",part_of_speech:"adjective"},
      {word:"pragmatic",translation:"amaliy, pragmatik",definition:"dealing with things realistically",example:"Take a pragmatic approach.",part_of_speech:"adjective"},
      {word:"meticulous",translation:"juda e'tiborli, puxta",definition:"showing great attention to detail",example:"She is meticulous in her work.",part_of_speech:"adjective"},
      {word:"resilient",translation:"bardoshli, mustahkam",definition:"able to recover quickly",example:"Children are incredibly resilient.",part_of_speech:"adjective"},
      {word:"eloquence",translation:"notiqlik",definition:"fluent or persuasive speaking",example:"His eloquence impressed everyone.",part_of_speech:"noun"},
      {word:"paradigm",translation:"namuna, paradigma",definition:"a typical example or pattern",example:"This is a new paradigm shift.",part_of_speech:"noun"},
      {word:"phenomenon",translation:"hodisa, fenomen",definition:"a fact or situation observed",example:"It was a natural phenomenon.",part_of_speech:"noun"},
      {word:"scrutinize",translation:"sinchkovlik bilan tekshirmoq",definition:"examine or inspect closely",example:"They scrutinized every detail.",part_of_speech:"verb"},
    ],
    unit_2: [
      {word:"amalgamate",translation:"birlashmoq, qo'shmoq",definition:"combine into a single unit",example:"The two companies amalgamated.",part_of_speech:"verb"},
      {word:"corroborate",translation:"tasdiqlash",definition:"confirm or give support to",example:"Evidence corroborated his story.",part_of_speech:"verb"},
      {word:"exacerbate",translation:"og'irlashtirmoq",definition:"make a problem worse",example:"Stress can exacerbate the condition.",part_of_speech:"verb"},
      {word:"impeccable",translation:"nuqsonsiz, benuqson",definition:"in accordance with the highest standards",example:"Her work is impeccable.",part_of_speech:"adjective"},
      {word:"juxtapose",translation:"yonma-yon qo'ymoq",definition:"place close together for contrast",example:"The author juxtaposes joy and sorrow.",part_of_speech:"verb"},
      {word:"mitigate",translation:"yengillashtirmoq",definition:"make less severe",example:"Steps taken to mitigate risk.",part_of_speech:"verb"},
      {word:"perpetuate",translation:"davom ettirmoq",definition:"make continue indefinitely",example:"Don't perpetuate stereotypes.",part_of_speech:"verb"},
      {word:"verbose",translation:"so'zami, ko'p so'zli",definition:"using more words than needed",example:"His writing style is verbose.",part_of_speech:"adjective"},
    ],
  },
};

// ============================================================
// GRAMMAR DATA
// ============================================================
const GRAMMAR_DATA = {
  beginner: [
    {icon:"üìå", title:"Present Simple", sub:"Oddiy hozirgi zamon",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + V(s/es)"},
        {label:"‚ùå Inkor",   f:"S + do/does + not + V"},
        {label:"‚ùì So'roq",  f:"Do/Does + S + V ?"},
      ],
      keys:["always","usually","often","sometimes","never","every day","every week","on Mondays"],
      rules:"Odatiy, takrorlanuvchan yoki doimiy harakatlar uchun.\nHe/She/It bilan fe'lga <b>-s / -es</b> qo'shiladi.\n<b>do not</b> = don't | <b>does not</b> = doesn't",
      examples:[
        "She <b>works</b> every day.",
        "They <b>don't like</b> coffee.",
        "<b>Does</b> he <b>play</b> football?",
      ],
      quiz:{q:"She ___ to school every day.",opts:["go","goes","going","gone"],ans:1}},

    {icon:"‚è≥", title:"Present Continuous", sub:"Hozir bo'layotgan harakat",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + am/is/are + V-ing"},
        {label:"‚ùå Inkor",   f:"S + am/is/are + not + V-ing"},
        {label:"‚ùì So'roq",  f:"Am/Is/Are + S + V-ing ?"},
      ],
      keys:["now","at the moment","currently","right now","today","look!","listen!"],
      rules:"Hozirda yoki ushbu vaqt atrofida bo'layotgan harakatlar uchun.\nYaqin kelajak rejalari uchun ham ishlatiladi.",
      examples:[
        "I <b>am studying</b> English now.",
        "She <b>is not working</b> today.",
        "<b>Are</b> they <b>playing</b> outside?",
      ],
      quiz:{q:"They ___ football right now.",opts:["play","plays","are playing","played"],ans:2}},

    {icon:"üìö", title:"Past Simple", sub:"Tugagan o'tgan zamon",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + V2 (muntazam: V+ed)"},
        {label:"‚ùå Inkor",   f:"S + did not + V1"},
        {label:"‚ùì So'roq",  f:"Did + S + V1 ?"},
      ],
      keys:["yesterday","last week","last year","ago","in 2020","in the morning","once"],
      rules:"O'tmishda ma'lum vaqtda tugagan harakatlar uchun.\nMuntazam fe'llarga <b>-ed</b> qo'shiladi.\nNomuntazam fe'llar alohida shaklga ega.",
      examples:[
        "She <b>visited</b> London last year.",
        "He <b>didn't come</b> to the party.",
        "<b>Did</b> you <b>see</b> that movie?",
      ],
      quiz:{q:"He ___ the book last night.",opts:["read","reads","reading","readed"],ans:0}},

    {icon:"üîÅ", title:"Past Continuous", sub:"O'tmishda davom etgan harakat",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + was/were + V-ing"},
        {label:"‚ùå Inkor",   f:"S + was/were + not + V-ing"},
        {label:"‚ùì So'roq",  f:"Was/Were + S + V-ing ?"},
      ],
      keys:["while","when","at that moment","all day","at 5 o'clock yesterday"],
      rules:"O'tmishda biror vaqtda davom etayotgan harakat uchun.\nKo'pincha Past Simple bilan birgalikda ishlatiladi.\n<b>while</b> + Past Continuous | <b>when</b> + Past Simple",
      examples:[
        "I <b>was reading</b> when she called.",
        "They <b>were not sleeping</b> at midnight.",
        "<b>Was</b> he <b>working</b> at 9pm?",
      ],
      quiz:{q:"She ___ TV when I arrived.",opts:["watched","watches","was watching","is watching"],ans:2}},

    {icon:"üîÆ", title:"Future Simple", sub:"Kelajak zamon",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + will + V1"},
        {label:"‚ùå Inkor",   f:"S + will not (won't) + V1"},
        {label:"‚ùì So'roq",  f:"Will + S + V1 ?"},
      ],
      keys:["tomorrow","next week","next year","soon","in the future","someday"],
      rules:"Kelajakdagi qarorlar, bashoratlar va va'dalar uchun.\n<b>Going to</b> ‚Äî oldindan rejalashtirilgan harakatlar uchun.\nSpontan qarorlar uchun <b>will</b> ishlatiladi.",
      examples:[
        "I <b>will call</b> you tomorrow.",
        "She <b>won't forget</b> your birthday.",
        "<b>Will</b> you <b>help</b> me?",
      ],
      quiz:{q:"I ___ visit you next week.",opts:["am","was","will","do"],ans:2}},

    {icon:"üîÑ", title:"Present Perfect", sub:"Hozirga aloqasi bor o'tmi≈ü",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + have/has + V3"},
        {label:"‚ùå Inkor",   f:"S + have/has + not + V3"},
        {label:"‚ùì So'roq",  f:"Have/Has + S + V3 ?"},
      ],
      keys:["already","yet","ever","never","just","recently","so far","for","since"],
      rules:"O'tmishda bo'lgan, natijasi hozirga ta'sir qiluvchi harakatlar.\n<b>for</b> = muddat (for 3 years) | <b>since</b> = boshlang'ich vaqt (since 2020)\n<b>have/has + V3</b> (3-forma: done, gone, seen)",
      examples:[
        "I <b>have seen</b> that movie.",
        "She <b>hasn't finished</b> yet.",
        "<b>Have</b> you ever <b>been</b> to Japan?",
      ],
      quiz:{q:"I ___ never been to Japan.",opts:["am","have","was","had"],ans:1}},

    {icon:"‚èÆ", title:"Past Perfect", sub:"O'tmishdagi o'tmi≈ü",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + had + V3"},
        {label:"‚ùå Inkor",   f:"S + had + not + V3"},
        {label:"‚ùì So'roq",  f:"Had + S + V3 ?"},
      ],
      keys:["before","after","already","by the time","when","until"],
      rules:"O'tmishdagi ikki harakatdan biri ikkinchisidan oldin bo'lganda.\n<b>by the time</b> + Past Simple, Past Perfect\nBirinchi bo'lgan harakat = Past Perfect",
      examples:[
        "She <b>had left</b> before I arrived.",
        "He <b>hadn't eaten</b> anything all day.",
        "<b>Had</b> they <b>met</b> before the party?",
      ],
      quiz:{q:"When I arrived, she ___ already left.",opts:["has","have","had","was"],ans:2}},

    {icon:"üöÄ", title:"Future Continuous", sub:"Kelajakda davom etayotgan harakat",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + will be + V-ing"},
        {label:"‚ùå Inkor",   f:"S + will not be + V-ing"},
        {label:"‚ùì So'roq",  f:"Will + S + be + V-ing ?"},
      ],
      keys:["at this time tomorrow","at 5pm next Friday","all day tomorrow","this time next week"],
      rules:"Kelajakda ma'lum bir vaqtda davom etayotgan bo'ladigan harakat uchun.",
      examples:[
        "I <b>will be sleeping</b> at midnight.",
        "She <b>won't be working</b> tomorrow.",
        "<b>Will</b> you <b>be studying</b> at 9pm?",
      ],
      quiz:{q:"This time tomorrow I ___ on the beach.",opts:["sit","will sit","will be sitting","am sitting"],ans:2}},

    {icon:"üîÉ", title:"Present Perfect Continuous", sub:"Davom etib kelayotgan harakat",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + have/has been + V-ing"},
        {label:"‚ùå Inkor",   f:"S + have/has not been + V-ing"},
        {label:"‚ùì So'roq",  f:"Have/Has + S + been + V-ing ?"},
      ],
      keys:["for","since","how long","all day","lately","recently"],
      rules:"O'tmishda boshlangan va hozirda ham davom etayotgan harakatlar.\nNatijaga emas, <b>davomiyligiga</b> urg'u beriladi.",
      examples:[
        "I <b>have been studying</b> for 3 hours.",
        "She <b>has been waiting</b> since 9am.",
        "<b>How long have</b> you <b>been learning</b> English?",
      ],
      quiz:{q:"He ___ English for 5 years.",opts:["learns","has learned","has been learning","is learning"],ans:2}},

    {icon:"‚è≠", title:"Future Perfect", sub:"Kelajakda tugagan bo'ladigan harakat",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + will have + V3"},
        {label:"‚ùå Inkor",   f:"S + will not have + V3"},
        {label:"‚ùì So'roq",  f:"Will + S + have + V3 ?"},
      ],
      keys:["by tomorrow","by next week","by the time","by 2030","before"],
      rules:"Kelajakdagi ma'lum bir vaqtga qadar tugagan bo'ladigan harakat.\n<b>by</b> + vaqt bilan ko'p ishlatiladi.",
      examples:[
        "I <b>will have finished</b> by Monday.",
        "She <b>won't have graduated</b> by next year.",
        "<b>Will</b> you <b>have eaten</b> by 7pm?",
      ],
      quiz:{q:"By next year, she ___ her degree.",opts:["finishes","will finish","will have finished","has finished"],ans:2}},
  ],

  intermediate: [
    {icon:"üîÄ", title:"Zero Conditional", sub:"Har doim to'g'ri bo'lgan holatlar",
      formulas:[{label:"Formula", f:"If + Present Simple, Present Simple"}],
      keys:["if","when","always","generally"],
      rules:"Ilmiy haqiqatlar, tabiat qonunlari va umumiy haqiqatlar uchun.\n<b>if = when</b> ma'nosida ishlatiladi.",
      examples:[
        "If you <b>heat</b> water to 100¬∞C, it <b>boils</b>.",
        "If it <b>rains</b>, the ground <b>gets</b> wet.",
      ],
      quiz:{q:"If you ___ water, it evaporates.",opts:["heat","heated","will heat","heating"],ans:0}},

    {icon:"1Ô∏è‚É£", title:"First Conditional", sub:"Mumkin bo'lgan kelajak",
      formulas:[{label:"Formula", f:"If + Present Simple, will + V1"}],
      keys:["if","unless","as long as","provided that","in case"],
      rules:"Haqiqiy va mumkin bo'lgan kelajak shartlar uchun.\n<b>unless</b> = if ... not ma'nosida",
      examples:[
        "If it <b>rains</b>, I <b>will stay</b> home.",
        "Unless you <b>study</b>, you <b>won't pass</b>.",
      ],
      quiz:{q:"If she ___ hard, she will succeed.",opts:["work","works","worked","will work"],ans:1}},

    {icon:"2Ô∏è‚É£", title:"Second Conditional", sub:"Xayoliy / mumkin bo'lmagan hozirgi",
      formulas:[{label:"Formula", f:"If + Past Simple, would + V1"}],
      keys:["if","would","could","might","imagine","suppose"],
      rules:"Hozirda haqiqiy bo'lmagan yoki kam ehtimollik holatlar uchun.\n<b>If I were you</b> ‚Äî maslahat berishda ishlatiladi.",
      examples:[
        "If I <b>had</b> money, I <b>would travel</b>.",
        "If I <b>were</b> you, I <b>would apologize</b>.",
      ],
      quiz:{q:"If he ___ harder, he would pass.",opts:["studies","studied","will study","study"],ans:1}},

    {icon:"3Ô∏è‚É£", title:"Third Conditional", sub:"O'tmishga afsus",
      formulas:[{label:"Formula", f:"If + Past Perfect, would have + V3"}],
      keys:["if","would have","could have","might have"],
      rules:"O'tmishda bo'lmagan yoki o'zgartirish mumkin bo'lmagan holatlar.\nAfsus va tanqid ifodalashda ishlatiladi.",
      examples:[
        "If I <b>had studied</b>, I <b>would have passed</b>.",
        "She <b>would have come</b> if you <b>had invited</b> her.",
      ],
      quiz:{q:"If they ___ harder, they would have won.",opts:["try","tried","had tried","have tried"],ans:2}},

    {icon:"üéõ", title:"Modal Verbs ‚Äî Imkoniyat", sub:"Can, Could, Be able to",
      formulas:[
        {label:"can",       f:"S + can + V1 (hozirgi)"},
        {label:"could",     f:"S + could + V1 (o'tmi≈ü / vaqtincha)"},
        {label:"be able to",f:"S + am/is/are able to + V1"},
      ],
      keys:["can","could","be able to","manage to"],
      rules:"<b>can</b> ‚Äî hozirgi qobiliyat\n<b>could</b> ‚Äî o'tmi≈ü qobiliyat yoki muloyim so'rov\n<b>be able to</b> ‚Äî barcha zamonlarda ishlatiladi",
      examples:[
        "She <b>can</b> speak 3 languages.",
        "He <b>could</b> swim when he was 5.",
        "I <b>was able to</b> finish on time.",
      ],
      quiz:{q:"___ you help me, please?",opts:["Can","Could","Would","All of these"],ans:3}},

    {icon:"‚ö†Ô∏è", title:"Modal Verbs ‚Äî Majburiyat", sub:"Must, Have to, Should, Ought to",
      formulas:[
        {label:"must",   f:"S + must + V1 (ichki majburiyat)"},
        {label:"have to",f:"S + have to + V1 (tashqi majburiyat)"},
        {label:"should", f:"S + should + V1 (maslahat)"},
      ],
      keys:["must","have to","should","ought to","need to","had better"],
      rules:"<b>must</b> ‚Äî shaxsiy majburiyat / qat'iy talab\n<b>have to</b> ‚Äî qoida, qonun yoki tashqi majburiyat\n<b>should</b> ‚Äî maslahat, tavsiya",
      examples:[
        "You <b>must</b> stop at red lights.",
        "I <b>have to</b> finish this report.",
        "You <b>should</b> sleep early.",
      ],
      quiz:{q:"You ___ wear a seatbelt. It's the law.",opts:["should","can","must","might"],ans:2}},

    {icon:"ü§î", title:"Modal Verbs ‚Äî Ehtimollik", sub:"May, Might, Must, Can't",
      formulas:[
        {label:"must",  f:"S + must + V1 (95% ishonch)"},
        {label:"may",   f:"S + may + V1 (50% ehtimol)"},
        {label:"might", f:"S + might + V1 (30% ehtimol)"},
        {label:"can't", f:"S + can't + V1 (imkonsiz)"},
      ],
      keys:["must","may","might","could","can't","probably","perhaps"],
      rules:"<b>must</b> ‚Äî mantiqiy xulosa\n<b>may/might</b> ‚Äî noaniqlik, ehtimollik\n<b>can't</b> ‚Äî mantiqiy inkor",
      examples:[
        "She <b>must be</b> tired.",
        "It <b>might rain</b> tomorrow.",
        "He <b>can't be</b> home ‚Äî I saw him leave.",
      ],
      quiz:{q:"He knows every answer. He ___ be very smart.",opts:["might","can't","must","may"],ans:2}},

    {icon:"üîÑ", title:"Passive Voice ‚Äî Present & Past", sub:"Ish kimga bajariladi",
      formulas:[
        {label:"Present Simple", f:"S + am/is/are + V3"},
        {label:"Past Simple",    f:"S + was/were + V3"},
        {label:"Present Perfect",f:"S + have/has been + V3"},
        {label:"Future",         f:"S + will be + V3"},
      ],
      keys:["by","is made","was built","has been found","will be sent"],
      rules:"Harakat bajaruvchi emas, harakatni qabul qiluvchi muhim bo'lganda.\nAgent (bajaruvchi) <b>by</b> bilan beriladi yoki tushirib qoldiriladi.",
      examples:[
        "English <b>is spoken</b> worldwide.",
        "The letter <b>was written</b> by him.",
        "The project <b>has been completed</b>.",
      ],
      quiz:{q:"The cake ___ by my mother yesterday.",opts:["made","is made","was made","has made"],ans:2}},

    {icon:"üîÄ", title:"Passive Voice ‚Äî Modal & Perfect", sub:"Modal va Perfect passive",
      formulas:[
        {label:"Modal Passive",       f:"S + modal + be + V3"},
        {label:"Past Perfect Passive",f:"S + had been + V3"},
        {label:"Future Perfect",      f:"S + will have been + V3"},
      ],
      keys:["must be done","should be fixed","had been told","will have been completed"],
      rules:"Modal fe'llar bilan passive: <b>modal + be + V3</b>\nPast Perfect passive: <b>had been + V3</b>",
      examples:[
        "This <b>must be done</b> today.",
        "He <b>should be told</b> the truth.",
        "The report <b>had been submitted</b> before the deadline.",
      ],
      quiz:{q:"The problem ___ before I arrived.",opts:["solved","has been solved","had been solved","was solve"],ans:2}},
  ],

  advanced: [
    {icon:"üîÉ", title:"Inversion", sub:"Inversiya ‚Äî so'z tartibini o'zgartirish",
      formulas:[
        {label:"Negative adverb", f:"Never/Rarely/Seldom + aux + S + V"},
        {label:"Only",            f:"Only + adv/clause + aux + S + V"},
        {label:"Not until",       f:"Not until + time + aux + S + V"},
        {label:"So/Such",         f:"So + adj + aux + S + that..."},
      ],
      keys:["never","rarely","seldom","hardly","barely","not only","only when","only after","so...that","such...that","not until","little did"],
      rules:"Inversiya ikki sabab uchun ishlatiladi:\n1. <b>Urg'u</b> berish (ta'kidlash)\n2. <b>Rasmiy/adabiy</b> uslub\nOdatda salbiy yoki cheklovchi ravishlar jumlani boshlaganda qo'llanadi.",
      examples:[
        "<b>Never have I seen</b> such beauty.",
        "<b>Rarely does he</b> make mistakes.",
        "<b>Not only did she</b> win, but she broke the record.",
        "<b>Only after</b> he left <b>did</b> I realize the truth.",
        "<b>So tired was</b> she that she fell asleep immediately.",
      ],
      quiz:{q:"___ have I seen such a beautiful sunset.",opts:["Rarely","Rare","Rarely I","Rarely I have"],ans:0}},

    {icon:"‚úÇÔ∏è", title:"Cleft Sentences", sub:"It is/was ... that ‚Äî ta'kidlash",
      formulas:[
        {label:"It-cleft",  f:"It + is/was + [ta'kidlanadigan qism] + that/who + ..."},
        {label:"Wh-cleft",  f:"What + S + V + is/was + [ta'kidlanadigan qism]"},
      ],
      keys:["it is","it was","what I need","what matters","what happened"],
      rules:"Jumlaning biror qismini ta'kidlash uchun ishlatiladi.\n<b>It-cleft</b> ‚Äî aniq elementni ajratib ko'rsatadi\n<b>Wh-cleft</b> ‚Äî gap boshida 'what' bilan keladi",
      examples:[
        "<b>It was John who</b> broke the window.",
        "<b>It is hard work that</b> leads to success.",
        "<b>What I need</b> is a good rest.",
        "<b>What surprised me</b> was her reaction.",
      ],
      quiz:{q:"___ John who called you last night.",opts:["It was","It is","What was","That was"],ans:0}},

    {icon:"üîÄ", title:"Mixed Conditionals", sub:"Aralash shartli gaplar",
      formulas:[
        {label:"Past ‚Üí Present", f:"If + Past Perfect, would + V1"},
        {label:"Present ‚Üí Past", f:"If + Past Simple, would have + V3"},
      ],
      keys:["if","would","would have","could","might"],
      rules:"<b>Type 1 (Past‚ÜíPresent):</b> O'tmishdagi harakat hozirgi holatga ta'sir qiladi.\n<b>Type 2 (Present‚ÜíPast):</b> Hozirgi holat o'tmishdagi narsaga ta'sir qilganda.",
      examples:[
        "If I <b>had studied</b> medicine, I <b>would be</b> a doctor now.",
        "If she <b>weren't</b> so shy, she <b>would have spoken</b> up.",
      ],
      quiz:{q:"If he had taken that job, he ___ rich now.",opts:["would be","would have been","will be","had been"],ans:0}},

    {icon:"üé≠", title:"Subjunctive Mood", sub:"Istak va taklif ifodasi",
      formulas:[
        {label:"Present Subjunctive", f:"S + suggest/recommend + that + S + V1 (bare)"},
        {label:"Were-subjunctive",    f:"If I/he/she + were... (xayoliy)"},
      ],
      keys:["suggest","recommend","insist","demand","require","propose","wish","if I were"],
      rules:"<b>Present Subjunctive:</b> Tavsiya, talab, taklif gaplarida\nFe'l barcha shaxslarda <b>V1 (base form)</b> bo'ladi\n<b>Were-subjunctive:</b> Xayoliy holatlarda 'was' o'rniga 'were' ishlatiladi",
      examples:[
        "I suggest that he <b>be</b> more careful.",
        "She insisted that he <b>leave</b> immediately.",
        "If I <b>were</b> the president, I would change things.",
      ],
      quiz:{q:"The doctor recommended that she ___ more rest.",opts:["gets","get","got","is getting"],ans:1}},

    {icon:"üí¨", title:"Emphatic Structures", sub:"Ta'kidlash strukturalari",
      formulas:[
        {label:"Do/Does/Did emphasis", f:"S + do/does/did + V1 (ta'kid)"},
        {label:"As much/many as",      f:"as much/many as + son/miqdor"},
        {label:"Such...that",          f:"such + (a/an) + adj + noun + that"},
        {label:"So...that",            f:"so + adj/adv + that"},
      ],
      keys:["do","does","did","such","so...that","as much as","as many as","even","indeed","absolutely"],
      rules:"<b>Do/does/did</b> ta'kid uchun: 'I <b>do</b> like it!'\n<b>As much as</b>: 'It costs <b>as much as</b> $500'\n<b>Such...that / So...that</b>: natijani ta'kidlash",
      examples:[
        "I <b>do</b> understand your point.",
        "She <b>did</b> warn us about the danger.",
        "He ate <b>as much as</b> three portions.",
        "It was <b>such a</b> good film <b>that</b> I watched it twice.",
        "She ran <b>so fast that</b> nobody could catch her.",
      ],
      quiz:{q:"I ___ tell you this would happen!",opts:["do","did","does","have"],ans:1}},

    {icon:"üèó", title:"Advanced Complex Structures", sub:"Murakkab grammatik strukturalar",
      formulas:[
        {label:"Reduced relative clause", f:"N + V-ing/V3 (who/which + verb o'rniga)"},
        {label:"Participle clause",       f:"V-ing/Having + V3, S + V"},
        {label:"Nominalization",          f:"V ‚Üí Noun (decide ‚Üí decision)"},
        {label:"Fronting",                f:"[Object/Adverb] + S + V (ta'kid)"},
      ],
      keys:["having done","being","given","considering","provided","assuming","regarding","concerning"],
      rules:"<b>Reduced relative:</b> 'the man <b>sitting</b> there' = the man who is sitting\n<b>Participle clause:</b> ikkita harakatni qisqartirish\n<b>Fronting:</b> ob'ektni oldiniga qo'yish ‚Äî ta'kid",
      examples:[
        "The man <b>standing</b> there is my boss.",
        "<b>Having finished</b> his work, he went home.",
        "<b>Tired as she was</b>, she kept working.",
        "<b>This I cannot accept.</b> (fronting)",
        "<b>Given the circumstances</b>, we did well.",
      ],
      quiz:{q:"___ his homework, he went out to play.",opts:["Finish","Finished","Having finished","He finished"],ans:2}},

    {icon:"üìê", title:"Relative Clauses", sub:"Aniqlovchi va tavsiflovchi gaplar",
      formulas:[
        {label:"Defining",       f:"N + who/which/that + V (vergulsiz)"},
        {label:"Non-defining",   f:"N + , who/which , + V (vergul bilan)"},
        {label:"Preposition",    f:"N + prep + which/whom + V"},
      ],
      keys:["who","which","that","whose","whom","where","when"],
      rules:"<b>Defining:</b> Narsani aniqlaydi ‚Äî bo'lmasa ma'no o'zgaradi (vergulsiz)\n<b>Non-defining:</b> Qo'shimcha ma'lumot ‚Äî bo'lmasa ham bo'ladi (vergul bilan)\n<b>that</b> = non-defining gaplarda ishlatilmaydi",
      examples:[
        "The man <b>who called</b> is my uncle. (defining)",
        "My brother, <b>who lives in London</b>, is a doctor. (non-defining)",
        "The book <b>about which</b> I told you is amazing.",
      ],
      quiz:{q:"The city ___ I was born is very beautiful.",opts:["which","that","where","who"],ans:2}},
  ],
};

// ===== USER STATE =====
let U = JSON.parse(sessionStorage.getItem('ep_user') || 'null');
if(!U){ window.location.href='register.html'; }

let cardIdx=0, cardFlipped=false;
let currentUnitWords=[];

// ===== LEADERBOARD DATA =====
const FAKE_LB=[
  {name:"Nodira",xp:3420,av:"üò∫"},
  {name:"Jasur",xp:2980,av:"ü¶ä"},
  {name:"Malika",xp:2450,av:"üê∏"},
  {name:"Akbar",xp:1890,av:"ü§ñ"},
  {name:"Zulfiya",xp:1420,av:"üê±"},
];

// ===== ONLINE PLAYERS (fake) =====
const ONLINE_PLAYERS = [
  {name:"Sherzod",av:"üêØ",xp:1200},
  {name:"Nilufar",av:"ü¶ã",xp:980},
  {name:"Bobur",av:"ü¶Å",xp:1540},
  {name:"Sarvar",av:"üê∫",xp:760},
  {name:"Gulnora",av:"üå∏",xp:1890},
];
</script>

<div id="app">
  <!-- TOPBAR -->
  <div>
    <div class="topbar">
      <div class="tb-row">
        <div class="tb-av" id="tb-av">ü§ñ</div>
        <div class="tb-info">
          <div class="tb-name" id="tb-name">‚Äî</div>
          <div class="tb-sub">
            <span class="badge" id="tb-badge">‚Äî</span>
            <span id="tb-xp">0 XP</span>
          </div>
        </div>
        <div class="tb-right">
          <div class="streak">üî• <span id="tb-streak">1</span></div>
        </div>
      </div>
    </div>
    <div class="prog-bar-wrap">
      <div class="prog-labels">
        <span>O'rganilgan so'zlar</span>
        <span id="prog-val">0 / 0</span>
      </div>
      <div class="prog-track"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
    </div>
  </div>

  <!-- PAGES -->
  <div class="tab-pages scroll-area">

    <!-- HOME -->
    <div id="tab-home" class="active">

      <!-- BOOK & UNIT SELECTOR -->
      <div class="sec">
        <div class="sec-hd">
          <div class="sec-title">üìö So'zlar</div>
          <div class="sec-link" onclick="openModal('modal-words')">Barchasi ‚Üí</div>
        </div>

        <!-- BOOK TABS -->
        <div style="margin-bottom:10px">
          <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:7px">KITOB TANLANG</div>
          <div class="unit-row" id="book-row"></div>
        </div>

        <!-- UNIT INPUT -->
        <div style="margin-bottom:12px">
          <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:7px">UNIT RAQAMI (<span id="unit-range">1‚Äì30</span>)</div>
          <div style="display:flex;gap:8px;align-items:center">
            <div style="display:flex;align-items:center;gap:6px;flex:1;background:var(--s2);border:1.5px solid var(--border);border-radius:12px;padding:8px 12px">
              <span style="font-size:16px">üìñ</span>
              <input type="number" id="unit-inp" min="1" max="30" value="1"
                style="flex:1;background:transparent;border:none;outline:none;font-size:16px;font-weight:800;font-family:'Syne',sans-serif;color:var(--text);width:60px"
                oninput="previewUnit(this.value)">
              <span style="font-size:12px;color:var(--muted);font-weight:700">- unit</span>
            </div>
            <button onclick="goToUnit()" style="padding:10px 18px;background:linear-gradient(135deg,var(--accent),#5b3fd4);border:none;border-radius:12px;color:white;font-size:13px;font-weight:800;font-family:'Nunito',sans-serif;cursor:pointer;box-shadow:0 4px 12px rgba(124,90,246,.3)">
              O'tish ‚Üí
            </button>
          </div>
          <div id="unit-quick" style="display:flex;gap:5px;flex-wrap:wrap;margin-top:8px"></div>
        </div>

        <!-- CURRENT SELECTION INFO -->
        <div id="sel-info" style="background:rgba(124,90,246,.08);border:1px solid rgba(124,90,246,.2);border-radius:12px;padding:10px 14px;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-size:12px;font-weight:800;color:var(--al)" id="sel-title">Kitob 1 ¬∑ Unit 1</div>
            <div style="font-size:11px;color:var(--muted);margin-top:2px" id="sel-sub">0 ta so'z</div>
          </div>
          <div style="font-size:11px;color:var(--green);font-weight:700" id="sel-done"></div>
        </div>

        <!-- FLASHCARD -->
        <div class="fc-outer">
          <div class="fc" id="fc" onclick="flipCard()">
            <div class="fc-face">
              <div class="fc-pos" id="fc-pos">‚Äî</div>
              <div class="fc-utag" id="fc-utag">‚Äî</div>
              <div class="fc-word" id="fc-word">‚Äî</div>
              <div class="fc-hint">üëÜ Bosib tarjimani ko'ring</div>
            </div>
            <div class="fc-face fc-back">
              <div class="fc-pos" id="fc-pos2">‚Äî</div>
              <div class="fc-trans" id="fc-trans">‚Äî</div>
              <div class="fc-def" id="fc-def">‚Äî</div>
              <div class="fc-eg" id="fc-eg">‚Äî</div>
            </div>
          </div>
        </div>
        <div class="fc-ctrl">
          <div class="fc-nav">
            <div class="fc-btn" onclick="prevCard()">‚Äπ</div>
            <span class="fc-count" id="fc-count">1 / 8</span>
            <div class="fc-btn" onclick="nextCard()">‚Ä∫</div>
          </div>
          <div class="audio-btn" onclick="speakWord()">üîä Eshitish</div>
        </div>
      </div>

      <!-- GAMES -->
      <div class="sec">
        <div class="sec-hd">
          <div class="sec-title">üéÆ O'yinlar</div>
          <div style="font-size:11px;color:var(--muted);font-weight:700" id="game-unit-label"></div>
        </div>
        <div class="games-grid">
          <div class="game-card" onclick="openModal('modal-match')">
            <div class="g-icon">üîó</div>
            <div class="g-name">Word Match</div>
            <div class="g-desc">Juftlashtir</div>
          </div>
          <div class="game-card" onclick="openModal('modal-anagram')">
            <div class="g-icon">üî§</div>
            <div class="g-name">Hidden Word</div>
            <div class="g-desc">Harflarni joylashtir</div>
          </div>
          <div class="game-card" onclick="openModal('modal-quiz')">
            <div class="g-icon">‚ùì</div>
            <div class="g-name">Quiz</div>
            <div class="g-desc">To'g'risini tanlang</div>
          </div>
        </div>
      </div>

      <!-- GRAMMAR -->
      <div class="sec">
        <div class="sec-hd">
          <div class="sec-title">üìñ Grammatika</div>
          <div class="sec-link" onclick="openModal('modal-gr-levels')">Daraja ‚ñæ</div>
        </div>
        <div class="gr-list" id="gr-list"></div>
      </div>
    </div>

    <!-- PROGRESS -->
    <div id="tab-progress">
      <div class="sec">
        <div class="sec-title" style="margin-bottom:12px">üìä Statistika</div>
        <div class="stats-row">
          <div class="stat"><div class="stat-n" style="color:var(--blue)" id="st-words">0</div><div class="stat-l">So'zlar</div></div>
          <div class="stat"><div class="stat-n" style="color:var(--gold)" id="st-streak">1</div><div class="stat-l">Streaküî•</div></div>
          <div class="stat"><div class="stat-n" style="color:var(--al)" id="st-xp">0</div><div class="stat-l">XP ball</div></div>
        </div>
      </div>
      <div class="sec">
        <div class="sec-hd"><div class="sec-title">üèÜ Reyting</div></div>
        <div class="lb-list" id="lb-main"></div>
      </div>
      <div class="sec">
        <div class="sec-hd">
          <div class="sec-title">üìù O'rganilgan so'zlar</div>
          <div class="sec-link" onclick="openModal('modal-words')">Barchasi</div>
        </div>
        <div id="recent-wl"></div>
      </div>
    </div>

    <!-- BATTLE -->
    <div id="tab-battle">
      <div class="sec">
        <div class="battle-hero">
          <div class="bh-vs">1 vs 1</div>
          <div class="bh-players">
            <div class="bh-player">
              <div class="bh-av" id="bh-me-av">ü§ñ</div>
              <div class="bh-pname" id="bh-me-name">Siz</div>
              <div class="bh-score" id="bh-me-s">0</div>
            </div>
            <div style="font-size:28px">‚öîÔ∏è</div>
            <div class="bh-player">
              <div class="bh-av" id="bh-opp-av">ü§ñ</div>
              <div class="bh-pname" id="bh-opp-name">Raqib</div>
              <div class="bh-score" id="bh-opp-s">0</div>
            </div>
          </div>
        </div>
        <button class="btn-p" onclick="findOpponent()">üéØ Raqib topish</button>
        <button class="btn-s" onclick="startBotBattle()">ü§ñ Robot bilan o'ynash</button>
        <button class="btn-s" onclick="openModal('modal-lb')">üèÜ Global reyting</button>
        <div class="sec-title" style="margin:14px 0 10px">üèÖ Natijalarim</div>
        <div class="stats-row">
          <div class="stat"><div class="stat-n" style="color:var(--green)" id="bw">0</div><div class="stat-l">G'alaba</div></div>
          <div class="stat"><div class="stat-n" style="color:var(--red)" id="bl">0</div><div class="stat-l">Mag'lubiyat</div></div>
          <div class="stat"><div class="stat-n" style="color:var(--gold)" id="bxp">0</div><div class="stat-l">XP</div></div>
        </div>
      </div>
    </div>

  </div>

  <!-- BOTTOM NAV -->
  <div class="bottomnav">
    <button class="nav-b active" onclick="switchTab('home',this)"><span class="nav-b-icon">üè†</span><span class="nav-b-label">Bosh</span></button>
    <button class="nav-b" onclick="switchTab('progress',this)"><span class="nav-b-icon">üìä</span><span class="nav-b-label">Progress</span></button>
    <button class="nav-b" onclick="switchTab('battle',this)"><span class="nav-b-icon">‚öîÔ∏è</span><span class="nav-b-label">1vs1</span></button>
  </div>
</div>

<!-- ==================== MODALS ==================== -->

<!-- WORDS LIST -->
<div class="overlay" id="modal-words" onclick="closeModal(event,'modal-words')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-words')">‚úï</div>
    <div class="sb">
      <div class="st">üìö So'zlar ro'yxati</div>
      <input type="text" class="sinp" placeholder="Qidirish..." oninput="filterWords(this.value)">
      <div id="wl-items"></div>
    </div>
  </div>
</div>

<!-- MATCH -->
<div class="overlay" id="modal-match" onclick="closeModal(event,'modal-match')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-match')">‚úï</div>
    <div class="sb">
      <div class="st">üîó Word Match</div>
      <div class="gsbar">
        <span>‚úÖ <span id="ms-score">0</span></span>
        <span>‚è± <span id="ms-time">30</span>s</span>
        <span>üîÑ <span id="ms-round">1</span>/5</span>
      </div>
      <div class="match-grid" id="mg"></div>
      <div id="mr" style="text-align:center;margin-top:12px;font-size:13px;color:var(--muted);min-height:18px"></div>
    </div>
  </div>
</div>

<!-- ANAGRAM / HIDDEN WORD -->
<div class="overlay" id="modal-anagram" onclick="closeModal(event,'modal-anagram')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-anagram')">‚úï</div>
    <div class="sb">
      <div class="st">üî§ Hidden Word</div>
      <div class="gsbar">
        <span>üéØ <span id="as-score">0</span></span>
        <span>‚è± <span id="as-time">60</span>s</span>
      </div>
      <div class="a-hint" id="a-hint">‚Äî</div>
      <div class="a-slots" id="a-slots"></div>
      <div class="a-letters" id="a-letters"></div>
      <div style="display:flex;gap:8px">
        <button class="btn-s" style="flex:1;margin:0" onclick="angClear()">üîÑ Tozalash</button>
        <button class="btn-p" style="flex:1;margin:0" onclick="angCheck()">‚úì Tekshirish</button>
      </div>
    </div>
  </div>
</div>

<!-- QUIZ -->
<div class="overlay" id="modal-quiz" onclick="closeModal(event,'modal-quiz')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-quiz')">‚úï</div>
    <div class="sb">
      <div class="st">‚ùì Quiz</div>
      <div class="gsbar">
        <span>‚úÖ <span id="qs-score">0</span></span>
        <span>‚ùå <span id="qs-wrong">0</span></span>
        <span>üìù <span id="qs-num">1</span>/10</span>
      </div>
      <div class="gword" id="qs-word">‚Äî</div>
      <div style="font-size:11px;color:var(--muted);font-weight:700;margin-bottom:8px">TARJIMANI TANLANG</div>
      <div class="gopts" id="qs-opts"></div>
      <div id="qs-res" style="margin-top:10px;text-align:center;font-size:13px;min-height:18px"></div>
    </div>
  </div>
</div>

<!-- GRAMMAR LEVEL SELECTOR -->
<div class="overlay" id="modal-gr-levels" onclick="closeModal(event,'modal-gr-levels')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-gr-levels')">‚úï</div>
    <div class="sb">
      <div class="st">üìñ Grammatika darajasi</div>
      <div style="display:flex;flex-direction:column;gap:9px">
        <div class="gr-item" onclick="switchGrLevel('beginner')">
          <div class="gr-ico">üå±</div>
          <div class="gr-txt"><div class="gr-title">Beginner</div><div class="gr-sub">10 ta mavzu ‚Äî barcha asosiy zamonlar</div></div>
          <span id="grl-b-check" style="color:var(--green);font-size:18px"></span>
        </div>
        <div class="gr-item" onclick="switchGrLevel('intermediate')">
          <div class="gr-ico">üî•</div>
          <div class="gr-txt"><div class="gr-title">Intermediate</div><div class="gr-sub">9 ta mavzu ‚Äî Conditionals, Modals, Passive</div></div>
          <span id="grl-i-check" style="color:var(--blue);font-size:18px"></span>
        </div>
        <div class="gr-item" onclick="switchGrLevel('advanced')">
          <div class="gr-ico">‚ö°</div>
          <div class="gr-txt"><div class="gr-title">Advanced</div><div class="gr-sub">7 ta mavzu ‚Äî Inversion, Cleft, Complex</div></div>
          <span id="grl-a-check" style="color:var(--purple);font-size:18px"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- GRAMMAR DETAIL -->
<div class="overlay" id="modal-grammar" onclick="closeModal(event,'modal-grammar')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-grammar')">‚úï</div>
    <div class="sb" id="gr-modal-body"></div>
  </div>
</div>

<!-- MATCHMAKING / FINDING OPPONENT -->
<div class="overlay" id="modal-matchmaking">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sb" style="text-align:center;padding-top:10px">
      <div class="match-status" id="mm-status">
        <span class="match-spinner" id="mm-spinner">üîç</span>
        <div style="font-size:16px;font-weight:800;margin-bottom:6px" id="mm-title">Raqib qidirilmoqda...</div>
        <div style="font-size:12px;color:var(--muted)" id="mm-sub">Online o'yinchilar qidirilmoqda</div>
      </div>
      <button class="btn-s" onclick="cancelMatchmaking()">‚úï Bekor qilish</button>
    </div>
  </div>
</div>

<!-- BATTLE GAME -->
<div class="overlay" id="modal-bg">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sb">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800">‚öîÔ∏è 1vs1 Jang</div>
        <div id="bg-opp-badge" style="font-size:11px;padding:3px 10px;border-radius:20px;background:rgba(248,81,73,.1);color:var(--red);font-weight:700"></div>
      </div>
      <div class="gsbar">
        <span>Siz: <b id="bg-my" style="color:var(--blue)">0</b></span>
        <span style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800" id="bg-time">30</span>
        <span>Raqib: <b id="bg-opp" style="color:var(--red)">0</b></span>
      </div>
      <div class="gword" id="bg-word">‚Äî</div>
      <div class="gopts" id="bg-opts"></div>
      <div id="bg-res" style="margin-top:10px;text-align:center;font-size:14px;min-height:20px"></div>
    </div>
  </div>
</div>

<!-- LEADERBOARD MODAL -->
<div class="overlay" id="modal-lb" onclick="closeModal(event,'modal-lb')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-lb')">‚úï</div>
    <div class="sb">
      <div class="st">üèÜ Global Reyting</div>
      <div class="lb-list" id="lb-modal"></div>
    </div>
  </div>
</div>

<script>
// ===== INIT =====
window.addEventListener('DOMContentLoaded', ()=>{
  if(!U){ window.location.href='register.html'; return; }
  curBook = U.lastBook || 1;
  curUnitNum = U.lastUnit || 1;
  loadTopbar();
  buildBookRow();
  buildQuickUnits();
  updateUnitRange();
  document.getElementById('unit-inp').value = curUnitNum;
  goToUnit();
  buildGrammarList();
  buildLeaderboard();
  buildBattleUI();
  updateStats();
});

function loadTopbar(){
  document.getElementById('tb-name').textContent = U.name;
  const badge = document.getElementById('tb-badge');
  badge.textContent = {beginner:'Beginner',intermediate:'Intermediate',advanced:'Advanced'}[U.level];
  badge.className = 'badge '+U.level;
  document.getElementById('tb-xp').textContent = U.xp+' XP';
  document.getElementById('tb-streak').textContent = U.streak;
  if(U.avatarUrl){
    document.getElementById('tb-av').innerHTML = `<img src="${U.avatarUrl}" style="width:80%;height:80%;object-fit:contain">`;
  }
}

// ============================================================
// BOOK & UNIT SYSTEM
// ============================================================
let curBook = 1;
let curUnitNum = 1;
const BOOK_LEVEL = {1:'beginner',2:'beginner',3:'intermediate',4:'intermediate',5:'advanced',6:'advanced'};
const BOOK_COLORS = {1:'var(--green)',2:'var(--green)',3:'var(--blue)',4:'var(--blue)',5:'var(--purple)',6:'var(--purple)'};

function getUnitWords(level, unitNum){
  return WORDS_DB[level]?.['unit_'+unitNum] || [];
}
function getAllWords(level){
  const db = WORDS_DB[level]||{};
  return Object.values(db).flat();
}
function getAllWordsForGames(){
  const level = BOOK_LEVEL[curBook] || U.level;
  return currentUnitWords.length >= 4 ? currentUnitWords : getAllWords(level);
}

function buildBookRow(){
  const row = document.getElementById('book-row');
  row.innerHTML = '';
  [1,2,3,4,5,6].forEach(b=>{
    const lv = BOOK_LEVEL[b];
    const lvLabel = {beginner:'Beg.',intermediate:'Int.',advanced:'Adv.'}[lv];
    const el = document.createElement('div');
    el.className = 'unit-pill' + (b===curBook ? ' active':'');
    el.style.borderColor = b===curBook ? BOOK_COLORS[b] : '';
    el.style.color = b===curBook ? BOOK_COLORS[b] : '';
    el.style.background = b===curBook ? `rgba(0,0,0,.3)` : '';
    el.innerHTML = `üìó Kitob ${b} <span style="font-size:9px;opacity:.7">${lvLabel}</span>`;
    el.onclick = ()=> selectBook(b);
    row.appendChild(el);
  });
}

function selectBook(b){
  curBook = b;
  curUnitNum = 1;
  document.getElementById('unit-inp').value = 1;
  buildBookRow();
  buildQuickUnits();
  updateUnitRange();
  goToUnit();
}

function updateUnitRange(){
  const level = BOOK_LEVEL[curBook];
  const db = WORDS_DB[level] || {};
  const maxUnit = Object.keys(db).length || 30;
  document.getElementById('unit-range').textContent = `1‚Äì${maxUnit}`;
  document.getElementById('unit-inp').max = maxUnit;
}

function buildQuickUnits(){
  const level = BOOK_LEVEL[curBook];
  const db = WORDS_DB[level] || {};
  const units = Object.keys(db).map(k=>parseInt(k.replace('unit_',''))).sort((a,b)=>a-b);
  const quick = document.getElementById('unit-quick');
  quick.innerHTML = '';
  units.slice(0,10).forEach(n=>{
    const el = document.createElement('div');
    el.className = 'unit-pill' + (n===curUnitNum?' active':'');
    const words = getUnitWords(level, n);
    const learned = words.filter(w=>U.learnedWords.find(x=>x.word===w.word)).length;
    const isDone = words.length > 0 && learned === words.length;
    if(isDone) el.classList.add('done');
    el.innerHTML = (isDone?'‚úì ':'') + `Unit ${n}`;
    el.onclick = ()=>{
      curUnitNum = n;
      document.getElementById('unit-inp').value = n;
      goToUnit();
    };
    quick.appendChild(el);
  });
  if(units.length > 10){
    const more = document.createElement('div');
    more.className = 'unit-pill';
    more.textContent = `+${units.length-10} ta`;
    more.style.color = 'var(--muted)';
    quick.appendChild(more);
  }
}

function previewUnit(val){
  const n = parseInt(val);
  if(!n || n<1) return;
  curUnitNum = n;
  buildQuickUnits();
}

function goToUnit(){
  const n = parseInt(document.getElementById('unit-inp').value) || 1;
  curUnitNum = n;
  const level = BOOK_LEVEL[curBook];
  currentUnitWords = getUnitWords(level, n);

  const learned = currentUnitWords.filter(w=>U.learnedWords.find(x=>x.word===w.word)).length;
  document.getElementById('sel-title').textContent = `Kitob ${curBook} ¬∑ Unit ${n}`;
  document.getElementById('sel-sub').textContent = `${currentUnitWords.length} ta so'z`;
  document.getElementById('sel-done').textContent = currentUnitWords.length > 0 ? `‚úì ${learned}/${currentUnitWords.length}` : '';
  const gl = document.getElementById('game-unit-label');
  if(gl) gl.textContent = `Kitob ${curBook} ¬∑ Unit ${n}`;
  buildQuickUnits();
  U.lastBook = curBook;
  U.lastUnit = n;

  if(!currentUnitWords.length){
    showToast(`Kitob ${curBook}, Unit ${n} hali bo'sh`);
    saveUser();
    return;
  }
  cardIdx = 0; cardFlipped = false;
  updateCard();
  saveUser();
}

// ===== FLASHCARD =====
function updateCard(){
  if(!currentUnitWords.length) return;
  const w = currentUnitWords[cardIdx];
  document.getElementById('fc').classList.remove('flipped');
  cardFlipped = false;
  document.getElementById('fc-pos').textContent = w.part_of_speech;
  document.getElementById('fc-pos2').textContent = w.part_of_speech;
  document.getElementById('fc-utag').textContent = `Kitob ${curBook} ¬∑ Unit ${curUnitNum}`;
  document.getElementById('fc-word').textContent = w.word;
  document.getElementById('fc-trans').textContent = w.translation;
  document.getElementById('fc-def').textContent = w.definition;
  document.getElementById('fc-eg').textContent = `"${w.example}"`;
  document.getElementById('fc-count').textContent = `${cardIdx+1} / ${currentUnitWords.length}`;
  updateProgress();
}
function flipCard(){
  cardFlipped = !cardFlipped;
  document.getElementById('fc').classList.toggle('flipped', cardFlipped);
  if(cardFlipped) learnWord(currentUnitWords[cardIdx]);
}
function nextCard(){ cardIdx = (cardIdx+1) % currentUnitWords.length; updateCard(); }
function prevCard(){ cardIdx = (cardIdx-1+currentUnitWords.length) % currentUnitWords.length; updateCard(); }
function speakWord(){
  const w = currentUnitWords[cardIdx];
  if(!w) return;
  if('speechSynthesis' in window){
    const u = new SpeechSynthesisUtterance(w.word);
    u.lang='en-US'; speechSynthesis.speak(u);
  }
}
function learnWord(w){
  if(!U.learnedWords.find(x=>x.word===w.word)){
    U.learnedWords.push(w);
    addXP(1);
    saveUser();
    updateStats();
  }
}

// ===== PROGRESS =====
function updateProgress(){
  const all = getAllWords(U.level);
  const n = U.learnedWords.filter(w=> all.find(x=>x.word===w.word)).length;
  const total = all.length;
  document.getElementById('prog-val').textContent = `${n} / ${total}`;
  document.getElementById('prog-fill').style.width = total ? (n/total*100)+'%' : '0%';
}
function updateStats(){
  document.getElementById('st-words').textContent = U.learnedWords.length;
  document.getElementById('st-streak').textContent = U.streak;
  document.getElementById('st-xp').textContent = U.xp;
  document.getElementById('tb-xp').textContent = U.xp+' XP';
  buildRecentWords();
  buildLeaderboard();
  updateProgress();
}
function addXP(n){
  U.xp += n;
  showXP('+'+n+' XP');
  saveUser();
  document.getElementById('tb-xp').textContent = U.xp+' XP';
}
function saveUser(){ sessionStorage.setItem('ep_user', JSON.stringify(U)); }
function showXP(txt){
  const el=document.createElement('div');el.className='xp-pop';el.textContent=txt;
  document.body.appendChild(el);setTimeout(()=>el.remove(),2100);
}
function showToast(msg){
  const t=document.createElement('div');t.className='toast';t.textContent=msg;
  document.body.appendChild(t);setTimeout(()=>t.remove(),2600);
}

// ===== GRAMMAR =====
function buildGrammarList(){
  const level = U.grammarLevel || U.level || 'beginner';
  buildGrammarListForLevel(level);
  const map={beginner:'b',intermediate:'i',advanced:'a'};
  setTimeout(()=>{
    const el = document.getElementById('grl-'+map[level]+'-check');
    if(el) el.textContent='‚úì';
  },100);
}

function switchGrLevel(level){
  ['b','i','a'].forEach(x=>{ const el=document.getElementById('grl-'+x+'-check'); if(el) el.textContent=''; });
  const map={beginner:'b',intermediate:'i',advanced:'a'};
  const el=document.getElementById('grl-'+map[level]+'-check');
  if(el) el.textContent='‚úì';
  U.grammarLevel = level;
  saveUser();
  buildGrammarListForLevel(level);
  closeModal(null,'modal-gr-levels');
  showToast({beginner:'üå± Beginner',intermediate:'üî• Intermediate',advanced:'‚ö° Advanced'}[level]+' tanlandi');
}

function buildGrammarListForLevel(level){
  const list = document.getElementById('gr-list');
  list.innerHTML='';
  const data = GRAMMAR_DATA[level] || GRAMMAR_DATA.beginner;
  const levelColors = {beginner:'var(--green)',intermediate:'var(--blue)',advanced:'var(--purple)'};
  const levelNames  = {beginner:'Beginner',intermediate:'Intermediate',advanced:'Advanced'};

  const hdr = document.createElement('div');
  hdr.style='display:flex;align-items:center;justify-content:space-between;margin-bottom:10px';
  hdr.innerHTML=`
    <span style="font-size:12px;font-weight:700;color:var(--muted)">${data.length} ta mavzu</span>
    <span style="font-size:11px;font-weight:800;padding:3px 10px;border-radius:20px;background:rgba(0,0,0,.3);color:${levelColors[level]};border:1px solid ${levelColors[level]}">${levelNames[level]}</span>
  `;
  list.appendChild(hdr);

  data.forEach((g,i)=>{
    const el=document.createElement('div');
    el.className='gr-item';
    el.innerHTML=`
      <div class="gr-ico">${g.icon}</div>
      <div class="gr-txt"><div class="gr-title">${g.title}</div><div class="gr-sub">${g.sub}</div></div>
      <span style="color:var(--muted);font-size:18px">‚Ä∫</span>`;
    el.onclick=()=>openGrammarFromLevel(level,i);
    list.appendChild(el);
  });
}

function openGrammarFromLevel(level,i){
  const data = GRAMMAR_DATA[level];
  const g = data[i];
  const formulasHtml = g.formulas.map(f=>`
    <div style="display:flex;align-items:flex-start;gap:8px;margin-bottom:6px">
      <span style="font-size:10px;font-weight:800;color:var(--muted);min-width:90px;text-transform:uppercase;letter-spacing:.04em;padding-top:7px">${f.label}</span>
      <span style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:var(--blue);flex:1">${f.f}</span>
    </div>`).join('');
  const keysHtml = g.keys.map(k=>
    `<span style="background:rgba(124,90,246,.12);border:1px solid rgba(124,90,246,.2);color:var(--al);padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700">${k}</span>`
  ).join(' ');
  document.getElementById('gr-modal-body').innerHTML=`
    <div class="st">${g.icon} ${g.title}</div>
    <div style="color:var(--muted);font-size:12px;margin-bottom:14px">${g.sub}</div>
    <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);margin-bottom:8px">üìê FORMULALAR</div>
    <div style="margin-bottom:14px">${formulasHtml}</div>
    <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);margin-bottom:8px">‚ÑπÔ∏è QOIDA</div>
    <div class="gr-rule">${g.rules.replace(/\n/g,'<br>')}</div>
    <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);margin-bottom:8px">üîë KALIT SO'ZLAR</div>
    <div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:14px">${keysHtml}</div>
    <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);margin-bottom:8px">üí¨ MISOLLAR</div>
    ${g.examples.map(e=>`<div class="gr-eg">${e}</div>`).join('')}
    <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);margin:14px 0 8px">üß™ MINI TEST</div>
    <div style="background:var(--s2);border-radius:12px;padding:12px 14px;font-size:14px;font-weight:700;margin-bottom:10px;line-height:1.5">${g.quiz.q}</div>
    <div id="gr-opts" style="display:flex;flex-direction:column;gap:7px">
      ${g.quiz.opts.map((o,idx)=>`<button class="qopt" onclick="answerGr(${idx},${g.quiz.ans},this)">${o}</button>`).join('')}
    </div>
    <div id="gr-res" style="margin-top:10px;text-align:center;font-size:13px;min-height:18px"></div>
  `;
  openModal('modal-grammar');
}

function answerGr(idx,ans,el){
  document.querySelectorAll('#gr-opts .qopt').forEach(o=>o.onclick=null);
  const res = document.getElementById('gr-res');
  if(idx===ans){
    el.classList.add('correct');
    addXP(1);
    res.innerHTML='<span style="color:var(--green)">‚úÖ To\'g\'ri! +1 XP</span>';
  } else {
    el.classList.add('wrong');
    const opts = document.querySelectorAll('#gr-opts .qopt');
    if(opts[ans]) opts[ans].classList.add('correct');
    res.innerHTML='<span style="color:var(--red)">‚ùå Noto\'g\'ri</span>';
  }
}

// ===== LEADERBOARD =====
function buildLeaderboard(){
  const myEntry = {name:U.name, xp:U.xp, isMe:true, av:U.avatarUrl||'ü§ñ'};
  let lb = [...FAKE_LB.map(x=>({...x,isMe:false})), myEntry].sort((a,b)=>b.xp-a.xp);
  ['lb-main','lb-modal'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    el.innerHTML='';
    lb.slice(0,8).forEach((p,i)=>{
      const rankColors=['#f5c542','#8b949e','#b08040'];
      const medals=['ü•á','ü•à','ü•â'];
      const av = typeof p.av==='string'&&(p.av.startsWith('http')||p.av.startsWith('data'))
        ? `<img src="${p.av}" style="width:80%;height:80%;object-fit:contain">`
        : (p.av||'ü§ñ');
      const div=document.createElement('div');
      div.className='lb-row'+(p.isMe?' me':'');
      div.innerHTML=`
        <div class="lb-rank" style="color:${rankColors[i]||'var(--muted)'}">${i<3?medals[i]:i+1}</div>
        <div class="lb-av">${av}</div>
        <div class="lb-name">${p.name}${p.isMe?' (Siz)':''}</div>
        <div class="lb-xp">${p.xp} XP</div>
      `;
      el.appendChild(div);
    });
  });
}

function buildRecentWords(){
  const el=document.getElementById('recent-wl'); if(!el) return;
  if(!U.learnedWords.length){el.innerHTML='<div style="color:var(--muted);font-size:13px">Hali so\'z o\'rganilmagan.</div>';return;}
  el.innerHTML='';
  U.learnedWords.slice(-5).reverse().forEach(w=>{
    el.innerHTML+=`<div class="wl-item"><div><div class="wl-w">${w.word}</div><div class="wl-t">${w.translation}</div></div><div class="wl-p">${w.part_of_speech}</div></div>`;
  });
}

// ===== WORD LIST MODAL =====
function filterWords(q){
  const level = BOOK_LEVEL[curBook] || U.level;
  const all = getAllWords(level);
  const items=document.getElementById('wl-items'); items.innerHTML='';
  const filtered = q ? all.filter(w=>w.word.toLowerCase().includes(q.toLowerCase())||w.translation.includes(q)) : all;
  if(!filtered.length){items.innerHTML='<div style="color:var(--muted);font-size:13px;text-align:center;padding:20px">So\'z topilmadi</div>';return;}
  filtered.forEach(w=>{
    items.innerHTML+=`<div class="wl-item"><div><div class="wl-w">${w.word}</div><div class="wl-t">${w.translation}</div></div><div class="wl-p">${w.part_of_speech}</div></div>`;
  });
}

// ===== MATCH GAME =====
let MS={sel:null,matched:0,score:0,round:1,timer:null,tval:30};
function initMatch(){
  MS={sel:null,matched:0,score:0,round:1,timer:null,tval:30};
  document.getElementById('ms-score').textContent=0;
  document.getElementById('ms-round').textContent=1;
  buildMatchRound(); startMatchTimer();
}
function buildMatchRound(){
  MS.sel=null;MS.matched=0;
  const pool=shuffle([...getAllWordsForGames()]).slice(0,4);
  if(pool.length < 4){ showToast('Kamida 4 ta so\'z kerak!'); return; }
  const grid=document.getElementById('mg'); grid.innerHTML='';
  const items=shuffle([
    ...pool.map(w=>({text:w.word,match:w.word,side:'en'})),
    ...pool.map(w=>({text:w.translation,match:w.word,side:'uz'}))
  ]);
  items.forEach(item=>{
    const el=document.createElement('div');
    el.className='mw';el.textContent=item.text;el.dataset.match=item.match;
    el.onclick=()=>selectMatch(el,item.match);
    grid.appendChild(el);
  });
  document.getElementById('mr').textContent='So\'zlarni tarjimasi bilan juftlashtiring';
}
function selectMatch(el,match){
  if(el.classList.contains('matched')) return;
  if(!MS.sel){MS.sel={el,match};el.classList.add('selected');}
  else{
    if(MS.sel.el===el){MS.sel.el.classList.remove('selected');MS.sel=null;return;}
    if(MS.sel.match===match){
      el.classList.add('matched');MS.sel.el.classList.remove('selected');MS.sel.el.classList.add('matched');
      MS.matched++;MS.score+=10;MS.sel=null;
      addXP(1);
      document.getElementById('ms-score').textContent=MS.score;
      if(MS.matched===4){
        if(MS.round<5){MS.round++;document.getElementById('ms-round').textContent=MS.round;setTimeout(buildMatchRound,600);}
        else{clearInterval(MS.timer);showToast(`üéâ ${MS.score} ball!`);}
      }
    } else {
      el.classList.add('bad');MS.sel.el.classList.add('bad');
      setTimeout(()=>{el.classList.remove('bad','selected');MS.sel.el.classList.remove('bad','selected');MS.sel=null;},700);
    }
  }
}
function startMatchTimer(){
  MS.tval=30;clearInterval(MS.timer);
  MS.timer=setInterval(()=>{
    MS.tval--;document.getElementById('ms-time').textContent=MS.tval;
    if(MS.tval<=0){clearInterval(MS.timer);document.getElementById('mr').textContent='‚è± Vaqt tugadi! '+MS.score+' ball';}
  },1000);
}

// ===== ANAGRAM / HIDDEN WORD =====
let AS={word:'',answer:[],letters:[],usedIdx:[],score:0,timer:null};
function initAnagram(){
  AS={word:'',answer:[],letters:[],usedIdx:[],score:0,timer:null};
  document.getElementById('as-score').textContent=0;
  buildAnagramRound();startAngTimer();
}
function buildAnagramRound(){
  const pool = getAllWordsForGames().filter(w=>w.word.length>=3&&w.word.length<=8);
  if(!pool.length){ showToast('So\'zlar yo\'q!'); return; }
  const w = pool[Math.floor(Math.random()*pool.length)];
  AS.word=w.word;AS.answer=[];AS.usedIdx=[];
  AS.letters=shuffle(w.word.split(''));
  document.getElementById('a-hint').textContent=w.translation;
  renderAngLetters();renderAngSlots();
}
function renderAngLetters(){
  const c=document.getElementById('a-letters');c.innerHTML='';
  AS.letters.forEach((l,i)=>{
    const el=document.createElement('div');
    el.className='a-tile'+(AS.usedIdx.includes(i)?' used':'');
    el.textContent=l;
    el.onclick=()=>{
      if(AS.usedIdx.includes(i))return;
      AS.usedIdx.push(i);AS.answer.push({char:l,idx:i});
      renderAngLetters();renderAngSlots();
    };
    c.appendChild(el);
  });
}
function renderAngSlots(){
  const c=document.getElementById('a-slots');c.innerHTML='';
  AS.word.split('').forEach((_,i)=>{
    const el=document.createElement('div');el.className='a-slot';
    if(AS.answer[i]){
      el.textContent=AS.answer[i].char;
      el.onclick=()=>{
        const rem=AS.answer.splice(i,1)[0];
        AS.usedIdx=AS.usedIdx.filter(x=>x!==rem.idx);
        renderAngLetters();renderAngSlots();
      };
    }
    c.appendChild(el);
  });
}
function angClear(){AS.answer=[];AS.usedIdx=[];renderAngLetters();renderAngSlots();}
function angCheck(){
  const ans=AS.answer.map(x=>x.char).join('');
  if(ans===AS.word){
    AS.score+=20;document.getElementById('as-score').textContent=AS.score;
    addXP(1);showToast('‚úÖ To\'g\'ri! +1 XP');
    setTimeout(buildAnagramRound,800);
  } else {showToast('‚ùå Noto\'g\'ri, qaytadan!');angClear();}
}
function startAngTimer(){
  let t=60;clearInterval(AS.timer);
  AS.timer=setInterval(()=>{
    t--;document.getElementById('as-time').textContent=t;
    if(t<=0){clearInterval(AS.timer);showToast('‚è± Vaqt tugadi!');}
  },1000);
}

// ===== QUIZ =====
let QS={idx:0,score:0,wrong:0,answered:false};
function initQuiz(){
  QS={idx:0,score:0,wrong:0,answered:false};
  document.getElementById('qs-score').textContent=0;
  document.getElementById('qs-wrong').textContent=0;
  buildQuizQ();
}
function buildQuizQ(){
  if(QS.idx>=10){
    addXP(QS.score);
    document.getElementById('qs-word').textContent='üéâ Tugadi!';
    document.getElementById('qs-opts').innerHTML=`<div style="grid-column:1/-1;text-align:center;font-weight:800;color:var(--green)">Ball: ${QS.score}/10 ¬∑ +${QS.score} XP</div>`;
    return;
  }
  QS.answered=false;
  const pool=shuffle([...getAllWordsForGames()]);
  if(pool.length < 4){ showToast('Kamida 4 ta so\'z kerak quiz uchun!'); return; }
  const correct=pool[0];
  const opts=shuffle([correct,...pool.slice(1,4)]);
  document.getElementById('qs-word').textContent=correct.word;
  document.getElementById('qs-num').textContent=`${QS.idx+1}/10`;
  document.getElementById('qs-res').textContent='';
  const c=document.getElementById('qs-opts');c.innerHTML='';
  opts.forEach(o=>{
    const el=document.createElement('div');el.className='gopt';el.textContent=o.translation;
    el.onclick=()=>{
      if(QS.answered)return;QS.answered=true;
      if(o.word===correct.word){
        el.classList.add('correct');QS.score++;
        addXP(1);
        document.getElementById('qs-score').textContent=QS.score;
        document.getElementById('qs-res').textContent='‚úÖ To\'g\'ri! +1 XP';
      } else {
        el.classList.add('wrong');QS.wrong++;
        document.getElementById('qs-wrong').textContent=QS.wrong;
        document.getElementById('qs-res').textContent='‚ùå Noto\'g\'ri';
        c.querySelectorAll('.gopt').forEach(op=>{if(op.textContent===correct.translation)op.classList.add('correct');});
      }
      setTimeout(()=>{QS.idx++;buildQuizQ();},900);
    };
    c.appendChild(el);
  });
}

// ===== BATTLE =====
let BT={timer:null,myScore:0,oppScore:0,time:30,answered:false,isBot:false,opp:null};

function buildBattleUI(){
  document.getElementById('bh-me-name').textContent = U.name;
  if(U.avatarUrl){
    document.getElementById('bh-me-av').innerHTML=`<img src="${U.avatarUrl}" style="width:80%;height:80%;object-fit:contain">`;
  }
  document.getElementById('bw').textContent=U.battleWins||0;
  document.getElementById('bl').textContent=U.battleLosses||0;
  document.getElementById('bxp').textContent=U.battleXP||0;
}

// Online raqib qidirish
let mmTimer=null;
function findOpponent(){
  openModal('modal-matchmaking');
  document.getElementById('mm-title').textContent = 'Raqib qidirilmoqda...';
  document.getElementById('mm-sub').textContent = 'Online o\'yinchilar qidirilmoqda';
  document.getElementById('mm-spinner').style.animationDuration = '1s';

  let elapsed = 0;
  mmTimer = setInterval(()=>{
    elapsed++;
    if(elapsed < 3){
      document.getElementById('mm-sub').textContent = `${elapsed * 32}% qidirildi...`;
    } else {
      clearInterval(mmTimer);
      // Tasodifiy online o'yinchi "topish" ehtimoli 60%
      const foundOnline = Math.random() < 0.6;
      if(foundOnline){
        const opp = ONLINE_PLAYERS[Math.floor(Math.random()*ONLINE_PLAYERS.length)];
        document.getElementById('mm-spinner').textContent = '‚úÖ';
        document.getElementById('mm-spinner').style.animationDuration = '0s';
        document.getElementById('mm-title').textContent = `${opp.name} topildi!`;
        document.getElementById('mm-sub').textContent = 'Jang boshlanmoqda...';
        setTimeout(()=>{
          closeModal(null,'modal-matchmaking');
          startBattleWith(opp, false);
        }, 1200);
      } else {
        // Robot bilan
        document.getElementById('mm-spinner').textContent = 'ü§ñ';
        document.getElementById('mm-spinner').style.animationDuration = '0s';
        document.getElementById('mm-title').textContent = 'Raqib topilmadi';
        document.getElementById('mm-sub').textContent = 'Robot bilan o\'ynaysiz...';
        setTimeout(()=>{
          closeModal(null,'modal-matchmaking');
          startBotBattle();
        }, 1200);
      }
    }
  }, 1000);
}

function cancelMatchmaking(){
  clearInterval(mmTimer);
  closeModal(null,'modal-matchmaking');
}

function startBotBattle(){
  const bot = {name:'AI Bot ü§ñ', av:'ü§ñ', xp: U.xp + Math.floor(Math.random()*500-250)};
  startBattleWith(bot, true);
}

function startBattleWith(opp, isBot){
  BT={timer:null,myScore:0,oppScore:0,time:30,answered:false,isBot:isBot,opp:opp};
  document.getElementById('bg-my').textContent=0;
  document.getElementById('bg-opp').textContent=0;
  document.getElementById('bg-time').textContent=30;
  document.getElementById('bh-opp-name').textContent = opp.name;
  document.getElementById('bh-opp-av').innerHTML = typeof opp.av==='string'&&(opp.av.startsWith('http')||opp.av.startsWith('data'))
    ? `<img src="${opp.av}" style="width:80%;height:80%;object-fit:contain">` : opp.av;
  document.getElementById('bg-opp-badge').textContent = isBot ? 'ü§ñ Bot' : 'üü¢ Online';

  buildBattleQ();
  openModal('modal-bg');
  clearInterval(BT.timer);
  BT.timer=setInterval(()=>{
    BT.time--;
    document.getElementById('bg-time').textContent=BT.time;
    // Raqib (bot yoki simulyatsiya) javob berishi
    if(Math.random()<(isBot?0.12:0.1)){
      BT.oppScore+=10;
      document.getElementById('bg-opp').textContent=BT.oppScore;
    }
    if(BT.time<=0){clearInterval(BT.timer);endBattle();}
  },1000);
}

function buildBattleQ(){
  BT.answered=false;
  const pool=shuffle([...getAllWordsForGames()]);
  if(pool.length < 3){showToast('Kamida 3 ta so\'z kerak!');return;}
  const correct=pool[0];
  const opts=shuffle([correct,...pool.slice(1,3)]);
  document.getElementById('bg-word').textContent=correct.word;
  document.getElementById('bg-res').textContent='';
  const c=document.getElementById('bg-opts');c.innerHTML='';
  opts.forEach(o=>{
    const el=document.createElement('div');el.className='gopt';el.textContent=o.translation;
    el.onclick=()=>{
      if(BT.answered)return;BT.answered=true;
      if(o.word===correct.word){
        el.classList.add('correct');BT.myScore+=10;
        addXP(1);
        document.getElementById('bg-my').textContent=BT.myScore;
        document.getElementById('bg-res').textContent='‚úÖ +1 XP';
      } else {
        el.classList.add('wrong');
        c.querySelectorAll('.gopt').forEach(op=>{if(op.textContent===correct.translation)op.classList.add('correct');});
        document.getElementById('bg-res').textContent='‚ùå';
      }
      setTimeout(()=>{if(BT.time>0)buildBattleQ();},700);
    };
    c.appendChild(el);
  });
}

function endBattle(){
  const won=BT.myScore>BT.oppScore;
  if(won){
    U.battleWins=(U.battleWins||0)+1;
    addXP(10); // g'alaba uchun +10 XP
    showToast('üèÜ G\'alaba! +10 XP');
  } else {
    U.battleLosses=(U.battleLosses||0)+1;
    addXP(2);
    showToast('üí™ Keyingisida yaxshiroq! +2 XP');
  }
  U.battleXP=(U.battleXP||0)+(won?10:2);
  saveUser();
  document.getElementById('bg-res').textContent=won?`üèÜ G'ALABA! ${BT.myScore}:${BT.oppScore}`:`üòû ${BT.myScore}:${BT.oppScore}`;
  document.getElementById('bg-opts').innerHTML=`<button class="btn-p" style="grid-column:1/-1" onclick="closeModal(null,'modal-bg');buildBattleUI();buildLeaderboard()">‚Üê Qaytish</button>`;
  document.getElementById('bh-me-s').textContent=BT.myScore;
  document.getElementById('bh-opp-s').textContent=BT.oppScore;
}

// ===== TABS =====
function switchTab(name,btn){
  document.querySelectorAll('.tab-pages>div').forEach(d=>d.classList.remove('active'));
  document.querySelectorAll('.nav-b').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  btn.classList.add('active');
  if(name==='progress'){buildLeaderboard();buildRecentWords();updateStats();}
  if(name==='battle'){buildBattleUI();}
}

// ===== MODALS =====
function openModal(id){
  document.getElementById(id).classList.add('open');
  if(id==='modal-match') initMatch();
  if(id==='modal-anagram') initAnagram();
  if(id==='modal-quiz') initQuiz();
  if(id==='modal-words') filterWords('');
  if(id==='modal-lb') buildLeaderboard();
}
function closeModal(e,id){
  if(e && e.target!==document.getElementById(id)) return;
  document.getElementById(id).classList.remove('open');
  if(id==='modal-match') clearInterval(MS.timer);
  if(id==='modal-anagram') clearInterval(AS.timer);
  if(id==='modal-bg') clearInterval(BT.timer);
  if(id==='modal-matchmaking') clearInterval(mmTimer);
}

// ===== UTILS =====
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
</script>
</body>
</html>
