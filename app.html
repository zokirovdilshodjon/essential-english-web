<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Essential English PRO</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d1117;--s1:#161b27;--s2:#1c2438;--s3:#232d42;
  --border:#2a3550;--text:#e8f0fe;--muted:#7a8fad;
  --accent:#7c5af6;--al:#a07cf8;
  --blue:#4f9cf9;--green:#4fdf8a;--purple:#c084fc;
  --orange:#f97b4f;--gold:#f5c542;--red:#f85149;
}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:'Nunito',sans-serif;min-height:100vh;overflow-x:hidden;
  background-image:radial-gradient(ellipse 60% 40% at 0% 0%,rgba(124,90,246,.07) 0,transparent 60%),
    radial-gradient(ellipse 50% 50% at 100% 100%,rgba(192,132,252,.06) 0,transparent 60%);}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(124,90,246,.03) 1px,transparent 1px),
    linear-gradient(90deg,rgba(124,90,246,.03) 1px,transparent 1px);background-size:32px 32px;}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
#app{display:grid;grid-template-rows:auto 1fr auto;min-height:100vh;max-width:480px;margin:0 auto;position:relative;z-index:1}
.topbar{background:rgba(13,17,23,.95);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);
  padding:10px 16px 8px;position:sticky;top:0;z-index:100;}
.tb-row{display:flex;align-items:center;gap:10px}
.tb-av{width:40px;height:40px;border-radius:50%;background:var(--s2);border:2px solid var(--accent);
  overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.tb-av img{width:80%;height:80%;object-fit:contain}
.tb-info{flex:1;min-width:0}
.tb-name{font-weight:800;font-size:14px;line-height:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tb-sub{font-size:11px;color:var(--muted);margin-top:2px;display:flex;align-items:center;gap:6px}
.badge{padding:2px 8px;border-radius:20px;font-size:10px;font-weight:800}
.badge.beginner{background:rgba(79,223,138,.15);color:var(--green)}
.badge.intermediate{background:rgba(79,156,249,.15);color:var(--blue)}
.badge.advanced{background:rgba(192,132,252,.15);color:var(--purple)}
.tb-right{display:flex;align-items:center;gap:7px}
.streak{display:flex;align-items:center;gap:4px;background:rgba(245,197,66,.1);border:1px solid rgba(245,197,66,.2);
  padding:4px 9px;border-radius:20px;font-size:12px;font-weight:800;color:var(--gold);}
.xp-chip{background:rgba(124,90,246,.1);border:1px solid rgba(124,90,246,.2);
  padding:4px 9px;border-radius:20px;font-size:12px;font-weight:800;color:var(--al);}
.prog-bar-wrap{padding:7px 16px 5px}
.prog-labels{display:flex;justify-content:space-between;font-size:10px;color:var(--muted);font-weight:700;margin-bottom:4px}
.prog-track{height:4px;background:var(--s2);border-radius:10px;overflow:hidden}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--purple));border-radius:10px;transition:width .8s cubic-bezier(.34,1.56,.64,1)}
.scroll-area{overflow-y:auto;padding:14px 16px 4px}
.sec{margin-bottom:20px}
.sec-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.sec-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:800;display:flex;align-items:center;gap:6px}
.sec-link{font-size:12px;color:var(--blue);cursor:pointer;font-weight:700}
.unit-row{display:flex;gap:6px;margin-bottom:10px;overflow-x:auto;padding-bottom:2px}
.unit-row::-webkit-scrollbar{display:none}
.unit-pill{flex-shrink:0;padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;
  background:var(--s2);border:1.5px solid var(--border);color:var(--muted);cursor:pointer;transition:all .2s;}
.unit-pill.active{background:rgba(124,90,246,.12);border-color:var(--accent);color:var(--al)}
.unit-pill.done{background:rgba(79,223,138,.08);border-color:var(--green);color:var(--green)}
.fc-outer{perspective:1200px;margin-bottom:10px}
.fc{width:100%;height:168px;cursor:pointer;
  transform-style:preserve-3d;transition:transform .5s cubic-bezier(.34,1.56,.64,1);position:relative;}
.fc.flipped{transform:rotateY(180deg)}
.fc-face{position:absolute;inset:0;background:linear-gradient(135deg,var(--s2),var(--s3));
  border:1px solid var(--border);border-radius:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:20px;backface-visibility:hidden;-webkit-backface-visibility:hidden;box-shadow:0 8px 24px rgba(0,0,0,.3);}
.fc-back{transform:rotateY(180deg)}
.fc-pos{position:absolute;top:12px;left:14px;font-size:10px;font-weight:800;text-transform:uppercase;
  letter-spacing:.08em;padding:2px 8px;border-radius:20px;background:rgba(124,90,246,.12);color:var(--al);}
.fc-utag{position:absolute;top:12px;right:14px;font-size:10px;color:var(--muted);font-weight:700}
.fc-word{font-family:'Syne',sans-serif;font-size:34px;font-weight:800;color:var(--blue);margin-bottom:4px;letter-spacing:-.01em}
.fc-hint{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:4px}
.fc-trans{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--purple);margin-bottom:4px}
.fc-def{font-size:12px;color:var(--muted);text-align:center;line-height:1.5;margin-bottom:4px}
.fc-eg{font-size:11px;color:rgba(192,132,252,.7);font-style:italic;text-align:center;line-height:1.4}
.fc-ctrl{display:flex;align-items:center;justify-content:space-between}
.fc-nav{display:flex;align-items:center;gap:8px}
.fc-btn{width:36px;height:36px;border-radius:50%;background:var(--s2);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;font-size:16px;}
.fc-btn:hover{border-color:var(--blue);background:rgba(79,156,249,.1)}
.fc-count{font-size:12px;color:var(--muted);font-weight:700;min-width:44px;text-align:center}
.audio-btn{display:flex;align-items:center;gap:5px;padding:8px 13px;
  background:rgba(79,223,138,.08);border:1px solid rgba(79,223,138,.2);
  border-radius:20px;font-size:12px;font-weight:700;color:var(--green);cursor:pointer;transition:all .2s;}
.audio-btn:hover{background:rgba(79,223,138,.15)}
.games-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.game-card{background:var(--s1);border:1px solid var(--border);border-radius:14px;
  padding:14px 10px;text-align:center;cursor:pointer;transition:all .25s;position:relative;overflow:hidden;}
.game-card::after{content:'';position:absolute;inset:0;opacity:0;transition:opacity .3s}
.game-card:nth-child(1)::after{background:radial-gradient(circle at 50% 110%,rgba(249,123,79,.18),transparent 65%)}
.game-card:nth-child(2)::after{background:radial-gradient(circle at 50% 110%,rgba(79,156,249,.18),transparent 65%)}
.game-card:nth-child(3)::after{background:radial-gradient(circle at 50% 110%,rgba(79,223,138,.18),transparent 65%)}
.game-card:hover{transform:translateY(-3px)}
.game-card:hover::after{opacity:1}
.g-icon{font-size:26px;margin-bottom:5px}
.g-name{font-size:11px;font-weight:800;line-height:1.2}
.g-desc{font-size:10px;color:var(--muted);margin-top:2px}
.gr-list{display:flex;flex-direction:column;gap:7px}
.gr-item{background:var(--s1);border:1px solid var(--border);border-radius:13px;padding:12px 14px;
  display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .2s;}
.gr-item:hover{border-color:var(--purple);background:rgba(192,132,252,.04)}
.gr-ico{width:36px;height:36px;border-radius:9px;background:rgba(192,132,252,.1);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
.gr-txt{flex:1}
.gr-title{font-size:13px;font-weight:700}
.gr-sub{font-size:11px;color:var(--muted);margin-top:1px}
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
.stat{background:var(--s1);border:1px solid var(--border);border-radius:13px;padding:13px 10px;text-align:center}
.stat-n{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:2px}
.stat-l{font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.04em}
.lb-list{display:flex;flex-direction:column;gap:5px}
.lb-row{display:flex;align-items:center;gap:9px;background:var(--s1);border:1px solid var(--border);border-radius:11px;padding:9px 13px}
.lb-row.me{border-color:var(--accent);background:rgba(124,90,246,.06)}
.lb-rank{width:22px;text-align:center;font-family:'Syne',sans-serif;font-size:13px;font-weight:800;flex-shrink:0}
.lb-av{width:32px;height:32px;border-radius:50%;background:var(--s2);overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.lb-av img{width:80%;height:80%;object-fit:contain}
.lb-name{flex:1;font-size:13px;font-weight:700}
.lb-xp{font-size:13px;font-weight:800;color:var(--gold)}
.wl-item{display:flex;align-items:center;justify-content:space-between;background:var(--s2);border-radius:10px;padding:10px 12px;margin-bottom:5px}
.wl-w{font-size:14px;font-weight:700;color:var(--blue)}
.wl-t{font-size:12px;color:var(--muted);margin-top:1px}
.wl-p{font-size:10px;padding:2px 8px;border-radius:20px;background:rgba(192,132,252,.1);color:var(--purple);font-weight:700}
.battle-hero{background:linear-gradient(135deg,rgba(249,123,79,.08),rgba(192,132,252,.06));
  border:1px solid rgba(249,123,79,.2);border-radius:18px;padding:18px;text-align:center;margin-bottom:14px;}
.bh-vs{font-family:'Syne',sans-serif;font-size:34px;font-weight:800;
  background:linear-gradient(90deg,var(--orange),var(--purple));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px}
.bh-players{display:flex;align-items:center;justify-content:center;gap:16px}
.bh-player{text-align:center}
.bh-av{width:48px;height:48px;border-radius:50%;background:var(--s2);border:2px solid var(--border);
  margin:0 auto 4px;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:20px;}
.bh-av img{width:80%;height:80%;object-fit:contain}
.bh-pname{font-size:11px;font-weight:700;color:var(--muted)}
.bh-score{font-size:22px;font-weight:800;color:var(--orange)}
.btn-p{width:100%;padding:13px;border:none;border-radius:12px;
  background:linear-gradient(135deg,var(--orange),#c75a2f);color:white;
  font-size:15px;font-weight:800;font-family:'Nunito',sans-serif;
  cursor:pointer;margin-bottom:7px;transition:transform .2s;
  box-shadow:0 6px 20px rgba(249,123,79,.25);}
.btn-p:hover{transform:translateY(-2px)}
.btn-s{width:100%;padding:12px;background:var(--s2);border:1.5px solid var(--border);
  border-radius:12px;font-size:13px;font-weight:700;font-family:'Nunito',sans-serif;
  color:var(--text);cursor:pointer;transition:all .2s;margin-bottom:7px;}
.btn-s:hover{border-color:var(--blue)}
.bottomnav{background:rgba(13,17,23,.95);backdrop-filter:blur(16px);border-top:1px solid var(--border);
  display:flex;padding:6px 4px;padding-bottom:max(6px,env(safe-area-inset-bottom));
  position:sticky;bottom:0;z-index:100;}
.nav-b{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;
  padding:5px 2px;border-radius:10px;border:none;background:transparent;
  color:var(--muted);font-family:'Nunito',sans-serif;cursor:pointer;transition:all .2s;}
.nav-b.active{color:var(--accent)}
.nav-b-icon{font-size:19px;line-height:1}
.nav-b-label{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.04em}
.tab-pages>div{display:none}
.tab-pages>div.active{display:block;animation:fadeIn .25s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);
  z-index:200;display:none;align-items:flex-end;justify-content:center;}
.overlay.open{display:flex;animation:fadeIn .2s ease}
.sheet{width:100%;max-width:480px;max-height:90vh;background:var(--s1);
  border:1px solid var(--border);border-radius:22px 22px 0 0;overflow-y:auto;position:relative;
  animation:sheetUp .3s cubic-bezier(.34,1.56,.64,1);}
@keyframes sheetUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sh{width:36px;height:3px;background:var(--border);border-radius:3px;margin:10px auto 14px}
.sb{padding:0 20px 28px}
.st{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:14px}
.sc{position:absolute;top:13px;right:16px;width:30px;height:30px;border-radius:50%;
  background:var(--s2);border:1px solid var(--border);display:flex;align-items:center;
  justify-content:center;cursor:pointer;font-size:14px;color:var(--muted);transition:all .2s;}
.sc:hover{color:var(--text)}
.gsbar{display:flex;justify-content:space-between;background:var(--s2);border-radius:11px;padding:10px 14px;margin-bottom:14px;font-size:12px;font-weight:700}
.gword{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;color:var(--blue);
  text-align:center;padding:18px;background:var(--s2);border-radius:14px;margin-bottom:14px;}
.gopts{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.gopt{padding:12px;background:var(--s2);border:1.5px solid var(--border);
  border-radius:11px;text-align:center;cursor:pointer;font-size:12px;font-weight:700;
  transition:all .2s;font-family:'Nunito',sans-serif;color:var(--text);}
.gopt:hover{border-color:var(--blue)}
.gopt.correct{border-color:var(--green);background:rgba(79,223,138,.12);color:var(--green)}
.gopt.wrong{border-color:var(--red);background:rgba(248,81,73,.12);color:var(--red)}
.match-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.mw{padding:11px;background:var(--s2);border:1.5px solid var(--border);border-radius:11px;text-align:center;cursor:pointer;font-size:12px;font-weight:700;transition:all .2s}
.mw.selected{border-color:var(--blue);background:rgba(79,156,249,.1)}
.mw.matched{border-color:var(--green);background:rgba(79,223,138,.1);color:var(--green);pointer-events:none}
.mw.bad{border-color:var(--red);background:rgba(248,81,73,.1);color:var(--red)}
.a-hint{font-size:16px;font-weight:800;color:var(--purple);text-align:center;margin-bottom:8px}
.a-slots{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;min-height:52px;padding:8px;background:var(--s2);border-radius:12px;margin-bottom:10px}
.a-slot{width:40px;height:44px;background:var(--border);border-radius:9px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:18px;font-weight:800;cursor:pointer;transition:all .2s}
.a-slot:hover{background:rgba(248,81,73,.2)}
.a-letters{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-bottom:12px}
.a-tile{width:40px;height:44px;background:var(--s2);border:1.5px solid var(--border);border-radius:9px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:18px;font-weight:800;cursor:pointer;transition:all .2s;user-select:none}
.a-tile:hover{border-color:var(--blue);transform:translateY(-2px)}
.a-tile.used{opacity:.25;pointer-events:none}
.gr-rule{background:rgba(192,132,252,.07);border:1px solid rgba(192,132,252,.15);border-radius:12px;padding:14px;font-size:13px;line-height:1.8;margin-bottom:12px}
.gr-eg{background:var(--s2);border-left:3px solid var(--purple);border-radius:0 9px 9px 0;padding:9px 13px;font-size:12px;font-style:italic;color:var(--purple);margin-bottom:7px}
.qopt{padding:10px 13px;background:var(--s2);border:1.5px solid var(--border);border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;transition:all .2s;font-family:'Nunito',sans-serif;color:var(--text);text-align:left;margin-bottom:6px;width:100%}
.qopt:hover{border-color:var(--purple)}
.qopt.correct{border-color:var(--green);background:rgba(79,223,138,.1);color:var(--green)}
.qopt.wrong{border-color:var(--red);background:rgba(248,81,73,.1);color:var(--red)}
.sinp{width:100%;padding:10px 13px;background:var(--s2);border:1.5px solid var(--border);border-radius:11px;font-size:13px;font-family:'Nunito',sans-serif;color:var(--text);outline:none;margin-bottom:10px}
.sinp:focus{border-color:var(--blue)}
.sinp::placeholder{color:var(--muted)}
.toast{position:fixed;bottom:76px;left:50%;transform:translateX(-50%);background:var(--s1);border:1px solid var(--border);border-radius:20px;padding:9px 18px;font-size:12px;font-weight:700;z-index:500;white-space:nowrap;animation:tIn .3s ease,tOut .3s 2.2s forwards;box-shadow:0 8px 24px rgba(0,0,0,.5);}
@keyframes tIn{from{opacity:0;transform:translateX(-50%) translateY(8px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
@keyframes tOut{to{opacity:0}}
.xp-pop{position:fixed;top:70px;right:14px;z-index:400;background:var(--gold);color:#080d14;padding:7px 14px;border-radius:20px;font-weight:800;font-size:13px;animation:xpIn .6s cubic-bezier(.34,1.56,.64,1) both,tOut .4s 1.6s forwards;pointer-events:none;}
@keyframes xpIn{from{opacity:0;transform:translateY(16px) scale(.7)}to{opacity:1;transform:translateY(0) scale(1)}}
/* BATTLE MATCHMAKING */
.match-status{text-align:center;padding:20px;background:rgba(124,90,246,.06);border:1px solid rgba(124,90,246,.2);border-radius:16px;margin-bottom:14px}
.match-spinner{font-size:40px;animation:spin 1s linear infinite;display:block;margin-bottom:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.battle-mode-btn{padding:12px;background:var(--s2);border:1.5px solid var(--border);border-radius:12px;font-size:13px;font-weight:700;font-family:'Nunito',sans-serif;color:var(--text);cursor:pointer;transition:all .2s;width:100%;margin-bottom:8px;text-align:left;display:flex;align-items:center;gap:10px}
.battle-mode-btn:hover{border-color:var(--orange)}
.battle-mode-btn .bm-icon{font-size:22px}
/* ===== PREMIUM STYLES ===== */
.premium-banner{background:linear-gradient(135deg,rgba(245,197,66,.12),rgba(249,123,79,.08));
  border:1px solid rgba(245,197,66,.3);border-radius:16px;padding:14px 16px;margin-bottom:14px;
  display:flex;align-items:center;gap:12px;cursor:pointer;}
.prem-ico{font-size:28px}
.prem-txt{flex:1}
.prem-title{font-size:13px;font-weight:800;color:var(--gold)}
.prem-sub{font-size:11px;color:var(--muted);margin-top:1px}
.prem-arrow{font-size:18px;color:var(--gold)}
.prem-lock{position:absolute;top:6px;right:6px;font-size:11px;
  background:rgba(245,197,66,.15);border:1px solid rgba(245,197,66,.3);
  color:var(--gold);padding:2px 7px;border-radius:20px;font-weight:800}
.plan-card{background:var(--s2);border:1.5px solid var(--border);border-radius:16px;
  padding:16px;margin-bottom:10px;cursor:pointer;transition:all .2s;position:relative;}
.plan-card.selected{border-color:var(--gold);background:rgba(245,197,66,.05)}
.plan-card:hover{border-color:var(--gold)}
.plan-badge{position:absolute;top:-9px;right:12px;background:linear-gradient(90deg,var(--orange),var(--gold));
  color:#080d14;font-size:10px;font-weight:800;padding:2px 10px;border-radius:20px}
.plan-price{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--gold)}
.plan-period{font-size:11px;color:var(--muted);font-weight:700}
.plan-features{margin-top:8px;font-size:11px;color:var(--muted);line-height:1.8}
/* Survival */
.surv-lives{display:flex;gap:6px;justify-content:center;margin-bottom:12px;font-size:22px}
.surv-streak-bar{height:6px;background:var(--s2);border-radius:10px;overflow:hidden;margin-bottom:14px}
.surv-streak-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--gold));border-radius:10px;transition:width .4s}
/* Daily challenge */
.dc-card{background:linear-gradient(135deg,rgba(79,156,249,.08),rgba(124,90,246,.06));
  border:1px solid rgba(79,156,249,.2);border-radius:16px;padding:16px;margin-bottom:10px}
.dc-timer{font-family:'Syne',sans-serif;font-size:32px;font-weight:800;color:var(--blue);text-align:center}
.dc-rank{font-size:12px;color:var(--muted);text-align:center;margin-top:4px}
/* Weak words */
.weak-item{display:flex;align-items:center;justify-content:space-between;
  background:rgba(248,81,73,.06);border:1px solid rgba(248,81,73,.15);
  border-radius:11px;padding:10px 13px;margin-bottom:6px;}
.weak-word{font-size:14px;font-weight:700;color:var(--red)}
.weak-bar-wrap{width:80px;height:6px;background:var(--s2);border-radius:10px;overflow:hidden}
.weak-bar{height:100%;background:var(--red);border-radius:10px}
/* Custom words */
.custom-inp{width:100%;padding:10px 13px;background:var(--s2);border:1.5px solid var(--border);
  border-radius:11px;font-size:13px;font-family:'Nunito',sans-serif;color:var(--text);
  outline:none;margin-bottom:8px}
.custom-inp:focus{border-color:var(--blue)}
/* Certificate */
.cert-wrap{background:linear-gradient(135deg,var(--s2),var(--s3));
  border:2px solid var(--gold);border-radius:20px;padding:24px;text-align:center;margin-bottom:14px}
.cert-title{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;
  background:linear-gradient(90deg,var(--gold),var(--orange));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.cert-name{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin:8px 0}
/* Group battle */
.group-code{font-family:'Syne',sans-serif;font-size:36px;font-weight:800;letter-spacing:.15em;
  color:var(--blue);text-align:center;background:var(--s2);border-radius:14px;
  padding:16px;margin-bottom:10px;cursor:pointer;}
.tournament-row{display:flex;align-items:center;justify-content:space-between;
  background:var(--s1);border:1px solid var(--border);border-radius:11px;
  padding:10px 14px;margin-bottom:6px}
.tr-rank{width:28px;font-weight:800;font-size:13px;color:var(--gold)}
.tr-info{flex:1}
.tr-name{font-size:13px;font-weight:700}
.tr-sub{font-size:11px;color:var(--muted)}
.tr-score{font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:var(--orange)}
/* ===== YANGI PREMIUM CSS ===== */
/* Reminder pills */
.rem-pill{background:var(--s2);border:1.5px solid var(--border);border-radius:11px;
  padding:9px 6px;font-size:12px;font-weight:700;color:var(--text);cursor:pointer;
  font-family:'Nunito',sans-serif;transition:all .2s}
.rem-pill.active,.rem-pill:hover{border-color:var(--purple);color:var(--purple);background:rgba(192,132,252,.1)}
/* Achievement card */
.ach-card{display:flex;align-items:center;gap:12px;background:var(--s1);
  border:1px solid var(--border);border-radius:13px;padding:12px 14px;transition:all .3s}
.ach-card.unlocked{border-color:rgba(245,197,66,.4);background:linear-gradient(135deg,rgba(245,197,66,.06),rgba(249,123,79,.04))}
.ach-card.locked{opacity:.5}
.ach-icon{font-size:28px;flex-shrink:0;width:44px;height:44px;display:flex;align-items:center;justify-content:center;
  background:var(--s2);border-radius:12px}
.ach-info{flex:1}
.ach-title{font-size:13px;font-weight:800}
.ach-sub{font-size:11px;color:var(--muted);margin-top:2px}
.ach-prog{height:4px;background:var(--s3);border-radius:4px;margin-top:6px;overflow:hidden}
.ach-prog-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--gold),var(--orange));transition:width .6s}
/* Premium avatar grid */
.prem-av-item{aspect-ratio:1;background:var(--s2);border:2px solid var(--border);border-radius:14px;
  display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;transition:all .2s}
.prem-av-item:hover,.prem-av-item.selected{border-color:var(--purple);background:rgba(192,132,252,.1);transform:scale(1.05)}
/* Heatmap */
.heat-day{flex:1;aspect-ratio:1;border-radius:4px;min-height:28px;transition:all .2s}
/* XP bar chart */
.xp-bar{flex:1;border-radius:4px 4px 0 0;background:linear-gradient(180deg,var(--accent),var(--purple));
  min-width:0;transition:height .6s;position:relative}
.xp-bar-label{position:absolute;bottom:-16px;left:50%;transform:translateX(-50%);
  font-size:8px;color:var(--muted);white-space:nowrap}
/* Translator */
.tr-example{background:var(--s2);border-radius:10px;padding:10px 12px;font-size:12px;line-height:1.5}
.tr-example b{color:var(--blue)}
</style>
</head>
<body>

<script>
// ============================================================
// SO'ZLAR TIZIMI ‚Äî JSON fayllardan fetch qiladi
// Format: data/book{n}/unit{n}.json
// JSON ichida: { "unit": 1, "total_words": 20, "words": [...] }
// ============================================================

// Cache ‚Äî bir marta yuklanganini qayta yuklamaslik uchun
const WORDS_CACHE = {};

// Kitob ‚Üí daraja mapping
const BOOK_LEVEL = {1:'beginner',2:'beginner',3:'intermediate',4:'intermediate',5:'advanced',6:'advanced'};
const BOOK_COLORS = {1:'var(--green)',2:'var(--green)',3:'var(--blue)',4:'var(--blue)',5:'var(--purple)',6:'var(--purple)'};

// Fallback ‚Äî agar JSON fayl topilmasa ishlatiladigan so'zlar
const FALLBACK_WORDS = {
  beginner: [
    {word:"afraid",translation:"qo'rqqan",definition:"feeling fear or anxiety",example:"The woman was afraid of what she saw.",part_of_speech:"adjective"},
    {word:"agree",translation:"fikriga qo'shilmoq",definition:"to say yes or think the same way",example:"I agree with you.",part_of_speech:"verb"},
    {word:"angry",translation:"jahli chiqqan",definition:"feeling or showing anger",example:"Her father is angry.",part_of_speech:"adjective"},
    {word:"beautiful",translation:"go'zal",definition:"pleasing to the senses",example:"She wore a beautiful dress.",part_of_speech:"adjective"},
    {word:"calm",translation:"tinch",definition:"not showing nervousness",example:"He remained calm.",part_of_speech:"adjective"},
    {word:"happy",translation:"xursand",definition:"feeling pleasure",example:"I am happy to help you.",part_of_speech:"adjective"},
    {word:"kind",translation:"mehribon",definition:"friendly nature",example:"He was kind to strangers.",part_of_speech:"adjective"},
    {word:"strong",translation:"kuchli",definition:"great physical power",example:"She is very strong.",part_of_speech:"adjective"},
  ],
  intermediate: [
    {word:"ambiguous",translation:"noaniq",definition:"open to more than one interpretation",example:"The instructions were ambiguous.",part_of_speech:"adjective"},
    {word:"competent",translation:"malakali",definition:"having the necessary ability",example:"She is a competent engineer.",part_of_speech:"adjective"},
    {word:"diligent",translation:"mehnatsevar",definition:"having care in one's work",example:"He is a diligent student.",part_of_speech:"adjective"},
    {word:"eloquent",translation:"notiq",definition:"fluent or persuasive",example:"She gave an eloquent speech.",part_of_speech:"adjective"},
    {word:"flexible",translation:"moslashuvchan",definition:"able to change easily",example:"We need a flexible approach.",part_of_speech:"adjective"},
    {word:"genuine",translation:"haqiqiy",definition:"truly what it is said to be",example:"This is a genuine concern.",part_of_speech:"adjective"},
    {word:"innovative",translation:"yangilikchi",definition:"featuring new ideas",example:"They used an innovative method.",part_of_speech:"adjective"},
    {word:"persistent",translation:"qat'iyatli",definition:"continuing despite difficulty",example:"Be persistent.",part_of_speech:"adjective"},
  ],
  advanced: [
    {word:"ubiquitous",translation:"hamma joyda mavjud",definition:"present everywhere",example:"Smartphones have become ubiquitous.",part_of_speech:"adjective"},
    {word:"pragmatic",translation:"amaliy",definition:"dealing with things realistically",example:"Take a pragmatic approach.",part_of_speech:"adjective"},
    {word:"meticulous",translation:"puxta",definition:"showing great attention to detail",example:"She is meticulous in her work.",part_of_speech:"adjective"},
    {word:"resilient",translation:"bardoshli",definition:"able to recover quickly",example:"Children are incredibly resilient.",part_of_speech:"adjective"},
    {word:"paradigm",translation:"namuna",definition:"a typical example or pattern",example:"This is a new paradigm shift.",part_of_speech:"noun"},
    {word:"scrutinize",translation:"sinchkovlik bilan tekshirmoq",definition:"examine or inspect closely",example:"They scrutinized every detail.",part_of_speech:"verb"},
    {word:"mitigate",translation:"yengillashtirmoq",definition:"make less severe",example:"Steps taken to mitigate risk.",part_of_speech:"verb"},
    {word:"perpetuate",translation:"davom ettirmoq",definition:"make continue indefinitely",example:"Don't perpetuate stereotypes.",part_of_speech:"verb"},
  ],
};

// Asosiy fetch funksiyasi ‚Äî JSON dan yuklaydi
async function fetchUnitWords(bookNum, unitNum) {
  const cacheKey = `book${bookNum}_unit${unitNum}`;
  if(cacheKey in WORDS_CACHE) return WORDS_CACHE[cacheKey];

  const url = `book${bookNum}/unit${unitNum}.json`;
  console.log('üîç Fetch URL:', url, '| Full URL:', window.location.origin + window.location.pathname.replace(/[^/]*$/, '') + url);
  try {
    const res = await fetch(url);
    console.log('üì° Response:', res.status, res.statusText, 'for', url);
    if(!res.ok){
      console.warn('‚ùå Fayl topilmadi:', url, res.status);
      WORDS_CACHE[cacheKey] = null;
      return null;
    }
    const data = await res.json();
    const words = Array.isArray(data) ? data : (data.words || []);
    console.log('‚úÖ So\'zlar yuklandi:', words.length, 'ta ‚Äî', url);
    WORDS_CACHE[cacheKey] = words;
    return words;
  } catch(e) {
    console.error('üí• Fetch xatosi:', url, e.message);
    WORDS_CACHE[cacheKey] = null;
    return null;
  }
}

// Bir kitobdagi mavjud unitlarni aniqlash ‚Äî ketma-ket tekshiradi
async function detectUnitsInBook(bookNum) {
  const cacheKey = `book${bookNum}_units`;
  if(WORDS_CACHE[cacheKey] && WORDS_CACHE[cacheKey].length > 0) return WORDS_CACHE[cacheKey];

  const found = [];
  // 1 dan 30 gacha ketma-ket, topilmasa to'xtaymiz (3 ta ketma-ket yo'q bo'lsa)
  let misses = 0;
  for(let n = 1; n <= 30; n++){
    const words = await fetchUnitWords(bookNum, n);
    if(words !== null && words.length > 0){
      found.push(n);
      misses = 0;
    } else {
      misses++;
      if(misses >= 3 && found.length > 0) break; // 3 ta yo'q bo'lsa to'xtaymiz
    }
  }
  WORDS_CACHE[cacheKey] = found;
  return found;
}

// Barcha so'zlarni olish (progress uchun)
function getAllWordsFallback(level) {
  return FALLBACK_WORDS[level] || [];
}

// ============================================================
// GRAMMAR DATA
// ============================================================
const GRAMMAR_DATA = {
  beginner: [
    {icon:"üìå", title:"Present Simple", sub:"Oddiy hozirgi zamon",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + V(s/es)"},
        {label:"‚ùå Inkor",   f:"S + do/does + not + V"},
        {label:"‚ùì So'roq",  f:"Do/Does + S + V ?"},
      ],
      keys:["always","usually","often","sometimes","never","every day","every week","on Mondays"],
      rules:"Odatiy, takrorlanuvchan yoki doimiy harakatlar uchun.\nHe/She/It bilan fe'lga <b>-s / -es</b> qo'shiladi.\n<b>do not</b> = don't | <b>does not</b> = doesn't",
      examples:[
        "She <b>works</b> every day.",
        "They <b>don't like</b> coffee.",
        "<b>Does</b> he <b>play</b> football?",
      ],
      quiz:{q:"She ___ to school every day.",opts:["go","goes","going","gone"],ans:1}},

    {icon:"‚è≥", title:"Present Continuous", sub:"Hozir bo'layotgan harakat",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + am/is/are + V-ing"},
        {label:"‚ùå Inkor",   f:"S + am/is/are + not + V-ing"},
        {label:"‚ùì So'roq",  f:"Am/Is/Are + S + V-ing ?"},
      ],
      keys:["now","at the moment","currently","right now","today","look!","listen!"],
      rules:"Hozirda yoki ushbu vaqt atrofida bo'layotgan harakatlar uchun.\nYaqin kelajak rejalari uchun ham ishlatiladi.",
      examples:[
        "I <b>am studying</b> English now.",
        "She <b>is not working</b> today.",
        "<b>Are</b> they <b>playing</b> outside?",
      ],
      quiz:{q:"They ___ football right now.",opts:["play","plays","are playing","played"],ans:2}},

    {icon:"üìö", title:"Past Simple", sub:"Tugagan o'tgan zamon",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + V2 (muntazam: V+ed)"},
        {label:"‚ùå Inkor",   f:"S + did not + V1"},
        {label:"‚ùì So'roq",  f:"Did + S + V1 ?"},
      ],
      keys:["yesterday","last week","last year","ago","in 2020","in the morning","once"],
      rules:"O'tmishda ma'lum vaqtda tugagan harakatlar uchun.\nMuntazam fe'llarga <b>-ed</b> qo'shiladi.\nNomuntazam fe'llar alohida shaklga ega.",
      examples:[
        "She <b>visited</b> London last year.",
        "He <b>didn't come</b> to the party.",
        "<b>Did</b> you <b>see</b> that movie?",
      ],
      quiz:{q:"He ___ the book last night.",opts:["read","reads","reading","readed"],ans:0}},

    {icon:"üîÅ", title:"Past Continuous", sub:"O'tmishda davom etgan harakat",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + was/were + V-ing"},
        {label:"‚ùå Inkor",   f:"S + was/were + not + V-ing"},
        {label:"‚ùì So'roq",  f:"Was/Were + S + V-ing ?"},
      ],
      keys:["while","when","at that moment","all day","at 5 o'clock yesterday"],
      rules:"O'tmishda biror vaqtda davom etayotgan harakat uchun.\nKo'pincha Past Simple bilan birgalikda ishlatiladi.\n<b>while</b> + Past Continuous | <b>when</b> + Past Simple",
      examples:[
        "I <b>was reading</b> when she called.",
        "They <b>were not sleeping</b> at midnight.",
        "<b>Was</b> he <b>working</b> at 9pm?",
      ],
      quiz:{q:"She ___ TV when I arrived.",opts:["watched","watches","was watching","is watching"],ans:2}},

    {icon:"üîÆ", title:"Future Simple", sub:"Kelajak zamon",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + will + V1"},
        {label:"‚ùå Inkor",   f:"S + will not (won't) + V1"},
        {label:"‚ùì So'roq",  f:"Will + S + V1 ?"},
      ],
      keys:["tomorrow","next week","next year","soon","in the future","someday"],
      rules:"Kelajakdagi qarorlar, bashoratlar va va'dalar uchun.\n<b>Going to</b> ‚Äî oldindan rejalashtirilgan harakatlar uchun.\nSpontan qarorlar uchun <b>will</b> ishlatiladi.",
      examples:[
        "I <b>will call</b> you tomorrow.",
        "She <b>won't forget</b> your birthday.",
        "<b>Will</b> you <b>help</b> me?",
      ],
      quiz:{q:"I ___ visit you next week.",opts:["am","was","will","do"],ans:2}},

    {icon:"üîÑ", title:"Present Perfect", sub:"Hozirga aloqasi bor o'tmi≈ü",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + have/has + V3"},
        {label:"‚ùå Inkor",   f:"S + have/has + not + V3"},
        {label:"‚ùì So'roq",  f:"Have/Has + S + V3 ?"},
      ],
      keys:["already","yet","ever","never","just","recently","so far","for","since"],
      rules:"O'tmishda bo'lgan, natijasi hozirga ta'sir qiluvchi harakatlar.\n<b>for</b> = muddat (for 3 years) | <b>since</b> = boshlang'ich vaqt (since 2020)\n<b>have/has + V3</b> (3-forma: done, gone, seen)",
      examples:[
        "I <b>have seen</b> that movie.",
        "She <b>hasn't finished</b> yet.",
        "<b>Have</b> you ever <b>been</b> to Japan?",
      ],
      quiz:{q:"I ___ never been to Japan.",opts:["am","have","was","had"],ans:1}},

    {icon:"‚èÆ", title:"Past Perfect", sub:"O'tmishdagi o'tmi≈ü",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + had + V3"},
        {label:"‚ùå Inkor",   f:"S + had + not + V3"},
        {label:"‚ùì So'roq",  f:"Had + S + V3 ?"},
      ],
      keys:["before","after","already","by the time","when","until"],
      rules:"O'tmishdagi ikki harakatdan biri ikkinchisidan oldin bo'lganda.\n<b>by the time</b> + Past Simple, Past Perfect\nBirinchi bo'lgan harakat = Past Perfect",
      examples:[
        "She <b>had left</b> before I arrived.",
        "He <b>hadn't eaten</b> anything all day.",
        "<b>Had</b> they <b>met</b> before the party?",
      ],
      quiz:{q:"When I arrived, she ___ already left.",opts:["has","have","had","was"],ans:2}},

    {icon:"üöÄ", title:"Future Continuous", sub:"Kelajakda davom etayotgan harakat",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + will be + V-ing"},
        {label:"‚ùå Inkor",   f:"S + will not be + V-ing"},
        {label:"‚ùì So'roq",  f:"Will + S + be + V-ing ?"},
      ],
      keys:["at this time tomorrow","at 5pm next Friday","all day tomorrow","this time next week"],
      rules:"Kelajakda ma'lum bir vaqtda davom etayotgan bo'ladigan harakat uchun.",
      examples:[
        "I <b>will be sleeping</b> at midnight.",
        "She <b>won't be working</b> tomorrow.",
        "<b>Will</b> you <b>be studying</b> at 9pm?",
      ],
      quiz:{q:"This time tomorrow I ___ on the beach.",opts:["sit","will sit","will be sitting","am sitting"],ans:2}},

    {icon:"üîÉ", title:"Present Perfect Continuous", sub:"Davom etib kelayotgan harakat",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + have/has been + V-ing"},
        {label:"‚ùå Inkor",   f:"S + have/has not been + V-ing"},
        {label:"‚ùì So'roq",  f:"Have/Has + S + been + V-ing ?"},
      ],
      keys:["for","since","how long","all day","lately","recently"],
      rules:"O'tmishda boshlangan va hozirda ham davom etayotgan harakatlar.\nNatijaga emas, <b>davomiyligiga</b> urg'u beriladi.",
      examples:[
        "I <b>have been studying</b> for 3 hours.",
        "She <b>has been waiting</b> since 9am.",
        "<b>How long have</b> you <b>been learning</b> English?",
      ],
      quiz:{q:"He ___ English for 5 years.",opts:["learns","has learned","has been learning","is learning"],ans:2}},

    {icon:"‚è≠", title:"Future Perfect", sub:"Kelajakda tugagan bo'ladigan harakat",
      formulas:[
        {label:"‚úÖ Tasdiq",  f:"S + will have + V3"},
        {label:"‚ùå Inkor",   f:"S + will not have + V3"},
        {label:"‚ùì So'roq",  f:"Will + S + have + V3 ?"},
      ],
      keys:["by tomorrow","by next week","by the time","by 2030","before"],
      rules:"Kelajakdagi ma'lum bir vaqtga qadar tugagan bo'ladigan harakat.\n<b>by</b> + vaqt bilan ko'p ishlatiladi.",
      examples:[
        "I <b>will have finished</b> by Monday.",
        "She <b>won't have graduated</b> by next year.",
        "<b>Will</b> you <b>have eaten</b> by 7pm?",
      ],
      quiz:{q:"By next year, she ___ her degree.",opts:["finishes","will finish","will have finished","has finished"],ans:2}},
  ],

  intermediate: [
    {icon:"üîÄ", title:"Zero Conditional", sub:"Har doim to'g'ri bo'lgan holatlar",
      formulas:[{label:"Formula", f:"If + Present Simple, Present Simple"}],
      keys:["if","when","always","generally"],
      rules:"Ilmiy haqiqatlar, tabiat qonunlari va umumiy haqiqatlar uchun.\n<b>if = when</b> ma'nosida ishlatiladi.",
      examples:[
        "If you <b>heat</b> water to 100¬∞C, it <b>boils</b>.",
        "If it <b>rains</b>, the ground <b>gets</b> wet.",
      ],
      quiz:{q:"If you ___ water, it evaporates.",opts:["heat","heated","will heat","heating"],ans:0}},

    {icon:"1Ô∏è‚É£", title:"First Conditional", sub:"Mumkin bo'lgan kelajak",
      formulas:[{label:"Formula", f:"If + Present Simple, will + V1"}],
      keys:["if","unless","as long as","provided that","in case"],
      rules:"Haqiqiy va mumkin bo'lgan kelajak shartlar uchun.\n<b>unless</b> = if ... not ma'nosida",
      examples:[
        "If it <b>rains</b>, I <b>will stay</b> home.",
        "Unless you <b>study</b>, you <b>won't pass</b>.",
      ],
      quiz:{q:"If she ___ hard, she will succeed.",opts:["work","works","worked","will work"],ans:1}},

    {icon:"2Ô∏è‚É£", title:"Second Conditional", sub:"Xayoliy / mumkin bo'lmagan hozirgi",
      formulas:[{label:"Formula", f:"If + Past Simple, would + V1"}],
      keys:["if","would","could","might","imagine","suppose"],
      rules:"Hozirda haqiqiy bo'lmagan yoki kam ehtimollik holatlar uchun.\n<b>If I were you</b> ‚Äî maslahat berishda ishlatiladi.",
      examples:[
        "If I <b>had</b> money, I <b>would travel</b>.",
        "If I <b>were</b> you, I <b>would apologize</b>.",
      ],
      quiz:{q:"If he ___ harder, he would pass.",opts:["studies","studied","will study","study"],ans:1}},

    {icon:"3Ô∏è‚É£", title:"Third Conditional", sub:"O'tmishga afsus",
      formulas:[{label:"Formula", f:"If + Past Perfect, would have + V3"}],
      keys:["if","would have","could have","might have"],
      rules:"O'tmishda bo'lmagan yoki o'zgartirish mumkin bo'lmagan holatlar.\nAfsus va tanqid ifodalashda ishlatiladi.",
      examples:[
        "If I <b>had studied</b>, I <b>would have passed</b>.",
        "She <b>would have come</b> if you <b>had invited</b> her.",
      ],
      quiz:{q:"If they ___ harder, they would have won.",opts:["try","tried","had tried","have tried"],ans:2}},

    {icon:"üéõ", title:"Modal Verbs ‚Äî Imkoniyat", sub:"Can, Could, Be able to",
      formulas:[
        {label:"can",       f:"S + can + V1 (hozirgi)"},
        {label:"could",     f:"S + could + V1 (o'tmi≈ü / vaqtincha)"},
        {label:"be able to",f:"S + am/is/are able to + V1"},
      ],
      keys:["can","could","be able to","manage to"],
      rules:"<b>can</b> ‚Äî hozirgi qobiliyat\n<b>could</b> ‚Äî o'tmi≈ü qobiliyat yoki muloyim so'rov\n<b>be able to</b> ‚Äî barcha zamonlarda ishlatiladi",
      examples:[
        "She <b>can</b> speak 3 languages.",
        "He <b>could</b> swim when he was 5.",
        "I <b>was able to</b> finish on time.",
      ],
      quiz:{q:"___ you help me, please?",opts:["Can","Could","Would","All of these"],ans:3}},

    {icon:"‚ö†Ô∏è", title:"Modal Verbs ‚Äî Majburiyat", sub:"Must, Have to, Should, Ought to",
      formulas:[
        {label:"must",   f:"S + must + V1 (ichki majburiyat)"},
        {label:"have to",f:"S + have to + V1 (tashqi majburiyat)"},
        {label:"should", f:"S + should + V1 (maslahat)"},
      ],
      keys:["must","have to","should","ought to","need to","had better"],
      rules:"<b>must</b> ‚Äî shaxsiy majburiyat / qat'iy talab\n<b>have to</b> ‚Äî qoida, qonun yoki tashqi majburiyat\n<b>should</b> ‚Äî maslahat, tavsiya",
      examples:[
        "You <b>must</b> stop at red lights.",
        "I <b>have to</b> finish this report.",
        "You <b>should</b> sleep early.",
      ],
      quiz:{q:"You ___ wear a seatbelt. It's the law.",opts:["should","can","must","might"],ans:2}},

    {icon:"ü§î", title:"Modal Verbs ‚Äî Ehtimollik", sub:"May, Might, Must, Can't",
      formulas:[
        {label:"must",  f:"S + must + V1 (95% ishonch)"},
        {label:"may",   f:"S + may + V1 (50% ehtimol)"},
        {label:"might", f:"S + might + V1 (30% ehtimol)"},
        {label:"can't", f:"S + can't + V1 (imkonsiz)"},
      ],
      keys:["must","may","might","could","can't","probably","perhaps"],
      rules:"<b>must</b> ‚Äî mantiqiy xulosa\n<b>may/might</b> ‚Äî noaniqlik, ehtimollik\n<b>can't</b> ‚Äî mantiqiy inkor",
      examples:[
        "She <b>must be</b> tired.",
        "It <b>might rain</b> tomorrow.",
        "He <b>can't be</b> home ‚Äî I saw him leave.",
      ],
      quiz:{q:"He knows every answer. He ___ be very smart.",opts:["might","can't","must","may"],ans:2}},

    {icon:"üîÑ", title:"Passive Voice ‚Äî Present & Past", sub:"Ish kimga bajariladi",
      formulas:[
        {label:"Present Simple", f:"S + am/is/are + V3"},
        {label:"Past Simple",    f:"S + was/were + V3"},
        {label:"Present Perfect",f:"S + have/has been + V3"},
        {label:"Future",         f:"S + will be + V3"},
      ],
      keys:["by","is made","was built","has been found","will be sent"],
      rules:"Harakat bajaruvchi emas, harakatni qabul qiluvchi muhim bo'lganda.\nAgent (bajaruvchi) <b>by</b> bilan beriladi yoki tushirib qoldiriladi.",
      examples:[
        "English <b>is spoken</b> worldwide.",
        "The letter <b>was written</b> by him.",
        "The project <b>has been completed</b>.",
      ],
      quiz:{q:"The cake ___ by my mother yesterday.",opts:["made","is made","was made","has made"],ans:2}},

    {icon:"üîÄ", title:"Passive Voice ‚Äî Modal & Perfect", sub:"Modal va Perfect passive",
      formulas:[
        {label:"Modal Passive",       f:"S + modal + be + V3"},
        {label:"Past Perfect Passive",f:"S + had been + V3"},
        {label:"Future Perfect",      f:"S + will have been + V3"},
      ],
      keys:["must be done","should be fixed","had been told","will have been completed"],
      rules:"Modal fe'llar bilan passive: <b>modal + be + V3</b>\nPast Perfect passive: <b>had been + V3</b>",
      examples:[
        "This <b>must be done</b> today.",
        "He <b>should be told</b> the truth.",
        "The report <b>had been submitted</b> before the deadline.",
      ],
      quiz:{q:"The problem ___ before I arrived.",opts:["solved","has been solved","had been solved","was solve"],ans:2}},
  ],

  advanced: [
    {icon:"üîÉ", title:"Inversion", sub:"Inversiya ‚Äî so'z tartibini o'zgartirish",
      formulas:[
        {label:"Negative adverb", f:"Never/Rarely/Seldom + aux + S + V"},
        {label:"Only",            f:"Only + adv/clause + aux + S + V"},
        {label:"Not until",       f:"Not until + time + aux + S + V"},
        {label:"So/Such",         f:"So + adj + aux + S + that..."},
      ],
      keys:["never","rarely","seldom","hardly","barely","not only","only when","only after","so...that","such...that","not until","little did"],
      rules:"Inversiya ikki sabab uchun ishlatiladi:\n1. <b>Urg'u</b> berish (ta'kidlash)\n2. <b>Rasmiy/adabiy</b> uslub\nOdatda salbiy yoki cheklovchi ravishlar jumlani boshlaganda qo'llanadi.",
      examples:[
        "<b>Never have I seen</b> such beauty.",
        "<b>Rarely does he</b> make mistakes.",
        "<b>Not only did she</b> win, but she broke the record.",
        "<b>Only after</b> he left <b>did</b> I realize the truth.",
        "<b>So tired was</b> she that she fell asleep immediately.",
      ],
      quiz:{q:"___ have I seen such a beautiful sunset.",opts:["Rarely","Rare","Rarely I","Rarely I have"],ans:0}},

    {icon:"‚úÇÔ∏è", title:"Cleft Sentences", sub:"It is/was ... that ‚Äî ta'kidlash",
      formulas:[
        {label:"It-cleft",  f:"It + is/was + [ta'kidlanadigan qism] + that/who + ..."},
        {label:"Wh-cleft",  f:"What + S + V + is/was + [ta'kidlanadigan qism]"},
      ],
      keys:["it is","it was","what I need","what matters","what happened"],
      rules:"Jumlaning biror qismini ta'kidlash uchun ishlatiladi.\n<b>It-cleft</b> ‚Äî aniq elementni ajratib ko'rsatadi\n<b>Wh-cleft</b> ‚Äî gap boshida 'what' bilan keladi",
      examples:[
        "<b>It was John who</b> broke the window.",
        "<b>It is hard work that</b> leads to success.",
        "<b>What I need</b> is a good rest.",
        "<b>What surprised me</b> was her reaction.",
      ],
      quiz:{q:"___ John who called you last night.",opts:["It was","It is","What was","That was"],ans:0}},

    {icon:"üîÄ", title:"Mixed Conditionals", sub:"Aralash shartli gaplar",
      formulas:[
        {label:"Past ‚Üí Present", f:"If + Past Perfect, would + V1"},
        {label:"Present ‚Üí Past", f:"If + Past Simple, would have + V3"},
      ],
      keys:["if","would","would have","could","might"],
      rules:"<b>Type 1 (Past‚ÜíPresent):</b> O'tmishdagi harakat hozirgi holatga ta'sir qiladi.\n<b>Type 2 (Present‚ÜíPast):</b> Hozirgi holat o'tmishdagi narsaga ta'sir qilganda.",
      examples:[
        "If I <b>had studied</b> medicine, I <b>would be</b> a doctor now.",
        "If she <b>weren't</b> so shy, she <b>would have spoken</b> up.",
      ],
      quiz:{q:"If he had taken that job, he ___ rich now.",opts:["would be","would have been","will be","had been"],ans:0}},

    {icon:"üé≠", title:"Subjunctive Mood", sub:"Istak va taklif ifodasi",
      formulas:[
        {label:"Present Subjunctive", f:"S + suggest/recommend + that + S + V1 (bare)"},
        {label:"Were-subjunctive",    f:"If I/he/she + were... (xayoliy)"},
      ],
      keys:["suggest","recommend","insist","demand","require","propose","wish","if I were"],
      rules:"<b>Present Subjunctive:</b> Tavsiya, talab, taklif gaplarida\nFe'l barcha shaxslarda <b>V1 (base form)</b> bo'ladi\n<b>Were-subjunctive:</b> Xayoliy holatlarda 'was' o'rniga 'were' ishlatiladi",
      examples:[
        "I suggest that he <b>be</b> more careful.",
        "She insisted that he <b>leave</b> immediately.",
        "If I <b>were</b> the president, I would change things.",
      ],
      quiz:{q:"The doctor recommended that she ___ more rest.",opts:["gets","get","got","is getting"],ans:1}},

    {icon:"üí¨", title:"Emphatic Structures", sub:"Ta'kidlash strukturalari",
      formulas:[
        {label:"Do/Does/Did emphasis", f:"S + do/does/did + V1 (ta'kid)"},
        {label:"As much/many as",      f:"as much/many as + son/miqdor"},
        {label:"Such...that",          f:"such + (a/an) + adj + noun + that"},
        {label:"So...that",            f:"so + adj/adv + that"},
      ],
      keys:["do","does","did","such","so...that","as much as","as many as","even","indeed","absolutely"],
      rules:"<b>Do/does/did</b> ta'kid uchun: 'I <b>do</b> like it!'\n<b>As much as</b>: 'It costs <b>as much as</b> $500'\n<b>Such...that / So...that</b>: natijani ta'kidlash",
      examples:[
        "I <b>do</b> understand your point.",
        "She <b>did</b> warn us about the danger.",
        "He ate <b>as much as</b> three portions.",
        "It was <b>such a</b> good film <b>that</b> I watched it twice.",
        "She ran <b>so fast that</b> nobody could catch her.",
      ],
      quiz:{q:"I ___ tell you this would happen!",opts:["do","did","does","have"],ans:1}},

    {icon:"üèó", title:"Advanced Complex Structures", sub:"Murakkab grammatik strukturalar",
      formulas:[
        {label:"Reduced relative clause", f:"N + V-ing/V3 (who/which + verb o'rniga)"},
        {label:"Participle clause",       f:"V-ing/Having + V3, S + V"},
        {label:"Nominalization",          f:"V ‚Üí Noun (decide ‚Üí decision)"},
        {label:"Fronting",                f:"[Object/Adverb] + S + V (ta'kid)"},
      ],
      keys:["having done","being","given","considering","provided","assuming","regarding","concerning"],
      rules:"<b>Reduced relative:</b> 'the man <b>sitting</b> there' = the man who is sitting\n<b>Participle clause:</b> ikkita harakatni qisqartirish\n<b>Fronting:</b> ob'ektni oldiniga qo'yish ‚Äî ta'kid",
      examples:[
        "The man <b>standing</b> there is my boss.",
        "<b>Having finished</b> his work, he went home.",
        "<b>Tired as she was</b>, she kept working.",
        "<b>This I cannot accept.</b> (fronting)",
        "<b>Given the circumstances</b>, we did well.",
      ],
      quiz:{q:"___ his homework, he went out to play.",opts:["Finish","Finished","Having finished","He finished"],ans:2}},

    {icon:"üìê", title:"Relative Clauses", sub:"Aniqlovchi va tavsiflovchi gaplar",
      formulas:[
        {label:"Defining",       f:"N + who/which/that + V (vergulsiz)"},
        {label:"Non-defining",   f:"N + , who/which , + V (vergul bilan)"},
        {label:"Preposition",    f:"N + prep + which/whom + V"},
      ],
      keys:["who","which","that","whose","whom","where","when"],
      rules:"<b>Defining:</b> Narsani aniqlaydi ‚Äî bo'lmasa ma'no o'zgaradi (vergulsiz)\n<b>Non-defining:</b> Qo'shimcha ma'lumot ‚Äî bo'lmasa ham bo'ladi (vergul bilan)\n<b>that</b> = non-defining gaplarda ishlatilmaydi",
      examples:[
        "The man <b>who called</b> is my uncle. (defining)",
        "My brother, <b>who lives in London</b>, is a doctor. (non-defining)",
        "The book <b>about which</b> I told you is amazing.",
      ],
      quiz:{q:"The city ___ I was born is very beautiful.",opts:["which","that","where","who"],ans:2}},
  ],
};

// ===== USER STATE =====
let U = JSON.parse(sessionStorage.getItem('ep_user') || 'null');
if(!U){ window.location.href='register.html'; }

let cardIdx=0, cardFlipped=false;
let currentUnitWords=[];

// ===== LEADERBOARD DATA =====
const FAKE_LB=[
  {name:"Nodira",xp:3420,av:"üò∫"},
  {name:"Jasur",xp:2980,av:"ü¶ä"},
  {name:"Malika",xp:2450,av:"üê∏"},
  {name:"Akbar",xp:1890,av:"ü§ñ"},
  {name:"Zulfiya",xp:1420,av:"üê±"},
];

// ===== ONLINE PLAYERS (fake) =====
const ONLINE_PLAYERS = [
  {name:"Sherzod",av:"üêØ",xp:1200},
  {name:"Nilufar",av:"ü¶ã",xp:980},
  {name:"Bobur",av:"ü¶Å",xp:1540},
  {name:"Sarvar",av:"üê∫",xp:760},
  {name:"Gulnora",av:"üå∏",xp:1890},
];
</script>

<div id="app">
  <!-- TOPBAR -->
  <div>
    <div class="topbar">
      <div class="tb-row">
        <div class="tb-av" id="tb-av">ü§ñ</div>
        <div class="tb-info">
          <div class="tb-name" id="tb-name">‚Äî</div>
          <div class="tb-sub">
            <span class="badge" id="tb-badge">‚Äî</span>
            <span id="tb-xp">0 XP</span>
          </div>
        </div>
        <div class="tb-right">
          <div class="streak">üî• <span id="tb-streak">1</span></div>
        </div>
      </div>
    </div>
    <div class="prog-bar-wrap">
      <div class="prog-labels">
        <span>O'rganilgan so'zlar</span>
        <span id="prog-val">0 / 0</span>
      </div>
      <div class="prog-track"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
    </div>
  </div>

  <!-- PAGES -->
  <div class="tab-pages scroll-area">

    <!-- HOME -->
    <div id="tab-home" class="active">

      <!-- BOOK & UNIT SELECTOR -->
      <div class="sec">
        <div class="sec-hd">
          <div class="sec-title">üìö So'zlar</div>
          <div class="sec-link" onclick="openModal('modal-words')">Barchasi ‚Üí</div>
        </div>

        <!-- BOOK TABS -->
        <div style="margin-bottom:10px">
          <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:7px">KITOB TANLANG</div>
          <div class="unit-row" id="book-row"></div>
        </div>

        <!-- UNIT INPUT -->
        <div style="margin-bottom:12px">
          <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:7px">UNIT RAQAMI (<span id="unit-range">1‚Äì30</span>)</div>
          <div style="display:flex;gap:8px;align-items:center">
            <div style="display:flex;align-items:center;gap:6px;flex:1;background:var(--s2);border:1.5px solid var(--border);border-radius:12px;padding:8px 12px">
              <span style="font-size:16px">üìñ</span>
              <input type="number" id="unit-inp" min="1" max="30" value="1"
                style="flex:1;background:transparent;border:none;outline:none;font-size:16px;font-weight:800;font-family:'Syne',sans-serif;color:var(--text);width:60px"
                oninput="previewUnit(this.value)">
              <span style="font-size:12px;color:var(--muted);font-weight:700">- unit</span>
            </div>
            <button onclick="goToUnit()" style="padding:10px 18px;background:linear-gradient(135deg,var(--accent),#5b3fd4);border:none;border-radius:12px;color:white;font-size:13px;font-weight:800;font-family:'Nunito',sans-serif;cursor:pointer;box-shadow:0 4px 12px rgba(124,90,246,.3)">
              O'tish ‚Üí
            </button>
          </div>
          <div id="unit-quick" style="display:flex;gap:5px;flex-wrap:wrap;margin-top:8px"></div>
        </div>

        <!-- CURRENT SELECTION INFO -->
        <div id="sel-info" style="background:rgba(124,90,246,.08);border:1px solid rgba(124,90,246,.2);border-radius:12px;padding:10px 14px;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-size:12px;font-weight:800;color:var(--al)" id="sel-title">Kitob 1 ¬∑ Unit 1</div>
            <div style="font-size:11px;color:var(--muted);margin-top:2px" id="sel-sub">0 ta so'z</div>
          </div>
          <div style="font-size:11px;color:var(--green);font-weight:700" id="sel-done"></div>
        </div>

        <!-- FLASHCARD -->
        <div class="fc-outer">
          <div class="fc" id="fc" onclick="flipCard()">
            <div class="fc-face">
              <div class="fc-pos" id="fc-pos">‚Äî</div>
              <div class="fc-utag" id="fc-utag">‚Äî</div>
              <div class="fc-word" id="fc-word">‚Äî</div>
              <div class="fc-hint">üëÜ Bosib tarjimani ko'ring</div>
            </div>
            <div class="fc-face fc-back">
              <div class="fc-pos" id="fc-pos2">‚Äî</div>
              <div class="fc-trans" id="fc-trans">‚Äî</div>
              <div class="fc-def" id="fc-def">‚Äî</div>
              <div class="fc-eg" id="fc-eg">‚Äî</div>
            </div>
          </div>
        </div>
        <div class="fc-ctrl">
          <div class="fc-nav">
            <div class="fc-btn" onclick="prevCard()">‚Äπ</div>
            <span class="fc-count" id="fc-count">1 / 8</span>
            <div class="fc-btn" onclick="nextCard()">‚Ä∫</div>
          </div>
          <div class="audio-btn" onclick="speakWord()">üîä Eshitish</div>
        </div>
      </div>

      <!-- GAMES shortcut -->
      <div class="sec">
        <div class="sec-hd">
          <div class="sec-title">üéÆ O'yinlar</div>
          <div class="sec-link" onclick="switchTabByName('games')">Barchasi ‚Üí</div>
        </div>
        <div class="games-grid">
          <div class="game-card" onclick="openModal('modal-match')">
            <div class="g-icon">üîó</div><div class="g-name">Word Match</div><div class="g-desc">Juftlashtir</div>
          </div>
          <div class="game-card" onclick="openModal('modal-anagram')">
            <div class="g-icon">üî§</div><div class="g-name">Hidden Word</div><div class="g-desc">Harflarni joylashtir</div>
          </div>
          <div class="game-card" onclick="openModal('modal-quiz')">
            <div class="g-icon">‚ùì</div><div class="g-name">Quiz</div><div class="g-desc">To'g'risini tanlang</div>
          </div>
        </div>
      </div>

      <!-- GRAMMAR -->
      <div class="sec">
        <div class="sec-hd">
          <div class="sec-title">üìñ Grammatika</div>
          <div class="sec-link" onclick="openModal('modal-gr-levels')">Daraja ‚ñæ</div>
        </div>
        <div class="gr-list" id="gr-list"></div>
      </div>
    </div>

    <!-- PROGRESS -->
    <div id="tab-progress">
      <div class="sec">
        <div class="sec-title" style="margin-bottom:12px">üìä Statistika</div>
        <div class="stats-row">
          <div class="stat"><div class="stat-n" style="color:var(--blue)" id="st-words">0</div><div class="stat-l">So'zlar</div></div>
          <div class="stat"><div class="stat-n" style="color:var(--gold)" id="st-streak">1</div><div class="stat-l">Streaküî•</div></div>
          <div class="stat"><div class="stat-n" style="color:var(--al)" id="st-xp">0</div><div class="stat-l">XP ball</div></div>
        </div>
      </div>
      <div class="sec">
        <div class="sec-hd"><div class="sec-title">üèÜ Reyting</div></div>
        <div class="lb-list" id="lb-main"></div>
      </div>
      <div class="sec">
        <div class="sec-hd">
          <div class="sec-title">üìù O'rganilgan so'zlar</div>
          <div class="sec-link" onclick="openModal('modal-words')">Barchasi</div>
        </div>
        <div id="recent-wl"></div>
      </div>
    </div>

    <!-- BATTLE -->
    <div id="tab-battle">
      <div class="sec">
        <div class="battle-hero">
          <div class="bh-vs">1 vs 1</div>
          <div class="bh-players">
            <div class="bh-player">
              <div class="bh-av" id="bh-me-av">ü§ñ</div>
              <div class="bh-pname" id="bh-me-name">Siz</div>
              <div class="bh-score" id="bh-me-s">0</div>
            </div>
            <div style="font-size:28px">‚öîÔ∏è</div>
            <div class="bh-player">
              <div class="bh-av" id="bh-opp-av">ü§ñ</div>
              <div class="bh-pname" id="bh-opp-name">Raqib</div>
              <div class="bh-score" id="bh-opp-s">0</div>
            </div>
          </div>
        </div>
        <button class="btn-p" onclick="findOpponent()">üéØ Raqib topish</button>
        <button class="btn-s" onclick="startBotBattle()">ü§ñ Robot bilan o'ynash</button>
        <button class="btn-s" onclick="openModal('modal-lb')">üèÜ Global reyting</button>
        <div class="sec-title" style="margin:14px 0 10px">üèÖ Natijalarim</div>
        <div class="stats-row">
          <div class="stat"><div class="stat-n" style="color:var(--green)" id="bw">0</div><div class="stat-l">G'alaba</div></div>
          <div class="stat"><div class="stat-n" style="color:var(--red)" id="bl">0</div><div class="stat-l">Mag'lubiyat</div></div>
          <div class="stat"><div class="stat-n" style="color:var(--gold)" id="bxp">0</div><div class="stat-l">XP</div></div>
        </div>
      </div>
    </div>

    <!-- GAMES TAB -->
    <div id="tab-games">
      <div class="sec">
        <div class="sec-title" style="margin-bottom:12px">üéÆ O'yinlar</div>
        <div style="font-size:11px;color:var(--muted);font-weight:700;margin-bottom:12px" id="game-unit-label2"></div>

        <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:8px">BEPUL (+1 XP/to'g'ri javob)</div>
        <div class="games-grid" style="margin-bottom:18px">
          <div class="game-card" onclick="openModal('modal-match')">
            <div class="g-icon">üîó</div><div class="g-name">Word Match</div><div class="g-desc">Juftlashtir</div>
          </div>
          <div class="game-card" onclick="openModal('modal-anagram')">
            <div class="g-icon">üî§</div><div class="g-name">Hidden Word</div><div class="g-desc">Harflarni joylashtir</div>
          </div>
          <div class="game-card" onclick="openModal('modal-quiz')">
            <div class="g-icon">‚ùì</div><div class="g-name">Quiz</div><div class="g-desc">Savol-javob</div>
          </div>
        </div>

        <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.08em;color:var(--gold);margin-bottom:8px">üíé PREMIUM O'YINLAR</div>
        <div class="games-grid" style="margin-bottom:18px">
          <div class="game-card" onclick="openPremiumGame('survival')" style="position:relative">
            <div class="prem-lock">üíé</div>
            <div class="g-icon">‚ù§Ô∏è</div><div class="g-name">Survival</div><div class="g-desc">3 hayot</div>
          </div>
          <div class="game-card" onclick="openPremiumGame('daily')" style="position:relative">
            <div class="prem-lock">üíé</div>
            <div class="g-icon">üåü</div><div class="g-name">Daily Challenge</div><div class="g-desc">Kunlik</div>
          </div>
          <div class="game-card" onclick="openPremiumGame('weak')" style="position:relative">
            <div class="prem-lock">üíé</div>
            <div class="g-icon">‚ö†Ô∏è</div><div class="g-name">Zaif So'zlar</div><div class="g-desc">Qayta o'rgan</div>
          </div>
        </div>

        <div class="dc-card">
          <div style="font-size:12px;font-weight:800;color:var(--blue);margin-bottom:6px">üåü BUGUNGI MUSOBAQA</div>
          <div class="dc-timer" id="dc-countdown">--:--:--</div>
          <div class="dc-rank" id="dc-rank-preview">Bugun: 0 ball</div>
          <button onclick="openPremiumGame('daily')" style="width:100%;margin-top:10px;padding:10px;background:linear-gradient(135deg,var(--blue),var(--accent));border:none;border-radius:10px;color:white;font-weight:800;font-size:13px;cursor:pointer;font-family:'Nunito',sans-serif">Ishtirok etish ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- PREMIUM TAB -->
    <div id="tab-premium">
      <div class="sec">
        <div style="text-align:center;padding:10px 0 18px">
          <div style="font-size:48px;margin-bottom:8px">üíé</div>
          <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;background:linear-gradient(90deg,var(--gold),var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">Essential English PRO</div>
          <div style="font-size:12px;color:var(--muted);margin-top:4px">Barcha funksiyalarni oching</div>
        </div>

        <div id="prem-status-card" style="background:rgba(245,197,66,.08);border:1px solid rgba(245,197,66,.2);border-radius:14px;padding:12px 16px;margin-bottom:16px;text-align:center">
          <div style="font-size:13px;font-weight:800" id="prem-status-text">üîí Bepul rejim</div>
          <div style="font-size:11px;color:var(--muted);margin-top:3px" id="prem-status-sub">Premium sotib oling va barcha imkoniyatlardan foydalaning</div>
        </div>

        <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:10px">NIMA OLASIZ</div>
        <div style="display:flex;flex-direction:column;gap:7px;margin-bottom:18px">
          <div style="display:flex;align-items:center;gap:10px;background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:11px 14px"><span style="font-size:20px">üéÆ</span><div><div style="font-size:13px;font-weight:700">Survival Mode</div><div style="font-size:11px;color:var(--muted)">3 hayot bilan o'ynang</div></div><span style="margin-left:auto;color:var(--green)">‚úì</span></div>
          <div style="display:flex;align-items:center;gap:10px;background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:11px 14px"><span style="font-size:20px">üåü</span><div><div style="font-size:13px;font-weight:700">Daily Challenge</div><div style="font-size:11px;color:var(--muted)">Har kun yangi musobaqa</div></div><span style="margin-left:auto;color:var(--green)">‚úì</span></div>
          <div style="display:flex;align-items:center;gap:10px;background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:11px 14px"><span style="font-size:20px">‚ö†Ô∏è</span><div><div style="font-size:13px;font-weight:700">Zaif So'zlar</div><div style="font-size:11px;color:var(--muted)">Ko'p xato qilinganlar</div></div><span style="margin-left:auto;color:var(--green)">‚úì</span></div>
          <div style="display:flex;align-items:center;gap:10px;background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:11px 14px"><span style="font-size:20px">üë•</span><div><div style="font-size:13px;font-weight:700">Guruh Battle</div><div style="font-size:11px;color:var(--muted)">Do'stlar bilan jang</div></div><span style="margin-left:auto;color:var(--green)">‚úì</span></div>
          <div style="display:flex;align-items:center;gap:10px;background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:11px 14px"><span style="font-size:20px">üèÜ</span><div><div style="font-size:13px;font-weight:700">Haftalik Tournament</div><div style="font-size:11px;color:var(--muted)">Global reyting</div></div><span style="margin-left:auto;color:var(--green)">‚úì</span></div>
          <div style="display:flex;align-items:center;gap:10px;background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:11px 14px"><span style="font-size:20px">üéì</span><div><div style="font-size:13px;font-weight:700">Sertifikat</div><div style="font-size:11px;color:var(--muted)">Kitob tugaganda</div></div><span style="margin-left:auto;color:var(--green)">‚úì</span></div>
          <div style="display:flex;align-items:center;gap:10px;background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:11px 14px"><span style="font-size:20px">üìù</span><div><div style="font-size:13px;font-weight:700">Shaxsiy So'zlar</div><div style="font-size:11px;color:var(--muted)">O'z so'zlaringizni qo'shing</div></div><span style="margin-left:auto;color:var(--green)">‚úì</span></div>
          <!-- YANGI PREMIUM FUNKSIYALAR -->
          <div style="display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,rgba(245,197,66,.1),rgba(249,123,79,.06));border:1px solid rgba(245,197,66,.3);border-radius:12px;padding:11px 14px"><span style="font-size:20px">üéØ</span><div><div style="font-size:13px;font-weight:700">Streak Freeze</div><div style="font-size:11px;color:var(--muted)">Streakni yo'qotmaslik uchun</div></div><span style="margin-left:auto;color:var(--gold)">‚úì</span></div>
          <div style="display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,rgba(245,197,66,.1),rgba(249,123,79,.06));border:1px solid rgba(245,197,66,.3);border-radius:12px;padding:11px 14px"><span style="font-size:20px">üî•</span><div><div style="font-size:13px;font-weight:700">XP Boost</div><div style="font-size:11px;color:var(--muted)">24 soat 2√ó XP</div></div><span style="margin-left:auto;color:var(--gold)">‚úì</span></div>
          <div style="display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,rgba(245,197,66,.1),rgba(249,123,79,.06));border:1px solid rgba(245,197,66,.3);border-radius:12px;padding:11px 14px"><span style="font-size:20px">üé®</span><div><div style="font-size:13px;font-weight:700">Premium Avatarlar</div><div style="font-size:11px;color:var(--muted)">Eksklyuziv avatar kolleksiya</div></div><span style="margin-left:auto;color:var(--gold)">‚úì</span></div>
          <div style="display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,rgba(245,197,66,.1),rgba(249,123,79,.06));border:1px solid rgba(245,197,66,.3);border-radius:12px;padding:11px 14px"><span style="font-size:20px">üìä</span><div><div style="font-size:13px;font-weight:700">Batafsil Statistika</div><div style="font-size:11px;color:var(--muted)">Grafik va tahlil</div></div><span style="margin-left:auto;color:var(--gold)">‚úì</span></div>
          <div style="display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,rgba(245,197,66,.1),rgba(249,123,79,.06));border:1px solid rgba(245,197,66,.3);border-radius:12px;padding:11px 14px"><span style="font-size:20px">üåç</span><div><div style="font-size:13px;font-weight:700">Tarjimon Rejimi</div><div style="font-size:11px;color:var(--muted)">Kontekstli gaplar + audio</div></div><span style="margin-left:auto;color:var(--gold)">‚úì</span></div>
          <div style="display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,rgba(245,197,66,.1),rgba(249,123,79,.06));border:1px solid rgba(245,197,66,.3);border-radius:12px;padding:11px 14px"><span style="font-size:20px">‚è∞</span><div><div style="font-size:13px;font-weight:700">Kunlik Eslatma</div><div style="font-size:11px;color:var(--muted)">O'rganishni unutmang</div></div><span style="margin-left:auto;color:var(--gold)">‚úì</span></div>
          <div style="display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,rgba(245,197,66,.1),rgba(249,123,79,.06));border:1px solid rgba(245,197,66,.3);border-radius:12px;padding:11px 14px"><span style="font-size:20px">üèÖ</span><div><div style="font-size:13px;font-weight:700">Achievement Tizimi</div><div style="font-size:11px;color:var(--muted)">Yutuqlar va medallar</div></div><span style="margin-left:auto;color:var(--gold)">‚úì</span></div>
        </div>

        <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:10px">TARIF</div>
        <div class="plan-card" id="plan-monthly" onclick="selectPlan('monthly')">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div><div style="font-size:11px;font-weight:800;color:var(--muted);margin-bottom:3px">OYLIK</div><div class="plan-price">5 000 <span style="font-size:14px">so'm</span></div></div>
            <div style="text-align:right"><div style="font-size:11px;color:var(--muted)">~$0.45/oy</div><div style="font-size:11px;color:var(--green);margin-top:2px">Bekor qilish mumkin</div></div>
          </div>
        </div>
        <div class="plan-card selected" id="plan-3month" onclick="selectPlan('3month')">
          <div class="plan-badge">üî• Eng foydali</div>
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div><div style="font-size:11px;font-weight:800;color:var(--muted);margin-bottom:3px">3 OYLIK</div><div class="plan-price">10 000 <span style="font-size:14px">so'm</span></div></div>
            <div style="text-align:right"><div style="font-size:11px;color:var(--muted)">~$0.90 jami</div><div style="font-size:11px;color:var(--gold);margin-top:2px">33% chegirma!</div></div>
          </div>
        </div>

        <button onclick="buyPremium()" style="width:100%;padding:14px;background:linear-gradient(135deg,var(--gold),var(--orange));border:none;border-radius:14px;color:#080d14;font-size:16px;font-weight:800;font-family:'Nunito',sans-serif;cursor:pointer;margin-top:6px;margin-bottom:8px;box-shadow:0 6px 20px rgba(245,197,66,.25)">
          üí≥ Payme / Click orqali to'lash
        </button>
        <div style="text-align:center;font-size:11px;color:var(--muted)">üîí Xavfsiz to'lov ¬∑ Istalgan vaqt bekor qilish</div>

        <!-- PREMIUM TOOLS (agar premium bo'lsa) -->
        <div id="prem-tools" style="display:none;margin-top:20px">
          <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:10px">PREMIUM VOSITALAR</div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button onclick="openModal('modal-custom-words')" class="btn-s" style="text-align:left;display:flex;align-items:center;gap:10px"><span style="font-size:18px">üìù</span> Shaxsiy so'z qo'shish</button>
            <button onclick="openModal('modal-cert')" class="btn-s" style="text-align:left;display:flex;align-items:center;gap:10px"><span style="font-size:18px">üéì</span> Sertifikatlarim</button>
            <button onclick="openModal('modal-group')" class="btn-s" style="text-align:left;display:flex;align-items:center;gap:10px"><span style="font-size:18px">üë•</span> Guruh battle</button>
            <button onclick="openModal('modal-tournament')" class="btn-s" style="text-align:left;display:flex;align-items:center;gap:10px"><span style="font-size:18px">üèÜ</span> Haftalik tournament</button>
            <!-- YANGI PREMIUM TUGMALAR -->
            <button onclick="openStreakFreeze()" class="btn-s" style="text-align:left;display:flex;align-items:center;gap:10px;border-color:rgba(245,197,66,.3)"><span style="font-size:18px">üéØ</span> <span>Streak Freeze <span id="sf-count-badge" style="background:rgba(245,197,66,.2);color:var(--gold);font-size:10px;padding:2px 7px;border-radius:10px;margin-left:4px">0 ta</span></span></button>
            <button onclick="openXPBoost()" class="btn-s" style="text-align:left;display:flex;align-items:center;gap:10px;border-color:rgba(249,123,79,.3)"><span style="font-size:18px">üî•</span> <span>XP Boost <span id="xpboost-badge" style="background:rgba(249,123,79,.2);color:var(--orange);font-size:10px;padding:2px 7px;border-radius:10px;margin-left:4px">OFF</span></span></button>
            <button onclick="openModal('modal-stats-detail')" class="btn-s" style="text-align:left;display:flex;align-items:center;gap:10px;border-color:rgba(79,156,249,.3)"><span style="font-size:18px">üìä</span> Batafsil Statistika</button>
            <button onclick="openModal('modal-translator')" class="btn-s" style="text-align:left;display:flex;align-items:center;gap:10px;border-color:rgba(79,223,138,.3)"><span style="font-size:18px">üåç</span> Tarjimon Rejimi</button>
            <button onclick="openModal('modal-reminder')" class="btn-s" style="text-align:left;display:flex;align-items:center;gap:10px;border-color:rgba(192,132,252,.3)"><span style="font-size:18px">‚è∞</span> Kunlik Eslatma</button>
            <button onclick="openModal('modal-achievements')" class="btn-s" style="text-align:left;display:flex;align-items:center;gap:10px;border-color:rgba(245,197,66,.3)"><span style="font-size:18px">üèÖ</span> Achievementlar <span id="ach-new-badge" style="display:none;background:var(--red);color:white;font-size:10px;padding:2px 7px;border-radius:10px;margin-left:4px">Yangi!</span></button>
            <button onclick="openModal('modal-prem-avatar')" class="btn-s" style="text-align:left;display:flex;align-items:center;gap:10px;border-color:rgba(192,132,252,.3)"><span style="font-size:18px">üé®</span> Premium Avatarlar</button>
          </div>
        </div>
      </div>
    </div>

  </div>
  <div class="bottomnav">
    <button class="nav-b active" onclick="switchTab('home',this)"><span class="nav-b-icon">üè†</span><span class="nav-b-label">Bosh</span></button>
    <button class="nav-b" onclick="switchTab('games',this)"><span class="nav-b-icon">üéÆ</span><span class="nav-b-label">O'yinlar</span></button>
    <button class="nav-b" onclick="switchTab('progress',this)"><span class="nav-b-icon">üìä</span><span class="nav-b-label">Progress</span></button>
    <button class="nav-b" onclick="switchTab('battle',this)"><span class="nav-b-icon">‚öîÔ∏è</span><span class="nav-b-label">Jang</span></button>
    <button class="nav-b" onclick="switchTab('premium',this)"><span class="nav-b-icon">üíé</span><span class="nav-b-label">Premium</span></button>
  </div>
</div>

<!-- ==================== MODALS ==================== -->

<!-- WORDS LIST -->
<div class="overlay" id="modal-words" onclick="closeModal(event,'modal-words')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-words')">‚úï</div>
    <div class="sb">
      <div class="st">üìö So'zlar ro'yxati</div>
      <input type="text" class="sinp" placeholder="Qidirish..." oninput="filterWords(this.value)">
      <div id="wl-items"></div>
    </div>
  </div>
</div>

<!-- MATCH -->
<div class="overlay" id="modal-match" onclick="closeModal(event,'modal-match')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-match')">‚úï</div>
    <div class="sb">
      <div class="st">üîó Word Match</div>
      <div class="gsbar">
        <span>‚úÖ <span id="ms-score">0</span></span>
        <span>‚è± <span id="ms-time">30</span>s</span>
        <span>üîÑ <span id="ms-round">1</span>/5</span>
      </div>
      <div class="match-grid" id="mg"></div>
      <div id="mr" style="text-align:center;margin-top:12px;font-size:13px;color:var(--muted);min-height:18px"></div>
    </div>
  </div>
</div>

<!-- ANAGRAM / HIDDEN WORD -->
<div class="overlay" id="modal-anagram" onclick="closeModal(event,'modal-anagram')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-anagram')">‚úï</div>
    <div class="sb">
      <div class="st">üî§ Hidden Word</div>
      <div class="gsbar">
        <span>üéØ <span id="as-score">0</span></span>
        <span>‚è± <span id="as-time">60</span>s</span>
      </div>
      <div class="a-hint" id="a-hint">‚Äî</div>
      <div class="a-slots" id="a-slots"></div>
      <div class="a-letters" id="a-letters"></div>
      <div style="display:flex;gap:8px">
        <button class="btn-s" style="flex:1;margin:0" onclick="angClear()">üîÑ Tozalash</button>
        <button class="btn-p" style="flex:1;margin:0" onclick="angCheck()">‚úì Tekshirish</button>
      </div>
    </div>
  </div>
</div>

<!-- QUIZ -->
<div class="overlay" id="modal-quiz" onclick="closeModal(event,'modal-quiz')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-quiz')">‚úï</div>
    <div class="sb">
      <div class="st">‚ùì Quiz</div>
      <div class="gsbar">
        <span>‚úÖ <span id="qs-score">0</span></span>
        <span>‚ùå <span id="qs-wrong">0</span></span>
        <span>üìù <span id="qs-num">1</span>/10</span>
      </div>
      <div class="gword" id="qs-word">‚Äî</div>
      <div style="font-size:11px;color:var(--muted);font-weight:700;margin-bottom:8px">TARJIMANI TANLANG</div>
      <div class="gopts" id="qs-opts"></div>
      <div id="qs-res" style="margin-top:10px;text-align:center;font-size:13px;min-height:18px"></div>
    </div>
  </div>
</div>

<!-- GRAMMAR LEVEL SELECTOR -->
<div class="overlay" id="modal-gr-levels" onclick="closeModal(event,'modal-gr-levels')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-gr-levels')">‚úï</div>
    <div class="sb">
      <div class="st">üìñ Grammatika darajasi</div>
      <div style="display:flex;flex-direction:column;gap:9px">
        <div class="gr-item" onclick="switchGrLevel('beginner')">
          <div class="gr-ico">üå±</div>
          <div class="gr-txt"><div class="gr-title">Beginner</div><div class="gr-sub">10 ta mavzu ‚Äî barcha asosiy zamonlar</div></div>
          <span id="grl-b-check" style="color:var(--green);font-size:18px"></span>
        </div>
        <div class="gr-item" onclick="switchGrLevel('intermediate')">
          <div class="gr-ico">üî•</div>
          <div class="gr-txt"><div class="gr-title">Intermediate</div><div class="gr-sub">9 ta mavzu ‚Äî Conditionals, Modals, Passive</div></div>
          <span id="grl-i-check" style="color:var(--blue);font-size:18px"></span>
        </div>
        <div class="gr-item" onclick="switchGrLevel('advanced')">
          <div class="gr-ico">‚ö°</div>
          <div class="gr-txt"><div class="gr-title">Advanced</div><div class="gr-sub">7 ta mavzu ‚Äî Inversion, Cleft, Complex</div></div>
          <span id="grl-a-check" style="color:var(--purple);font-size:18px"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- GRAMMAR DETAIL -->
<div class="overlay" id="modal-grammar" onclick="closeModal(event,'modal-grammar')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-grammar')">‚úï</div>
    <div class="sb" id="gr-modal-body"></div>
  </div>
</div>

<!-- MATCHMAKING / FINDING OPPONENT -->
<div class="overlay" id="modal-matchmaking">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sb" style="text-align:center;padding-top:10px">
      <div class="match-status" id="mm-status">
        <span class="match-spinner" id="mm-spinner">üîç</span>
        <div style="font-size:16px;font-weight:800;margin-bottom:6px" id="mm-title">Raqib qidirilmoqda...</div>
        <div style="font-size:12px;color:var(--muted)" id="mm-sub">Online o'yinchilar qidirilmoqda</div>
      </div>
      <button class="btn-s" onclick="cancelMatchmaking()">‚úï Bekor qilish</button>
    </div>
  </div>
</div>

<!-- BATTLE GAME -->
<div class="overlay" id="modal-bg">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sb">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800">‚öîÔ∏è 1vs1 Jang</div>
        <div id="bg-opp-badge" style="font-size:11px;padding:3px 10px;border-radius:20px;background:rgba(248,81,73,.1);color:var(--red);font-weight:700"></div>
      </div>
      <div class="gsbar">
        <span>Siz: <b id="bg-my" style="color:var(--blue)">0</b></span>
        <span style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800" id="bg-time">30</span>
        <span>Raqib: <b id="bg-opp" style="color:var(--red)">0</b></span>
      </div>
      <div class="gword" id="bg-word">‚Äî</div>
      <div class="gopts" id="bg-opts"></div>
      <div id="bg-res" style="margin-top:10px;text-align:center;font-size:14px;min-height:20px"></div>
    </div>
  </div>
</div>

<!-- LEADERBOARD MODAL -->
<div class="overlay" id="modal-lb" onclick="closeModal(event,'modal-lb')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-lb')">‚úï</div>
    <div class="sb">
      <div class="st">üèÜ Global Reyting</div>
      <div class="lb-list" id="lb-modal"></div>
    </div>
  </div>
</div>

<script>
// ===== INIT =====
window.addEventListener('DOMContentLoaded', async ()=>{
  if(!U){ window.location.href='register.html'; return; }
  curBook = U.lastBook || 1;
  curUnitNum = U.lastUnit || 1;
  loadTopbar();
  buildBookRow();
  document.getElementById('unit-inp').value = curUnitNum;
  // Background da unitlarni aniqlash (barcha kitoblar uchun)
  updateUnitRange();
  await goToUnit();
  buildGrammarList();
  buildLeaderboard();
  buildBattleUI();
  updateStats();
  initPremiumFeatures();
});

function loadTopbar(){
  document.getElementById('tb-name').textContent = U.name;
  const badge = document.getElementById('tb-badge');
  badge.textContent = {beginner:'Beginner',intermediate:'Intermediate',advanced:'Advanced'}[U.level];
  badge.className = 'badge '+U.level;
  document.getElementById('tb-xp').textContent = U.xp+' XP';
  document.getElementById('tb-streak').textContent = U.streak;
  if(U.avatarUrl){
    document.getElementById('tb-av').innerHTML = `<img src="${U.avatarUrl}" style="width:80%;height:80%;object-fit:contain">`;
  }
}

// ============================================================
// BOOK & UNIT SYSTEM
// ============================================================
let curBook = 1;
let curUnitNum = 1;

// Sinxron yordamchi ‚Äî cache dan (fetch tugagandan keyin)
function getAllWordsForGames(){
  if(currentUnitWords.length >= 3) return currentUnitWords;
  const level = BOOK_LEVEL[curBook] || U.level;
  return getAllWordsFallback(level);
}

// ===== BOOK ROW =====
function buildBookRow(){
  const row = document.getElementById('book-row');
  row.innerHTML = '';
  [1,2,3,4,5,6].forEach(b=>{
    const lv = BOOK_LEVEL[b];
    const lvLabel = {beginner:'Beg.',intermediate:'Int.',advanced:'Adv.'}[lv];
    const el = document.createElement('div');
    el.className = 'unit-pill' + (b===curBook ? ' active':'');
    el.style.borderColor = b===curBook ? BOOK_COLORS[b] : '';
    el.style.color = b===curBook ? BOOK_COLORS[b] : '';
    el.style.background = b===curBook ? `rgba(0,0,0,.3)` : '';
    el.innerHTML = `üìó Kitob ${b} <span style="font-size:9px;opacity:.7">${lvLabel}</span>`;
    el.onclick = ()=> selectBook(b);
    row.appendChild(el);
  });
}

async function selectBook(b){
  curBook = b;
  curUnitNum = 1;
  document.getElementById('unit-inp').value = 1;
  buildBookRow();
  // Avval unit 1 ni yuklaymiz (tezkor)
  await goToUnit();
  // Background da unitlar sonini aniqlaymiz
  updateUnitRange();
}

// Unit range ni background da yangilaydi
function updateUnitRange(){
  document.getElementById('unit-range').textContent = `1‚Äì30`;
  document.getElementById('unit-inp').max = 30;
  detectUnitsInBook(curBook).then(units=>{
    if(units.length > 0){
      const max = Math.max(...units);
      document.getElementById('unit-range').textContent = `1‚Äì${max}`;
      document.getElementById('unit-inp').max = max;
    }
    buildQuickUnits();
  });
}

// Quick unit pills
function buildQuickUnits(){
  const quick = document.getElementById('unit-quick');
  const cacheKey = `book${curBook}_units`;
  const knownUnits = WORDS_CACHE[cacheKey] || [];
  // Agar hali aniqlanmagan bo'lsa, 1-5 ko'rsatamiz
  const showUnits = knownUnits.length > 0 ? knownUnits.slice(0,12) : [1,2,3,4,5];
  quick.innerHTML = '';
  showUnits.forEach(n=>{
    const el = document.createElement('div');
    el.className = 'unit-pill' + (n===curUnitNum?' active':'');
    const cached = WORDS_CACHE[`book${curBook}_unit${n}`] || [];
    const learned = cached.filter(w=>U.learnedWords.find(x=>x.word===w.word)).length;
    const isDone = cached.length > 0 && learned === cached.length;
    if(isDone) el.classList.add('done');
    el.innerHTML = (isDone?'‚úì ':'') + `Unit ${n}`;
    el.onclick = ()=>{
      curUnitNum = n;
      document.getElementById('unit-inp').value = n;
      goToUnit();
    };
    quick.appendChild(el);
  });
  if(knownUnits.length > 12){
    const more = document.createElement('div');
    more.className = 'unit-pill';
    more.textContent = `+${knownUnits.length-12} ta`;
    more.style.color = 'var(--muted)';
    quick.appendChild(more);
  }
}

function previewUnit(val){
  const n = parseInt(val);
  if(!n || n<1) return;
  curUnitNum = n;
  buildQuickUnits();
}

// Asosiy funksiya ‚Äî JSON dan fetch qilib unit so'zlarini yuklaydi
async function goToUnit(){
  const n = parseInt(document.getElementById('unit-inp').value) || 1;
  curUnitNum = n;

  // Loading holati
  document.getElementById('sel-title').textContent = `Kitob ${curBook} ¬∑ Unit ${n}`;
  document.getElementById('sel-sub').textContent = `‚è≥ Yuklanmoqda...`;
  document.getElementById('sel-done').textContent = '';
  const gl = document.getElementById('game-unit-label');
  if(gl) gl.textContent = `Kitob ${curBook} ¬∑ Unit ${n}`;

  // JSON dan yuklash
  const words = await fetchUnitWords(curBook, n);

  if(words === null){
    // Fayl topilmadi
    document.getElementById('sel-sub').textContent = `‚ö†Ô∏è Bu unit hali mavjud emas`;
    currentUnitWords = [];
    U.lastBook = curBook;
    U.lastUnit = n;
    saveUser();
    buildQuickUnits();
    return;
  }

  currentUnitWords = words;
  const learned = currentUnitWords.filter(w=>U.learnedWords.find(x=>x.word===w.word)).length;
  document.getElementById('sel-sub').textContent = `${currentUnitWords.length} ta so'z`;
  document.getElementById('sel-done').textContent = currentUnitWords.length > 0 ? `‚úì ${learned}/${currentUnitWords.length}` : '';

  U.lastBook = curBook;
  U.lastUnit = n;

  if(!currentUnitWords.length){
    showToast(`Kitob ${curBook}, Unit ${n} bo'sh`);
    saveUser();
    buildQuickUnits();
    return;
  }

  cardIdx = 0; cardFlipped = false;
  updateCard();
  saveUser();
  buildQuickUnits();
}

// ===== FLASHCARD =====
function updateCard(){
  if(!currentUnitWords.length) return;
  const w = currentUnitWords[cardIdx];
  document.getElementById('fc').classList.remove('flipped');
  cardFlipped = false;
  document.getElementById('fc-pos').textContent = w.part_of_speech;
  document.getElementById('fc-pos2').textContent = w.part_of_speech;
  document.getElementById('fc-utag').textContent = `Kitob ${curBook} ¬∑ Unit ${curUnitNum}`;
  document.getElementById('fc-word').textContent = w.word;
  document.getElementById('fc-trans').textContent = w.translation;
  document.getElementById('fc-def').textContent = w.definition;
  document.getElementById('fc-eg').textContent = `"${w.example}"`;
  document.getElementById('fc-count').textContent = `${cardIdx+1} / ${currentUnitWords.length}`;
  updateProgress();
}
function flipCard(){
  cardFlipped = !cardFlipped;
  document.getElementById('fc').classList.toggle('flipped', cardFlipped);
  if(cardFlipped) learnWord(currentUnitWords[cardIdx]);
}
function nextCard(){ cardIdx = (cardIdx+1) % currentUnitWords.length; updateCard(); }
function prevCard(){ cardIdx = (cardIdx-1+currentUnitWords.length) % currentUnitWords.length; updateCard(); }
function speakWord(){
  const w = currentUnitWords[cardIdx];
  if(!w) return;
  speakText(w.word);
}

// Universal TTS ‚Äî avval Web Speech API, keyin Google TTS fallback
function speakText(text){
  if(!text) return;

  // 1. Web Speech API (Chrome, Safari da ishlaydi)
  if('speechSynthesis' in window){
    speechSynthesis.cancel();

    const trySpeak = ()=>{
      const voices = speechSynthesis.getVoices();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-US';
      u.rate = 0.85;
      u.pitch = 1;
      u.volume = 1;

      // Eng yaxshi ovozni tanlaymiz
      const best = voices.find(v=>v.lang==='en-US' && v.name.toLowerCase().includes('google'))
        || voices.find(v=>v.lang==='en-US' && !v.localService)
        || voices.find(v=>v.lang==='en-US')
        || voices.find(v=>v.lang.startsWith('en'));

      if(best) u.voice = best;

      u.onerror = ()=> googleTTS(text); // Xato bo'lsa Google TTS
      speechSynthesis.speak(u);

      // Agar 1 sekunddan keyin ham gapirmasa ‚Äî Google TTS
      setTimeout(()=>{
        if(!speechSynthesis.speaking && !speechSynthesis.pending){
          googleTTS(text);
        }
      }, 1000);
    };

    if(speechSynthesis.getVoices().length > 0){
      trySpeak();
    } else {
      speechSynthesis.onvoiceschanged = ()=>{
        trySpeak();
        speechSynthesis.onvoiceschanged = null;
      };
      // 500ms da ham yuklanmasa
      setTimeout(()=>{
        if(speechSynthesis.getVoices().length === 0) googleTTS(text);
      }, 500);
    }
  } else {
    googleTTS(text);
  }
}

// Google Translate TTS (fallback)
function googleTTS(text){
  try {
    const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=en&client=tw-ob`;
    const audio = new Audio(url);
    audio.volume = 1;
    audio.play().catch(()=> showToast('üîá Audio ishlamadi'));
  } catch(e){
    showToast('üîá Audio ishlamadi');
  }
}

window.addEventListener('DOMContentLoaded',()=>{
  if('speechSynthesis' in window) speechSynthesis.getVoices();
});
function learnWord(w){
  if(!U.learnedWords.find(x=>x.word===w.word)){
    U.learnedWords.push(w);
    addXP(1);
    saveUser();
    updateStats();
  }
}

// ===== PROGRESS =====
function updateProgress(){
  // Hozirgi unit asosida progress ko'rsatamiz
  const total = currentUnitWords.length || 0;
  const n = currentUnitWords.filter(w=>U.learnedWords.find(x=>x.word===w.word)).length;
  document.getElementById('prog-val').textContent = `${n} / ${total}`;
  document.getElementById('prog-fill').style.width = total ? (n/total*100)+'%' : '0%';
}
function updateStats(){
  document.getElementById('st-words').textContent = U.learnedWords.length;
  document.getElementById('st-streak').textContent = U.streak;
  document.getElementById('st-xp').textContent = U.xp;
  document.getElementById('tb-xp').textContent = U.xp+' XP';
  buildRecentWords();
  buildLeaderboard();
  updateProgress();
}
function addXP(n){
  U.xp += n;
  showXP('+'+n+' XP');
  saveUser();
  document.getElementById('tb-xp').textContent = U.xp+' XP';
}
function saveUser(){ sessionStorage.setItem('ep_user', JSON.stringify(U)); }
function showXP(txt){
  const el=document.createElement('div');el.className='xp-pop';el.textContent=txt;
  document.body.appendChild(el);setTimeout(()=>el.remove(),2100);
}
function showToast(msg){
  const t=document.createElement('div');t.className='toast';t.textContent=msg;
  document.body.appendChild(t);setTimeout(()=>t.remove(),2600);
}

// ===== GRAMMAR =====
function buildGrammarList(){
  const level = U.grammarLevel || U.level || 'beginner';
  buildGrammarListForLevel(level);
  const map={beginner:'b',intermediate:'i',advanced:'a'};
  setTimeout(()=>{
    const el = document.getElementById('grl-'+map[level]+'-check');
    if(el) el.textContent='‚úì';
  },100);
}

function switchGrLevel(level){
  ['b','i','a'].forEach(x=>{ const el=document.getElementById('grl-'+x+'-check'); if(el) el.textContent=''; });
  const map={beginner:'b',intermediate:'i',advanced:'a'};
  const el=document.getElementById('grl-'+map[level]+'-check');
  if(el) el.textContent='‚úì';
  U.grammarLevel = level;
  saveUser();
  buildGrammarListForLevel(level);
  closeModal(null,'modal-gr-levels');
  showToast({beginner:'üå± Beginner',intermediate:'üî• Intermediate',advanced:'‚ö° Advanced'}[level]+' tanlandi');
}

function buildGrammarListForLevel(level){
  const list = document.getElementById('gr-list');
  list.innerHTML='';
  const data = GRAMMAR_DATA[level] || GRAMMAR_DATA.beginner;
  const levelColors = {beginner:'var(--green)',intermediate:'var(--blue)',advanced:'var(--purple)'};
  const levelNames  = {beginner:'Beginner',intermediate:'Intermediate',advanced:'Advanced'};

  const hdr = document.createElement('div');
  hdr.style='display:flex;align-items:center;justify-content:space-between;margin-bottom:10px';
  hdr.innerHTML=`
    <span style="font-size:12px;font-weight:700;color:var(--muted)">${data.length} ta mavzu</span>
    <span style="font-size:11px;font-weight:800;padding:3px 10px;border-radius:20px;background:rgba(0,0,0,.3);color:${levelColors[level]};border:1px solid ${levelColors[level]}">${levelNames[level]}</span>
  `;
  list.appendChild(hdr);

  data.forEach((g,i)=>{
    const el=document.createElement('div');
    el.className='gr-item';
    el.innerHTML=`
      <div class="gr-ico">${g.icon}</div>
      <div class="gr-txt"><div class="gr-title">${g.title}</div><div class="gr-sub">${g.sub}</div></div>
      <span style="color:var(--muted);font-size:18px">‚Ä∫</span>`;
    el.onclick=()=>openGrammarFromLevel(level,i);
    list.appendChild(el);
  });
}

function openGrammarFromLevel(level,i){
  const data = GRAMMAR_DATA[level];
  const g = data[i];
  const formulasHtml = g.formulas.map(f=>`
    <div style="display:flex;align-items:flex-start;gap:8px;margin-bottom:6px">
      <span style="font-size:10px;font-weight:800;color:var(--muted);min-width:90px;text-transform:uppercase;letter-spacing:.04em;padding-top:7px">${f.label}</span>
      <span style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:var(--blue);flex:1">${f.f}</span>
    </div>`).join('');
  const keysHtml = g.keys.map(k=>
    `<span style="background:rgba(124,90,246,.12);border:1px solid rgba(124,90,246,.2);color:var(--al);padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700">${k}</span>`
  ).join(' ');
  document.getElementById('gr-modal-body').innerHTML=`
    <div class="st">${g.icon} ${g.title}</div>
    <div style="color:var(--muted);font-size:12px;margin-bottom:14px">${g.sub}</div>
    <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);margin-bottom:8px">üìê FORMULALAR</div>
    <div style="margin-bottom:14px">${formulasHtml}</div>
    <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);margin-bottom:8px">‚ÑπÔ∏è QOIDA</div>
    <div class="gr-rule">${g.rules.replace(/\n/g,'<br>')}</div>
    <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);margin-bottom:8px">üîë KALIT SO'ZLAR</div>
    <div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:14px">${keysHtml}</div>
    <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);margin-bottom:8px">üí¨ MISOLLAR</div>
    ${g.examples.map(e=>`<div class="gr-eg">${e}</div>`).join('')}
    <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);margin:14px 0 8px">üß™ MINI TEST</div>
    <div style="background:var(--s2);border-radius:12px;padding:12px 14px;font-size:14px;font-weight:700;margin-bottom:10px;line-height:1.5">${g.quiz.q}</div>
    <div id="gr-opts" style="display:flex;flex-direction:column;gap:7px">
      ${g.quiz.opts.map((o,idx)=>`<button class="qopt" onclick="answerGr(${idx},${g.quiz.ans},this)">${o}</button>`).join('')}
    </div>
    <div id="gr-res" style="margin-top:10px;text-align:center;font-size:13px;min-height:18px"></div>
  `;
  openModal('modal-grammar');
}

function answerGr(idx,ans,el){
  document.querySelectorAll('#gr-opts .qopt').forEach(o=>o.onclick=null);
  const res = document.getElementById('gr-res');
  if(idx===ans){
    el.classList.add('correct');
    addXP(1);
    res.innerHTML='<span style="color:var(--green)">‚úÖ To\'g\'ri! +1 XP</span>';
  } else {
    el.classList.add('wrong');
    const opts = document.querySelectorAll('#gr-opts .qopt');
    if(opts[ans]) opts[ans].classList.add('correct');
    res.innerHTML='<span style="color:var(--red)">‚ùå Noto\'g\'ri</span>';
  }
}

// ===== LEADERBOARD =====
function buildLeaderboard(){
  const myEntry = {name:U.name, xp:U.xp, isMe:true, av:U.avatarUrl||'ü§ñ'};
  let lb = [...FAKE_LB.map(x=>({...x,isMe:false})), myEntry].sort((a,b)=>b.xp-a.xp);
  ['lb-main','lb-modal'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    el.innerHTML='';
    lb.slice(0,8).forEach((p,i)=>{
      const rankColors=['#f5c542','#8b949e','#b08040'];
      const medals=['ü•á','ü•à','ü•â'];
      const av = typeof p.av==='string'&&(p.av.startsWith('http')||p.av.startsWith('data'))
        ? `<img src="${p.av}" style="width:80%;height:80%;object-fit:contain">`
        : (p.av||'ü§ñ');
      const div=document.createElement('div');
      div.className='lb-row'+(p.isMe?' me':'');
      div.innerHTML=`
        <div class="lb-rank" style="color:${rankColors[i]||'var(--muted)'}">${i<3?medals[i]:i+1}</div>
        <div class="lb-av">${av}</div>
        <div class="lb-name">${p.name}${p.isMe?' (Siz)':''}</div>
        <div class="lb-xp">${p.xp} XP</div>
      `;
      el.appendChild(div);
    });
  });
}

function buildRecentWords(){
  const el=document.getElementById('recent-wl'); if(!el) return;
  if(!U.learnedWords.length){el.innerHTML='<div style="color:var(--muted);font-size:13px">Hali so\'z o\'rganilmagan.</div>';return;}
  el.innerHTML='';
  U.learnedWords.slice(-5).reverse().forEach(w=>{
    el.innerHTML+=`<div class="wl-item"><div><div class="wl-w">${w.word}</div><div class="wl-t">${w.translation}</div></div><div class="wl-p">${w.part_of_speech}</div></div>`;
  });
}

// ===== WORD LIST MODAL =====
function filterWords(q){
  const all = currentUnitWords.length > 0
    ? currentUnitWords
    : getAllWordsFallback(BOOK_LEVEL[curBook] || U.level);
  const items=document.getElementById('wl-items'); items.innerHTML='';
  const filtered = q ? all.filter(w=>w.word.toLowerCase().includes(q.toLowerCase())||w.translation.includes(q)) : all;
  if(!filtered.length){items.innerHTML='<div style="color:var(--muted);font-size:13px;text-align:center;padding:20px">So\'z topilmadi</div>';return;}
  filtered.forEach(w=>{
    items.innerHTML+=`<div class="wl-item"><div><div class="wl-w">${w.word}</div><div class="wl-t">${w.translation}</div></div><div class="wl-p">${w.part_of_speech}</div></div>`;
  });
}

// ===== MATCH GAME =====
let MS={sel:null,matched:0,score:0,round:1,rounds:5,timer:null,tval:30,pool:[],usedIdx:0};
function initMatch(){
  const words = getAllWordsForGames();
  if(words.length < 4){ showToast('Kamida 4 ta so\'z kerak!'); return; }
  const shuffled = shuffle([...words]);
  const rounds = Math.floor(shuffled.length / 4); // har roundda 4 so'z
  MS={sel:null,matched:0,score:0,round:1,rounds:Math.max(rounds,1),
      timer:null,tval:30,pool:shuffled,usedIdx:0};
  document.getElementById('ms-score').textContent=0;
  document.getElementById('ms-round').textContent=1;
  buildMatchRound();
  startMatchTimer();
}
function buildMatchRound(){
  MS.sel=null; MS.matched=0;
  const start = MS.usedIdx;
  const end = Math.min(start+4, MS.pool.length);
  let pool = MS.pool.slice(start, end);
  if(pool.length < 4) pool = shuffle([...getAllWordsForGames()]).slice(0,4);

  const grid=document.getElementById('mg'); grid.innerHTML='';

  // Chap ustun: inglizcha, o'ng ustun: o'zbekcha ‚Äî ikkalasi alohida shuffle
  const enWords = shuffle([...pool]);
  const uzWords = shuffle([...pool]);

  // 2 ustunli grid: chap=EN, o'ng=UZ
  enWords.forEach((w,i)=>{
    // Chap ‚Äî inglizcha
    const elEn = document.createElement('div');
    elEn.className='mw'; elEn.textContent=w.word; elEn.dataset.match=w.word;
    elEn.style.borderColor='rgba(79,156,249,.3)';
    elEn.onclick=()=>selectMatch(elEn, w.word);
    grid.appendChild(elEn);

    // O'ng ‚Äî o'zbekcha
    const uz = uzWords[i];
    const elUz = document.createElement('div');
    elUz.className='mw'; elUz.textContent=uz.translation; elUz.dataset.match=uz.word;
    elUz.style.borderColor='rgba(192,132,252,.3)';
    elUz.onclick=()=>selectMatch(elUz, uz.word);
    grid.appendChild(elUz);
  });

  // Ustun sarlavhalari qo'shamiz
  const label = document.getElementById('mr');
  label.innerHTML='<span style="color:var(--blue);font-weight:800">üá¨üáß English</span> ‚Üî <span style="color:var(--purple);font-weight:800">üá∫üáø O\'zbek</span>';
}
function selectMatch(el,match){
  if(MS.tval<=0) return; // Vaqt tugagan bo'lsa harakat qilmaslik
  if(el.classList.contains('matched')) return;
  if(!MS.sel){MS.sel={el,match};el.classList.add('selected');}
  else{
    if(MS.sel.el===el){MS.sel.el.classList.remove('selected');MS.sel=null;return;}
    if(MS.sel.match===match){
      el.classList.add('matched');MS.sel.el.classList.remove('selected');MS.sel.el.classList.add('matched');
      MS.matched++;MS.score+=10;MS.sel=null;
      addXP(1);
      document.getElementById('ms-score').textContent=MS.score;
      if(MS.matched===4){
        MS.usedIdx+=4; // Keyingi 4 so'zga o'tamiz
        if(MS.round < MS.rounds){
          MS.round++;
          document.getElementById('ms-round').textContent=MS.round;
          setTimeout(buildMatchRound,600);
        } else {
          clearInterval(MS.timer);
          document.getElementById('mr').textContent=`üéâ Tugadi! ${MS.score} ball!`;
        }
      }
    } else {
      el.classList.add('bad');MS.sel.el.classList.add('bad');
      setTimeout(()=>{el.classList.remove('bad','selected');MS.sel.el.classList.remove('bad','selected');MS.sel=null;},700);
    }
  }
}
function startMatchTimer(){
  MS.tval=30; clearInterval(MS.timer);
  MS.timer=setInterval(()=>{
    MS.tval--;
    document.getElementById('ms-time').textContent=MS.tval;
    if(MS.tval<=0){
      clearInterval(MS.timer);
      // Barcha kartochkalarni o'chirib, tugadi xabarini ko'rsatamiz
      document.getElementById('mg').querySelectorAll('.mw:not(.matched)').forEach(el=>{
        el.style.opacity='0.3'; el.style.pointerEvents='none';
      });
      document.getElementById('mr').textContent=`‚è± Vaqt tugadi! ${MS.score} ball`;
    }
  },1000);
}

// ===== ANAGRAM / HIDDEN WORD =====
let AS={word:'',answer:[],letters:[],usedIdx:[],score:0,timer:null,tval:0,pool:[],poolIdx:0};
function initAnagram(){
  const words = getAllWordsForGames().filter(w=>w.word.length>=3&&w.word.length<=8);
  if(!words.length){ showToast('Mos so\'zlar yo\'q!'); return; }
  const shuffled = shuffle([...words]);
  AS={word:'',answer:[],letters:[],usedIdx:[],score:0,timer:null,
      tval:60,pool:shuffled,poolIdx:0};
  document.getElementById('as-score').textContent=0;
  buildAnagramRound();
  startAngTimer();
}
function buildAnagramRound(){
  if(AS.poolIdx >= AS.pool.length){
    // Hammasi tugadi ‚Äî qaytadan boshlaymiz (lekin shuffle bilan)
    AS.pool = shuffle([...AS.pool]);
    AS.poolIdx = 0;
  }
  const w = AS.pool[AS.poolIdx];
  AS.poolIdx++;
  AS.word=w.word; AS.answer=[]; AS.usedIdx=[];
  // Harflar aralashib ketmasligi uchun ‚Äî asl so'zdan farqli bo'lmaguncha shuffle
  let letters = w.word.split('');
  let shuffled = shuffle([...letters]);
  let attempts = 0;
  while(shuffled.join('')===w.word && attempts<10){
    shuffled = shuffle([...letters]);
    attempts++;
  }
  AS.letters = shuffled;
  document.getElementById('a-hint').textContent=w.translation;
  renderAngLetters(); renderAngSlots();
}
function renderAngLetters(){
  const c=document.getElementById('a-letters');c.innerHTML='';
  AS.letters.forEach((l,i)=>{
    const el=document.createElement('div');
    el.className='a-tile'+(AS.usedIdx.includes(i)?' used':'');
    el.textContent=l;
    el.onclick=()=>{
      if(AS.tval<=0||AS.usedIdx.includes(i))return;
      AS.usedIdx.push(i);AS.answer.push({char:l,idx:i});
      renderAngLetters();renderAngSlots();
    };
    c.appendChild(el);
  });
}
function renderAngSlots(){
  const c=document.getElementById('a-slots');c.innerHTML='';
  AS.word.split('').forEach((_,i)=>{
    const el=document.createElement('div');el.className='a-slot';
    if(AS.answer[i]){
      el.textContent=AS.answer[i].char;
      el.onclick=()=>{
        if(AS.tval<=0)return;
        const rem=AS.answer.splice(i,1)[0];
        AS.usedIdx=AS.usedIdx.filter(x=>x!==rem.idx);
        renderAngLetters();renderAngSlots();
      };
    }
    c.appendChild(el);
  });
}
function angClear(){
  if(AS.tval<=0)return;
  AS.answer=[];AS.usedIdx=[];renderAngLetters();renderAngSlots();
}
function angCheck(){
  if(AS.tval<=0)return;
  const ans=AS.answer.map(x=>x.char).join('');
  if(ans===AS.word){
    AS.score+=20;document.getElementById('as-score').textContent=AS.score;
    addXP(1);showToast('‚úÖ To\'g\'ri! +1 XP');
    setTimeout(buildAnagramRound,800);
  } else {showToast('‚ùå Noto\'g\'ri, qaytadan!');angClear();}
}
function startAngTimer(){
  AS.tval=60; clearInterval(AS.timer);
  AS.timer=setInterval(()=>{
    AS.tval--;
    document.getElementById('as-time').textContent=AS.tval;
    if(AS.tval<=0){
      clearInterval(AS.timer);
      // Harflarni o'chiramiz
      document.getElementById('a-letters').querySelectorAll('.a-tile').forEach(el=>{
        el.style.opacity='0.3'; el.style.pointerEvents='none';
      });
      // To'g'ri javobni ko'rsatamiz
      document.getElementById('a-hint').textContent=`‚è± Vaqt tugadi! Javob: "${AS.word}" ¬∑ ${AS.score} ball`;
    }
  },1000);
}

// ===== QUIZ =====
let QS={idx:0,score:0,wrong:0,answered:false,pool:[],timer:null,tval:0};
function initQuiz(){
  const words = getAllWordsForGames();
  if(words.length < 4){ showToast('Kamida 4 ta so\'z kerak!'); return; }
  // Barcha so'zlarni shuffle qilib pool ga yozamiz ‚Äî takrorlash yo'q
  const shuffled = shuffle([...words]);
  const total = shuffled.length;
  const timeTotal = total * 8; // har so'z uchun 8 sekund
  QS={idx:0,score:0,wrong:0,answered:false,pool:shuffled,timer:null,tval:timeTotal};
  document.getElementById('qs-score').textContent=0;
  document.getElementById('qs-wrong').textContent=0;
  // Timer qo'shamiz
  startQuizTimer(timeTotal);
  buildQuizQ();
}
function startQuizTimer(total){
  clearInterval(QS.timer);
  QS.tval = total;
  // Timer display uchun gsbar ga qo'shamiz
  const bar = document.querySelector('#modal-quiz .gsbar');
  if(bar && !document.getElementById('qs-time')){
    const t = document.createElement('span');
    t.innerHTML = `‚è± <span id="qs-time">${total}</span>s`;
    bar.appendChild(t);
  } else if(document.getElementById('qs-time')){
    document.getElementById('qs-time').textContent = total;
  }
  QS.timer = setInterval(()=>{
    QS.tval--;
    const el = document.getElementById('qs-time');
    if(el) el.textContent = QS.tval;
    if(QS.tval <= 0){ clearInterval(QS.timer); endQuiz('time'); }
  },1000);
}
function endQuiz(reason){
  clearInterval(QS.timer);
  document.getElementById('qs-word').textContent = reason==='time' ? '‚è± Vaqt tugadi!' : 'üéâ Tugadi!';
  document.getElementById('qs-opts').innerHTML=`<div style="grid-column:1/-1;text-align:center;font-weight:800;color:var(--green)">Ball: ${QS.score}/${QS.pool.length}</div>`;
  document.getElementById('qs-res').textContent='';
}
function buildQuizQ(){
  if(QS.idx >= QS.pool.length){ endQuiz('done'); return; }
  QS.answered=false;
  const correct = QS.pool[QS.idx];
  // Noto'g'ri variantlarni boshqa so'zlardan olamiz
  const others = shuffle(getAllWordsForGames().filter(w=>w.word!==correct.word));
  if(others.length < 3){ showToast('Kamida 4 ta so\'z kerak!'); return; }
  const opts = shuffle([correct, ...others.slice(0,3)]);
  document.getElementById('qs-word').textContent = correct.word;
  document.getElementById('qs-num').textContent = `${QS.idx+1}/${QS.pool.length}`;
  document.getElementById('qs-res').textContent = '';
  const c = document.getElementById('qs-opts'); c.innerHTML='';
  opts.forEach(o=>{
    const el=document.createElement('div'); el.className='gopt'; el.textContent=o.translation;
    el.onclick=()=>{
      if(QS.answered)return; QS.answered=true;
      if(o.word===correct.word){
        el.classList.add('correct'); QS.score++;
        addXP(1);
        document.getElementById('qs-score').textContent=QS.score;
        document.getElementById('qs-res').textContent='‚úÖ To\'g\'ri! +1 XP';
      } else {
        el.classList.add('wrong'); QS.wrong++;
        document.getElementById('qs-wrong').textContent=QS.wrong;
        document.getElementById('qs-res').textContent='‚ùå Noto\'g\'ri';
        c.querySelectorAll('.gopt').forEach(op=>{if(op.textContent===correct.translation)op.classList.add('correct');});
      }
      setTimeout(()=>{ QS.idx++; buildQuizQ(); },900);
    };
    c.appendChild(el);
  });
}

// ===== BATTLE =====
let BT={timer:null,myScore:0,oppScore:0,time:30,answered:false,isBot:false,opp:null};

function buildBattleUI(){
  document.getElementById('bh-me-name').textContent = U.name;
  if(U.avatarUrl){
    document.getElementById('bh-me-av').innerHTML=`<img src="${U.avatarUrl}" style="width:80%;height:80%;object-fit:contain">`;
  }
  document.getElementById('bw').textContent=U.battleWins||0;
  document.getElementById('bl').textContent=U.battleLosses||0;
  document.getElementById('bxp').textContent=U.battleXP||0;
}

// Online raqib qidirish
let mmTimer=null;
function findOpponent(){
  openModal('modal-matchmaking');
  document.getElementById('mm-title').textContent = 'Raqib qidirilmoqda...';
  document.getElementById('mm-sub').textContent = 'Online o\'yinchilar qidirilmoqda';
  document.getElementById('mm-spinner').style.animationDuration = '1s';

  let elapsed = 0;
  mmTimer = setInterval(()=>{
    elapsed++;
    if(elapsed < 3){
      document.getElementById('mm-sub').textContent = `${elapsed * 32}% qidirildi...`;
    } else {
      clearInterval(mmTimer);
      // Tasodifiy online o'yinchi "topish" ehtimoli 60%
      const foundOnline = Math.random() < 0.6;
      if(foundOnline){
        const opp = ONLINE_PLAYERS[Math.floor(Math.random()*ONLINE_PLAYERS.length)];
        document.getElementById('mm-spinner').textContent = '‚úÖ';
        document.getElementById('mm-spinner').style.animationDuration = '0s';
        document.getElementById('mm-title').textContent = `${opp.name} topildi!`;
        document.getElementById('mm-sub').textContent = 'Jang boshlanmoqda...';
        setTimeout(()=>{
          closeModal(null,'modal-matchmaking');
          startBattleWith(opp, false);
        }, 1200);
      } else {
        // Robot bilan
        document.getElementById('mm-spinner').textContent = 'ü§ñ';
        document.getElementById('mm-spinner').style.animationDuration = '0s';
        document.getElementById('mm-title').textContent = 'Raqib topilmadi';
        document.getElementById('mm-sub').textContent = 'Robot bilan o\'ynaysiz...';
        setTimeout(()=>{
          closeModal(null,'modal-matchmaking');
          startBotBattle();
        }, 1200);
      }
    }
  }, 1000);
}

function cancelMatchmaking(){
  clearInterval(mmTimer);
  closeModal(null,'modal-matchmaking');
}

function startBotBattle(){
  const bot = {name:'AI Bot ü§ñ', av:'ü§ñ', xp: U.xp + Math.floor(Math.random()*500-250)};
  startBattleWith(bot, true);
}

function startBattleWith(opp, isBot){
  const words = getAllWordsForGames();
  if(words.length < 3){ showToast('Kamida 3 ta so\'z kerak!'); return; }
  const shuffled = shuffle([...words]);
  BT={timer:null,myScore:0,oppScore:0,myXP:0,
      time:60,answered:false,
      isBot:isBot,opp:opp,botTick:0,
      pool:shuffled,poolIdx:0};
  document.getElementById('bg-my').textContent=0;
  document.getElementById('bg-opp').textContent=0;
  document.getElementById('bg-time').textContent=60;
  document.getElementById('bh-opp-name').textContent = opp.name;
  document.getElementById('bh-opp-av').innerHTML = typeof opp.av==='string'&&(opp.av.startsWith('http')||opp.av.startsWith('data'))
    ? `<img src="${opp.av}" style="width:80%;height:80%;object-fit:contain">` : opp.av;
  document.getElementById('bg-opp-badge').textContent = isBot ? 'ü§ñ Bot' : 'üü¢ Online';

  buildBattleQ();
  openModal('modal-bg');
  clearInterval(BT.timer);
  BT.timer=setInterval(()=>{
    BT.time--;
    const tc = document.getElementById('bg-time');
    tc.textContent=BT.time;
    if(BT.time<=10) tc.style.color='var(--red)';
    else if(BT.time<=20) tc.style.color='var(--gold)';
    else tc.style.color='var(--text)';

    // Bot: har 3 sekundda 1 ball
    if(isBot){
      BT.botTick=(BT.botTick||0)+1;
      if(BT.botTick%3===0){
        BT.oppScore++;
        document.getElementById('bg-opp').textContent=BT.oppScore;
        document.getElementById('bg-res').textContent='ü§ñ ‚úÖ';
        setTimeout(()=>{ const r=document.getElementById('bg-res'); if(r&&r.textContent==='ü§ñ ‚úÖ') r.textContent=''; },500);
      }
    } else {
      if(Math.random()<0.04){ BT.oppScore++; document.getElementById('bg-opp').textContent=BT.oppScore; }
    }
    if(BT.time<=0){ clearInterval(BT.timer); endBattle(); }
  },1000);
}

function buildBattleQ(){
  // Pool tugagan bo'lsa ‚Äî o'yin tugaydi
  if(BT.poolIdx >= BT.pool.length){
    clearInterval(BT.timer);
    endBattle();
    return;
  }
  BT.answered=false;
  const correct = BT.pool[BT.poolIdx];
  // Noto'g'ri variantlarni boshqa so'zlardan olamiz
  const others = shuffle(getAllWordsForGames().filter(w=>w.word!==correct.word));
  if(others.length < 2){ showToast('Kamida 3 ta so\'z kerak!'); return; }
  const opts = shuffle([correct, ...others.slice(0,2)]);
  document.getElementById('bg-word').textContent=correct.word;
  document.getElementById('bg-res').textContent='';
  const c=document.getElementById('bg-opts'); c.innerHTML='';
  opts.forEach(o=>{
    const el=document.createElement('div'); el.className='gopt'; el.textContent=o.translation;
    el.onclick=()=>{
      if(BT.answered)return; BT.answered=true;
      if(o.word===correct.word){
        el.classList.add('correct'); BT.myScore++;
        BT.myXP++; addXP(1);
        document.getElementById('bg-my').textContent=BT.myScore;
        document.getElementById('bg-res').textContent='‚úÖ +1 XP';
      } else {
        el.classList.add('wrong');
        c.querySelectorAll('.gopt').forEach(op=>{if(op.textContent===correct.translation)op.classList.add('correct');});
        document.getElementById('bg-res').textContent='‚ùå';
      }
      BT.poolIdx++;
      setTimeout(()=>{ if(BT.time>0) buildBattleQ(); },700);
    };
    c.appendChild(el);
  });
}

function endBattle(){
  const won=BT.myScore>BT.oppScore;
  if(won){
    U.battleWins=(U.battleWins||0)+1;
    // G'alaba: faqat to'plangan XP (har to'g'ri javob 1 XP, allaqachon addXP qilingan)
    showToast(`üèÜ G'alaba! ${BT.myXP} XP to'plandi`);
  } else {
    U.battleLosses=(U.battleLosses||0)+1;
    // Mag'lubiyat: XP berilmaydi (allaqachon to'plangan XP o'chirilmaydi ham)
    showToast(`üí™ Keyingisida yaxshiroq! Jami: ${BT.myScore}:${BT.oppScore}`);
  }
  U.battleXP=(U.battleXP||0)+BT.myXP;
  saveUser();
  document.getElementById('bg-res').textContent=won?`üèÜ G'ALABA! ${BT.myScore}:${BT.oppScore}`:`üòû ${BT.myScore}:${BT.oppScore}`;
  document.getElementById('bg-opts').innerHTML=`<button class="btn-p" style="grid-column:1/-1" onclick="closeModal(null,'modal-bg');buildBattleUI();buildLeaderboard()">‚Üê Qaytish</button>`;
  document.getElementById('bh-me-s').textContent=BT.myScore;
  document.getElementById('bh-opp-s').textContent=BT.oppScore;
}

// ===== TABS =====
function switchTab(name,btn){
  document.querySelectorAll('.tab-pages>div').forEach(d=>d.classList.remove('active'));
  document.querySelectorAll('.nav-b').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  btn.classList.add('active');
  if(name==='progress'){buildLeaderboard();buildRecentWords();updateStats();}
  if(name==='battle'){buildBattleUI();}
}

// ===== MODALS =====
function openModal(id){
  document.getElementById(id).classList.add('open');
  if(id==='modal-match') initMatch();
  if(id==='modal-anagram') initAnagram();
  if(id==='modal-quiz') initQuiz();
  if(id==='modal-words') filterWords('');
  if(id==='modal-lb') buildLeaderboard();
}
function closeModal(e,id){
  if(e && e.target!==document.getElementById(id)) return;
  document.getElementById(id).classList.remove('open');
  if(id==='modal-match'){ clearInterval(MS.timer); MS.tval=0; }
  if(id==='modal-anagram'){ clearInterval(AS.timer); AS.tval=0; }
  if(id==='modal-quiz'){ clearInterval(QS.timer); QS.tval=0; }
  if(id==='modal-bg') clearInterval(BT.timer);
  if(id==='modal-matchmaking') clearInterval(mmTimer);
}

// ===== PREMIUM SYSTEM =====
let selectedPlan = '3month';

function selectPlan(plan){
  selectedPlan = plan;
  document.getElementById('plan-monthly').classList.toggle('selected', plan==='monthly');
  document.getElementById('plan-3month').classList.toggle('selected', plan==='3month');
}

function buyPremium(){
  const prices = { monthly:'5,000 so\'m', '3month':'10,000 so\'m' };
  const price = prices[selectedPlan];
  // Haqiqiy to'lov tizimi keyinchalik ulanadi
  // Hozircha demo ‚Äî modal orqali ko'rsatamiz
  const msg = `üí≥ To'lov tizimi\n\nTarif: ${selectedPlan==='monthly'?'Oylik':'3 oylik'}\nNarx: ${price}\n\nTez orada Payme va Click orqali to'lov ulanadi!\n\nHozircha demo rejimda ishlatish uchun "OK" bosing.`;
  if(confirm(msg)){
    activatePremiumDemo();
  }
}

function activatePremiumDemo(){
  U.isPremium = true;
  U.premiumExpiry = Date.now() + (selectedPlan==='monthly' ? 30 : 90) * 24*60*60*1000;
  saveUser();
  updatePremiumUI();
  showToast('üéâ Premium faollashtirildi!');
}

function updatePremiumUI(){
  const isPrem = U.isPremium && U.premiumExpiry > Date.now();
  const statusCard = document.getElementById('prem-status-card');
  const statusText = document.getElementById('prem-status-text');
  const statusSub = document.getElementById('prem-status-sub');
  const tools = document.getElementById('prem-tools');
  if(isPrem){
    statusCard.style.background = 'rgba(79,223,138,.08)';
    statusCard.style.borderColor = 'rgba(79,223,138,.3)';
    statusText.textContent = '‚úÖ Premium faol';
    const d = new Date(U.premiumExpiry);
    statusSub.textContent = `Muddati: ${d.toLocaleDateString('uz-UZ')}`;
    tools.style.display = 'block';
  }
}

function openPremiumGame(type){
  if(!U.isPremium || U.premiumExpiry < Date.now()){
    switchTabByName('premium');
    showToast('üíé Premium kerak!');
    return;
  }
  if(type==='survival') openModal('modal-survival');
  if(type==='daily') openModal('modal-daily');
  if(type==='weak'){ buildWeakWords(); openModal('modal-weak'); }
}

function switchTabByName(name){
  const btn = document.querySelector(`.nav-b[onclick*="'${name}'"]`);
  if(btn) switchTab(name, btn);
}

// ===== SURVIVAL MODE =====
let SV={lives:3,score:0,streak:0,answered:false};

function initSurvival(){
  SV={lives:3,score:0,streak:0,answered:false};
  document.getElementById('surv-score').textContent=0;
  updateSurvLives();
  buildSurvQ();
}

function updateSurvLives(){
  const hearts = ['','‚ù§Ô∏è','‚ù§Ô∏è‚ù§Ô∏è','‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è'];
  document.getElementById('surv-lives').textContent = hearts[SV.lives] || 'üíî O\'yin tugadi';
}

function buildSurvQ(){
  if(SV.lives<=0){ endSurvival(); return; }
  SV.answered=false;
  const pool = getAllWordsForGames();
  if(pool.length<3){ showToast('Kamida 3 ta so\'z kerak!'); return; }
  const correct = pool[Math.floor(Math.random()*pool.length)];
  const others = shuffle(pool.filter(w=>w.word!==correct.word)).slice(0,3);
  const opts = shuffle([correct,...others]);
  document.getElementById('surv-word').textContent=correct.word;
  document.getElementById('surv-res').textContent='';
  const c=document.getElementById('surv-opts'); c.innerHTML='';
  opts.forEach(o=>{
    const el=document.createElement('div'); el.className='gopt';
    el.textContent=o.translation;
    el.onclick=()=>{
      if(SV.answered)return; SV.answered=true;
      if(o.word===correct.word){
        el.classList.add('correct'); SV.score++; SV.streak++;
        addXP(1);
        document.getElementById('surv-score').textContent=SV.score;
        document.getElementById('surv-streak-fill').style.width=Math.min(SV.streak*10,100)+'%';
        document.getElementById('surv-res').textContent=`‚úÖ +1 XP ¬∑ Streak: ${SV.streak}`;
        setTimeout(buildSurvQ,700);
      } else {
        el.classList.add('wrong'); SV.lives--; SV.streak=0;
        c.querySelectorAll('.gopt').forEach(op=>{if(op.textContent===correct.translation)op.classList.add('correct');});
        document.getElementById('surv-streak-fill').style.width='0%';
        updateSurvLives();
        if(SV.lives<=0){ document.getElementById('surv-res').textContent='üíî O\'yin tugadi!'; setTimeout(endSurvival,1200); }
        else { document.getElementById('surv-res').textContent='‚ùå Hayot yo\'qoldi!'; setTimeout(buildSurvQ,900); }
      }
    };
    c.appendChild(el);
  });
}

function endSurvival(){
  document.getElementById('surv-opts').innerHTML=`
    <div style="grid-column:1/-1;text-align:center;padding:10px">
      <div style="font-size:32px;margin-bottom:8px">${SV.score>=10?'üèÜ':'üí™'}</div>
      <div style="font-size:18px;font-weight:800">${SV.score} so'z</div>
      <div style="font-size:13px;color:var(--muted);margin:6px 0">+${SV.score} XP to'plandi</div>
    </div>
    <div style="grid-column:1/-1"><button onclick="initSurvival()" style="width:100%;padding:12px;background:var(--accent);border:none;border-radius:12px;color:white;font-weight:800;cursor:pointer;font-family:'Nunito',sans-serif">üîÅ Qayta o'ynash</button></div>
  `;
}

// ===== DAILY CHALLENGE =====
let DC={timer:null,score:0,time:60,answered:false};

function initDailyChallenge(){
  DC={timer:null,score:0,time:60,answered:false};
  document.getElementById('dc-myscore').textContent=0;
  document.getElementById('dc-gametime').textContent=60;
  buildDCQuestion();
  clearInterval(DC.timer);
  DC.timer=setInterval(()=>{
    DC.time--;
    document.getElementById('dc-gametime').textContent=DC.time;
    if(DC.time<=10) document.getElementById('dc-gametime').style.color='var(--red)';
    if(DC.time<=0){ clearInterval(DC.timer); endDailyChallenge(); }
  },1000);
  buildDCLeaderboard();
}

function buildDCQuestion(){
  if(DC.time<=0) return;
  DC.answered=false;
  const pool = getAllWordsForGames();
  if(pool.length<3) return;
  const correct = pool[Math.floor(Math.random()*pool.length)];
  const others = shuffle(pool.filter(w=>w.word!==correct.word)).slice(0,3);
  const opts = shuffle([correct,...others]);
  document.getElementById('dc-word').textContent=correct.word;
  document.getElementById('dc-res').textContent='';
  const c=document.getElementById('dc-opts'); c.innerHTML='';
  opts.forEach(o=>{
    const el=document.createElement('div'); el.className='gopt'; el.textContent=o.translation;
    el.onclick=()=>{
      if(DC.answered)return; DC.answered=true;
      if(o.word===correct.word){
        el.classList.add('correct'); DC.score++; addXP(1);
        document.getElementById('dc-myscore').textContent=DC.score;
        document.getElementById('dc-res').textContent='‚úÖ +1 XP';
      } else {
        el.classList.add('wrong');
        c.querySelectorAll('.gopt').forEach(op=>{if(op.textContent===correct.translation)op.classList.add('correct');});
        document.getElementById('dc-res').textContent='‚ùå';
      }
      setTimeout(buildDCQuestion,600);
    };
    c.appendChild(el);
  });
}

function endDailyChallenge(){
  U.dailyScore = U.dailyScore || {};
  const today = new Date().toDateString();
  U.dailyScore[today] = Math.max(U.dailyScore[today]||0, DC.score);
  saveUser();
  document.getElementById('dc-opts').innerHTML=`
    <div style="grid-column:1/-1;text-align:center;padding:10px">
      <div style="font-size:32px;margin-bottom:8px">üåü</div>
      <div style="font-size:20px;font-weight:800;color:var(--gold)">${DC.score} ball</div>
      <div style="font-size:12px;color:var(--muted);margin-top:6px">Bugungi eng yaxshi natijangiz saqlandi</div>
    </div>
  `;
  buildDCLeaderboard();
}

function buildDCLeaderboard(){
  const fakeTop = [
    {name:'Nodira',score:38},{name:'Jasur',score:35},{name:'Malika',score:31},
    {name:'Akbar',score:28},{name:'Zulfiya',score:22},
  ];
  const today = new Date().toDateString();
  const myScore = (U.dailyScore||{})[today]||0;
  const all = [...fakeTop,{name:U.name+'(Siz)',score:myScore,isMe:true}].sort((a,b)=>b.score-a.score);
  const el = document.getElementById('dc-lb'); if(!el) return;
  el.innerHTML = all.slice(0,5).map((p,i)=>`
    <div class="tournament-row${p.isMe?' me':''}">
      <div class="tr-rank">${i+1}</div>
      <div class="tr-info"><div class="tr-name">${p.name}</div></div>
      <div class="tr-score">${p.score} ball</div>
    </div>
  `).join('');
}

// ===== WEAK WORDS =====
function buildWeakWords(){
  const list = document.getElementById('weak-list');
  const errors = U.wordErrors || {};
  const sorted = Object.entries(errors).sort((a,b)=>b[1]-a[1]).slice(0,10);
  if(!sorted.length){
    list.innerHTML='<div style="color:var(--muted);text-align:center;padding:20px">Xatolar yo\'q! Zo\'r! üéâ</div>';
    return;
  }
  const max = sorted[0][1];
  list.innerHTML = sorted.map(([word,count])=>{
    const pct = Math.round(count/max*100);
    const w = getAllWordsFallback(U.level).find(x=>x.word===word) || {word,translation:'‚Äî'};
    return `
      <div class="weak-item">
        <div>
          <div class="weak-word">${word}</div>
          <div style="font-size:11px;color:var(--muted)">${w.translation} ¬∑ ${count} xato</div>
        </div>
        <div class="weak-bar-wrap"><div class="weak-bar" style="width:${pct}%"></div></div>
      </div>
    `;
  }).join('');
}

function practiceWeak(){
  const errors = U.wordErrors || {};
  const weakWords = Object.keys(errors).slice(0,10);
  if(!weakWords.length){ showToast('Xatolar yo\'q!'); return; }
  const pool = weakWords.map(word=>{
    return getAllWordsFallback(U.level).find(w=>w.word===word);
  }).filter(Boolean);
  if(pool.length<2){ showToast('Yetarli so\'z yo\'q!'); return; }
  currentUnitWords = pool;
  cardIdx=0; cardFlipped=false;
  updateCard();
  closeModal(null,'modal-weak');
  switchTabByName('home');
  showToast('Zaif so\'zlar yuklandi!');
}

// ===== CUSTOM WORDS =====
function addCustomWord(){
  const word = document.getElementById('cw-word').value.trim();
  const trans = document.getElementById('cw-trans').value.trim();
  if(!word||!trans){ showToast('So\'z va tarjima kiriting!'); return; }
  const def = document.getElementById('cw-def').value.trim() || 'Custom word';
  const ex = document.getElementById('cw-ex').value.trim() || `I know the word "${word}".`;
  if(!U.customWords) U.customWords=[];
  U.customWords.push({word,translation:trans,definition:def,example:ex,part_of_speech:'custom'});
  saveUser();
  document.getElementById('cw-word').value='';
  document.getElementById('cw-trans').value='';
  document.getElementById('cw-def').value='';
  document.getElementById('cw-ex').value='';
  buildCustomWordsList();
  showToast(`‚úÖ "${word}" qo'shildi!`);
}

function buildCustomWordsList(){
  const list = document.getElementById('cw-list');
  const words = U.customWords||[];
  document.getElementById('cw-count').textContent=words.length;
  if(!words.length){ list.innerHTML='<div style="color:var(--muted);font-size:12px;text-align:center;padding:10px">Hali so\'z qo\'shilmagan</div>'; return; }
  list.innerHTML = words.slice().reverse().slice(0,20).map((w,i)=>`
    <div class="wl-item">
      <div><div class="wl-w">${w.word}</div><div class="wl-t">${w.translation}</div></div>
      <div style="display:flex;align-items:center;gap:6px">
        <div class="wl-p">custom</div>
        <div onclick="deleteCustomWord(${words.length-1-i})" style="cursor:pointer;color:var(--red);font-size:16px;padding:2px 4px">√ó</div>
      </div>
    </div>
  `).join('');
}

function deleteCustomWord(idx){
  U.customWords.splice(idx,1);
  saveUser(); buildCustomWordsList();
}

// ===== CERTIFICATE =====
function buildCertList(){
  const list = document.getElementById('cert-list');
  // Qaysi kitoblar tugallanganini tekshirish
  const certs = [];
  for(let b=1;b<=6;b++){
    const level = BOOK_LEVEL[b];
    const db = FALLBACK_WORDS[level]||[];
    const learned = db.filter(w=>U.learnedWords.find(x=>x.word===w.word)).length;
    const pct = db.length ? Math.round(learned/db.length*100) : 0;
    certs.push({book:b,level,learned,total:db.length,pct});
  }
  list.innerHTML = certs.map(c=>`
    <div style="background:var(--s1);border:1px solid ${c.pct>=80?'var(--gold)':'var(--border)'};border-radius:14px;padding:14px;margin-bottom:10px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:800">üìó Kitob ${c.book}</div>
        <div style="font-size:11px;color:var(--muted)">${c.learned}/${c.total} so'z</div>
      </div>
      <div style="height:6px;background:var(--s2);border-radius:10px;overflow:hidden;margin-bottom:8px">
        <div style="height:100%;width:${c.pct}%;background:${c.pct>=80?'var(--gold)':'var(--accent)'};border-radius:10px;transition:width .5s"></div>
      </div>
      ${c.pct>=80 ? `
        <div class="cert-wrap" style="padding:14px">
          <div class="cert-title">üéì SERTIFIKAT</div>
          <div style="font-size:11px;color:var(--muted);margin:4px 0">Muvaffaqiyatli tamomladi</div>
          <div class="cert-name">${U.name}</div>
          <div style="font-size:11px;color:var(--muted)">Essential English ‚Äî Kitob ${c.book}</div>
          <button onclick="downloadCert(${c.book})" style="margin-top:10px;padding:8px 16px;background:var(--gold);color:#080d14;border:none;border-radius:20px;font-weight:800;cursor:pointer;font-size:12px">‚¨áÔ∏è Yuklab olish</button>
        </div>
      ` : `<div style="font-size:11px;color:var(--muted);text-align:center">${c.pct}% ¬∑ Sertifikat uchun 80% kerak</div>`}
    </div>
  `).join('');
}

function downloadCert(book){
  showToast(`üìÑ Kitob ${book} sertifikati yuklanmoqda...`);
  // PDF generatsiya keyinchalik qo'shiladi
}

// ===== GROUP BATTLE =====
function initGroupBattle(){
  const code = U.groupCode || Math.random().toString(36).substr(2,6).toUpperCase();
  U.groupCode = code;
  saveUser();
  document.getElementById('group-my-code').textContent=code;
  buildGroupMembers();
}

function copyGroupCode(){
  const code = document.getElementById('group-my-code').textContent;
  navigator.clipboard?.writeText(code).then(()=>showToast('üìã Kod nusxalandi: '+code));
}

function joinGroup(){
  const code = document.getElementById('group-code-inp').value.trim().toUpperCase();
  if(code.length!==6){ showToast('6 xonali kod kiriting!'); return; }
  // Demo: guruhga qo'shilish
  if(!U.joinedGroups) U.joinedGroups=[];
  if(!U.joinedGroups.includes(code)) U.joinedGroups.push(code);
  saveUser(); buildGroupMembers();
  showToast(`‚úÖ Guruhga qo'shildingiz: ${code}`);
}

function buildGroupMembers(){
  const el = document.getElementById('group-members');
  const fakeMembers = [{name:'Siz',score:U.xp,isMe:true},{name:'Jasur',score:1240},{name:'Nodira',score:980}];
  el.innerHTML = `
    <div style="font-size:11px;font-weight:800;color:var(--muted);margin-bottom:8px">GURUH REYTINGI</div>
    ${fakeMembers.sort((a,b)=>b.score-a.score).map((m,i)=>`
      <div class="tournament-row${m.isMe?' me':''}">
        <div class="tr-rank">${i+1}</div>
        <div class="tr-info"><div class="tr-name">${m.name}</div></div>
        <div class="tr-score">${m.score} XP</div>
      </div>
    `).join('')}
    <button onclick="startGroupBattle()" style="width:100%;margin-top:10px;padding:11px;background:linear-gradient(135deg,var(--orange),#c75a2f);border:none;border-radius:12px;color:white;font-weight:800;cursor:pointer;font-family:'Nunito',sans-serif">
      ‚öîÔ∏è Guruh jangi boshlash
    </button>
  `;
}

function startGroupBattle(){
  closeModal(null,'modal-group');
  startBotBattle(); // Demo: hozircha bot bilan
  showToast('Guruh jangi boshlandi!');
}

// ===== TOURNAMENT =====
function buildTournament(){
  const fakeTop = [
    {name:'Nodira',xp:4200},{name:'Jasur',xp:3850},{name:'Malika',xp:3420},
    {name:'Akbar',xp:2980},{name:'Zulfiya',xp:2650},{name:'Sherzod',xp:2100},
    {name:U.name+'(Siz)',xp:U.xp,isMe:true},{name:'Kamola',xp:1800},
  ].sort((a,b)=>b.xp-a.xp);

  const el=document.getElementById('tourn-lb'); if(!el) return;
  el.innerHTML=fakeTop.slice(0,8).map((p,i)=>{
    const medals=['ü•á','ü•à','ü•â'];
    return `
      <div class="tournament-row${p.isMe?' me':''}">
        <div class="tr-rank">${i<3?medals[i]:i+1}</div>
        <div class="tr-info"><div class="tr-name">${p.name}</div></div>
        <div class="tr-score">${p.xp} XP</div>
      </div>
    `;
  }).join('');

  // Hafta oxirigacha timer
  const now = new Date();
  const sunday = new Date(now);
  sunday.setDate(now.getDate()+(7-now.getDay())%7||7);
  sunday.setHours(23,59,59,0);
  const diff = sunday-now;
  const h=Math.floor(diff/3600000);
  const m=Math.floor((diff%3600000)/60000);
  const s=Math.floor((diff%60000)/1000);
  const te=document.getElementById('tourn-timer');
  if(te) te.textContent=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// ===== DAILY COUNTDOWN =====
function startDailyCountdown(){
  const update=()=>{
    const now=new Date();
    const tomorrow=new Date(now);
    tomorrow.setDate(tomorrow.getDate()+1);
    tomorrow.setHours(0,0,0,0);
    const diff=tomorrow-now;
    const h=Math.floor(diff/3600000);
    const m=Math.floor((diff%3600000)/60000);
    const s=Math.floor((diff%60000)/1000);
    const txt=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    const el1=document.getElementById('dc-countdown');
    if(el1) el1.textContent=txt;
  };
  update();
  setInterval(update,1000);
}

// ===== OVERRIDE openModal for premium modals =====
const _origOpenModal = openModal;
function openModal(id){
  _origOpenModal(id);
  if(id==='modal-survival') initSurvival();
  if(id==='modal-daily') initDailyChallenge();
  if(id==='modal-custom-words') buildCustomWordsList();
  if(id==='modal-cert') buildCertList();
  if(id==='modal-group') initGroupBattle();
  if(id==='modal-tournament') buildTournament();
  // Yangi premium modals
  if(id==='modal-achievements'){ buildAchievements(); U.lastSeenAch=ACHIEVEMENTS.filter(a=>{const c=a.type==='length'?(U[a.stat]?.length||0):(U[a.stat]||0);return c>=a.goal;}).length; saveUser(); const b=document.getElementById('ach-new-badge');if(b)b.style.display='none'; }
  if(id==='modal-stats-detail') buildDetailedStats();
  if(id==='modal-prem-avatar') buildPremiumAvatars();
}

// Override closeModal for new modals
const _origCloseModal = closeModal;
function closeModal(e,id){
  _origCloseModal(e,id);
  if(id==='modal-daily') clearInterval(DC.timer);
}

// ===== OVERRIDE switchTab for new tabs =====
const _origSwitchTab = switchTab;
function switchTab(name,btn){
  document.querySelectorAll('.tab-pages>div').forEach(d=>d.classList.remove('active'));
  document.querySelectorAll('.nav-b').forEach(b=>b.classList.remove('active'));
  const tabEl = document.getElementById('tab-'+name);
  if(tabEl) tabEl.classList.add('active');
  if(btn) btn.classList.add('active');
  if(name==='progress'){buildLeaderboard();buildRecentWords();updateStats();}
  if(name==='battle'){buildBattleUI();}
  if(name==='games'){
    const gl=document.getElementById('game-unit-label2');
    if(gl) gl.textContent=`Kitob ${curBook} ¬∑ Unit ${curUnitNum}`;
  }
  if(name==='premium') updatePremiumUI();
}

// ===== INIT PREMIUM on startup =====
function initPremiumFeatures(){
  updatePremiumUI();
  startDailyCountdown();
}

// Track word errors for weak words
function trackWordError(word){
  if(!U.wordErrors) U.wordErrors={};
  U.wordErrors[word]=(U.wordErrors[word]||0)+1;
  saveUser();
}

// ============================================================
// üéØ STREAK FREEZE
// ============================================================
function openStreakFreeze(){
  if(!checkPremium('modal-streak-freeze')) return;
  if(!U.streakFreezes) U.streakFreezes = 2; // Premium oyiga 2 ta
  document.getElementById('sf-available').textContent = U.streakFreezes;
  document.getElementById('sf-streak-val').textContent = U.streak||0;
  // Ikonkalar
  const icons = document.getElementById('sf-icons');
  icons.innerHTML = '';
  for(let i=0;i<(U.streakFreezes||0);i++) icons.innerHTML+=`<span style="font-size:28px">üßä</span>`;
  if(!U.streakFreezes) icons.innerHTML='<span style="font-size:13px;color:var(--muted)">Freeze qolmadi</span>';
  document.getElementById('sf-use-btn').disabled = !U.streakFreezes;
  document.getElementById('sf-status-text').textContent = U.lastFreeze===getTodayStr()
    ? '‚úÖ Bugun allaqachon ishlatilgan' : 'Premium foydalanuvchilar oyiga 2 ta bepul Freeze oladi';
  openModal('modal-streak-freeze');
}
function useStreakFreeze(){
  if(!U.streakFreezes||U.streakFreezes<=0){showToast('Freeze qolmadi!');return;}
  if(U.lastFreeze===getTodayStr()){showToast('Bugun allaqachon ishlatilgan!');return;}
  U.streakFreezes--;
  U.lastFreeze = getTodayStr();
  // Streakni saqlab qolamiz ‚Äî maxsus flag
  U.streakFreezeActive = true;
  saveUser();
  document.getElementById('sf-available').textContent = U.streakFreezes;
  document.getElementById('sf-icons').innerHTML = Array.from({length:U.streakFreezes},()=>'<span style="font-size:28px">üßä</span>').join('')||'<span style="font-size:13px;color:var(--muted)">Freeze qolmadi</span>';
  document.getElementById('sf-use-btn').disabled = true;
  document.getElementById('sf-status-text').textContent = '‚úÖ Bugun Freeze ishlatildi! Streak saqlanadi.';
  showToast('üßä Streak Freeze ishlatildi!');
}
function getTodayStr(){ return new Date().toISOString().slice(0,10); }

// ============================================================
// üî• XP BOOST
// ============================================================
let boostInterval = null;
function openXPBoost(){
  if(!checkPremium('modal-xp-boost')) return;
  updateBoostUI();
  openModal('modal-xp-boost');
}
function activateXPBoost(){
  if(U.xpBoostExpiry && U.xpBoostExpiry > Date.now()){
    showToast('Boost allaqachon faol!'); return;
  }
  if(!U.boostsLeft && U.boostsLeft!==undefined && U.boostsLeft<=0){
    showToast('Bu oy uchun Boost tugadi!'); return;
  }
  U.xpBoostExpiry = Date.now() + 24*60*60*1000;
  if(U.boostsLeft===undefined) U.boostsLeft=3;
  U.boostsLeft--;
  saveUser();
  updateBoostUI();
  showToast('‚ö° XP Boost faollashtirildi! 24 soat 2√ó XP');
}
function updateBoostUI(){
  const active = U.xpBoostExpiry && U.xpBoostExpiry > Date.now();
  const card = document.getElementById('boost-active-card');
  const btn = document.getElementById('boost-activate-btn');
  const badge = document.getElementById('xpboost-badge');
  if(card) card.style.display = active ? 'block' : 'none';
  if(btn) btn.textContent = active ? '‚úÖ Boost Faol' : '‚ö° Boostni Faollashtirish';
  if(badge){ badge.textContent = active ? 'ON 2√ó' : 'OFF'; badge.style.background = active ? 'rgba(249,123,79,.3)':'rgba(249,123,79,.15)'; }
  if(active){
    clearInterval(boostInterval);
    boostInterval = setInterval(()=>{
      const left = U.xpBoostExpiry - Date.now();
      if(left<=0){ clearInterval(boostInterval); updateBoostUI(); return; }
      const h=Math.floor(left/3600000);const m=Math.floor((left%3600000)/60000);const s=Math.floor((left%60000)/1000);
      const el=document.getElementById('boost-timer');
      if(el) el.textContent=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    },1000);
  }
}
// addXP ni boost bilan kengaytirish
const _origAddXP = addXP;
function addXP(n){
  const boosted = U.xpBoostExpiry && U.xpBoostExpiry > Date.now();
  _origAddXP(boosted ? n*2 : n);
  checkNewAchievements();
  trackTodayActivity();
}

// ============================================================
// üìä BATAFSIL STATISTIKA
// ============================================================
function openDetailedStats(){
  if(!checkPremium('modal-stats-detail')) return;
  buildDetailedStats();
  openModal('modal-stats-detail');
}
function buildDetailedStats(){
  document.getElementById('ds-words').textContent = U.learnedWords?.length||0;
  document.getElementById('ds-streak').textContent = U.streak||0;
  document.getElementById('ds-xp').textContent = U.xp||0;
  document.getElementById('ds-battles').textContent = U.battleWins||0;
  // Haftalik heatmap
  const heatmap = document.getElementById('week-heatmap');
  if(heatmap){
    const days = ['Du','Se','Ch','Pa','Ju','Sh','Ya'];
    const activity = U.weeklyActivity || [0,0,0,0,0,0,0];
    const maxA = Math.max(...activity,1);
    heatmap.innerHTML = days.map((d,i)=>{
      const pct = activity[i]/maxA;
      const opacity = 0.1 + pct*0.9;
      return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px">
        <div class="heat-day" style="background:rgba(124,90,246,${opacity.toFixed(2)})"></div>
        <span style="font-size:9px;color:var(--muted)">${d}</span>
      </div>`;
    }).join('');
  }
  // XP chart
  const chart = document.getElementById('xp-chart');
  if(chart){
    const xpHistory = U.xpHistory || [0,0,0,0,0,0,0];
    const maxXP = Math.max(...xpHistory,1);
    const dayNames = ['Du','Se','Ch','Pa','Ju','Sh','Ya'];
    chart.innerHTML = xpHistory.map((v,i)=>{
      const h = Math.round((v/maxXP)*60)+4;
      return `<div class="xp-bar" style="height:${h}px" title="${v} XP"><span class="xp-bar-label">${dayNames[i]}</span></div>`;
    }).join('');
  }
  // Tahlil
  const analysis = document.getElementById('stats-analysis');
  if(analysis){
    const totalBattles = (U.battleWins||0)+(U.battleLosses||0);
    const winRate = totalBattles>0 ? Math.round((U.battleWins||0)/totalBattles*100) : 0;
    const weakCount = Object.values(U.wordErrors||{}).filter(v=>v>=2).length;
    analysis.innerHTML = `
      <div style="background:var(--s2);border-radius:11px;padding:11px 14px;display:flex;justify-content:space-between;align-items:center">
        <div><div style="font-size:12px;color:var(--muted)">Battle g'alaba foizi</div><div style="font-size:16px;font-weight:800;color:var(--${winRate>50?'green':'orange'}">${winRate}%</div></div>
        <div style="font-size:24px">${winRate>50?'üèÜ':'üí™'}</div>
      </div>
      <div style="background:var(--s2);border-radius:11px;padding:11px 14px;display:flex;justify-content:space-between;align-items:center">
        <div><div style="font-size:12px;color:var(--muted)">Zaif so'zlar</div><div style="font-size:16px;font-weight:800;color:var(--${weakCount>5?'red':'green'}">${weakCount} ta</div></div>
        <div style="font-size:24px">${weakCount>5?'‚ö†Ô∏è':'‚úÖ'}</div>
      </div>
      <div style="background:var(--s2);border-radius:11px;padding:11px 14px;display:flex;justify-content:space-between;align-items:center">
        <div><div style="font-size:12px;color:var(--muted)">O'rtacha kunlik XP</div><div style="font-size:16px;font-weight:800;color:var(--purple)">${Math.round((U.xp||0)/Math.max(U.streak||1,1))}</div></div>
        <div style="font-size:24px">üìà</div>
      </div>`;
  }
}

// ============================================================
// üåç TARJIMON REJIMI
// ============================================================
let trDebounce=null;
function translateLive(val){
  clearTimeout(trDebounce);
  if(!val.trim()){
    document.getElementById('tr-result').innerHTML='<div style="font-size:12px;color:var(--muted)">Natija bu yerda ko\'rinadi</div>';
    document.getElementById('tr-examples').innerHTML='';
    return;
  }
  document.getElementById('tr-result').innerHTML='<div style="font-size:12px;color:var(--muted)">‚è≥ Qidirilmoqda...</div>';
  trDebounce = setTimeout(()=>doTranslate(val.trim()),500);
}
function doTranslate(word){
  // Unit so'zlaridan qidirish
  const allWords = getAllWordsForGames();
  const found = allWords.find(w=>w.word.toLowerCase()===word.toLowerCase());
  const result = document.getElementById('tr-result');
  const examples = document.getElementById('tr-examples');
  if(found){
    result.innerHTML=`
      <div style="font-size:18px;font-weight:800;color:var(--text);margin-bottom:4px">${found.word}</div>
      <div style="font-size:13px;color:var(--blue);font-weight:700;margin-bottom:6px">${found.translation}</div>
      <div style="font-size:11px;color:var(--muted);background:var(--s3);border-radius:8px;padding:6px 10px;display:inline-block">${found.part_of_speech}</div>
      <div style="font-size:12px;color:var(--muted);margin-top:8px">${found.definition}</div>`;
    examples.innerHTML=`<div class="tr-example">"${found.example}"</div>`;
  } else {
    // Qisman moslik
    const partial = allWords.filter(w=>w.word.toLowerCase().includes(word.toLowerCase())).slice(0,3);
    if(partial.length){
      result.innerHTML=`<div style="font-size:12px;color:var(--muted)">Aniq mos topilmadi. Yaqin natijalar:</div>`;
      examples.innerHTML=partial.map(w=>`
        <div class="tr-example" onclick="document.getElementById('tr-input').value='${w.word}';doTranslate('${w.word}')" style="cursor:pointer">
          <b>${w.word}</b> ‚Äî ${w.translation}
          <div style="color:var(--muted);margin-top:3px">${w.definition}</div>
        </div>`).join('');
    } else {
      result.innerHTML=`<div style="font-size:12px;color:var(--muted)">Hozirgi unitda topilmadi. Boshqa unitni tanlang.</div>`;
      examples.innerHTML='';
    }
  }
}
function speakTranslation(){
  const val = document.getElementById('tr-input').value.trim();
  if(!val) return;
  if('speechSynthesis' in window){
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(val);
    u.lang='en-US'; u.rate=0.85;
    const v = speechSynthesis.getVoices().find(v=>v.lang.startsWith('en-US'));
    if(v) u.voice=v;
    speechSynthesis.speak(u);
  }
}

// ============================================================
// ‚è∞ KUNLIK ESLATMA
// ============================================================
function setReminderTime(time){
  document.querySelectorAll('.rem-pill').forEach(el=>el.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('selected-reminder-time').textContent = time;
  U.reminderTime = time;
}
function saveReminder(){
  const time = document.getElementById('selected-reminder-time').textContent;
  if(time==='Tanlanmagan'){showToast('Vaqtni tanlang!');return;}
  U.reminderTime = time;
  U.reminderEnabled = true;
  saveUser();
  // Browser notification permission
  if('Notification' in window){
    Notification.requestPermission().then(p=>{
      if(p==='granted'){
        document.getElementById('reminder-status').textContent=`‚úÖ ${time} da eslatma o'rnatildi`;
        showToast(`‚è∞ Eslatma ${time} ga saqlandi!`);
      } else {
        document.getElementById('reminder-status').textContent=`‚ö†Ô∏è Brauzer bildirishnomalar ruxsat bermadi`;
        showToast('Brauzer ruxsatini bering!');
      }
    });
  } else {
    document.getElementById('reminder-status').textContent=`‚úÖ ${time} ga saqlandi`;
    showToast(`‚è∞ Eslatma ${time} ga saqlandi!`);
  }
}

// ============================================================
// üèÖ ACHIEVEMENT TIZIMI
// ============================================================
const ACHIEVEMENTS = [
  {id:'first_word',  icon:'üå±', title:'Birinchi Qadam',  desc:'Birinchi so\'zni o\'rganing',   goal:1,  stat:'learnedWords', type:'length'},
  {id:'words_10',    icon:'üìö', title:'O\'quvchi',        desc:'10 ta so\'z o\'rganing',        goal:10, stat:'learnedWords', type:'length'},
  {id:'words_50',    icon:'üéØ', title:'Izlanuvchan',     desc:'50 ta so\'z o\'rganing',        goal:50, stat:'learnedWords', type:'length'},
  {id:'words_100',   icon:'üèÜ', title:'Lug\'at Ustasi',  desc:'100 ta so\'z o\'rganing',       goal:100,stat:'learnedWords', type:'length'},
  {id:'words_200',   icon:'ü¶ã', title:'Parvoz',          desc:'200 ta so\'z o\'rganing',       goal:200,stat:'learnedWords', type:'length'},
  {id:'streak_3',    icon:'üî•', title:'Oddiy Streak',    desc:'3 kunlik streak',               goal:3,  stat:'streak',       type:'val'},
  {id:'streak_7',    icon:'üí•', title:'Haftalik Qahram', desc:'7 kunlik streak',               goal:7,  stat:'streak',       type:'val'},
  {id:'streak_30',   icon:'‚ö°', title:'Oylik Chempion',  desc:'30 kunlik streak',              goal:30, stat:'streak',       type:'val'},
  {id:'battle_1',    icon:'‚öîÔ∏è', title:'Birinchi Jang',   desc:'Birinchi battle g\'alabasi',    goal:1,  stat:'battleWins',   type:'val'},
  {id:'battle_10',   icon:'üõ°Ô∏è', title:'Jangchi',         desc:'10 ta battle g\'alabasi',       goal:10, stat:'battleWins',   type:'val'},
  {id:'battle_50',   icon:'üëë', title:'Jang Qiroli',     desc:'50 ta battle g\'alabasi',       goal:50, stat:'battleWins',   type:'val'},
  {id:'xp_100',      icon:'‚≠ê', title:'XP Yig\'uvchi',   desc:'100 XP to\'plang',              goal:100,stat:'xp',           type:'val'},
  {id:'xp_500',      icon:'üåü', title:'XP Sermahsul',    desc:'500 XP to\'plang',              goal:500,stat:'xp',           type:'val'},
  {id:'xp_1000',     icon:'üíé', title:'XP Boyi',         desc:'1000 XP to\'plang',             goal:1000,stat:'xp',          type:'val'},
];
function buildAchievements(){
  const list = document.getElementById('ach-list');
  if(!list) return;
  let unlocked=0;
  list.innerHTML = ACHIEVEMENTS.map(a=>{
    const cur = a.type==='length' ? (U[a.stat]?.length||0) : (U[a.stat]||0);
    const done = cur >= a.goal;
    if(done) unlocked++;
    const pct = Math.min(100, Math.round(cur/a.goal*100));
    return `<div class="ach-card ${done?'unlocked':'locked'}">
      <div class="ach-icon">${done?a.icon:'üîí'}</div>
      <div class="ach-info">
        <div class="ach-title">${a.title}</div>
        <div class="ach-sub">${a.desc}</div>
        <div class="ach-prog"><div class="ach-prog-fill" style="width:${pct}%"></div></div>
        <div style="font-size:10px;color:var(--muted);margin-top:3px">${cur}/${a.goal}</div>
      </div>
      ${done?'<span style="color:var(--gold);font-size:18px">‚úì</span>':''}
    </div>`;
  }).join('');
  document.getElementById('ach-unlocked').textContent = unlocked;
  document.getElementById('ach-total').textContent = ACHIEVEMENTS.length;
  // Yangi achievement bor? Badge ko'rsat
  const newBadge = document.getElementById('ach-new-badge');
  if(newBadge) newBadge.style.display = unlocked>(U.lastSeenAch||0)?'inline':'none';
}
function checkNewAchievements(){
  let newOnes=[];
  ACHIEVEMENTS.forEach(a=>{
    const cur = a.type==='length'?(U[a.stat]?.length||0):(U[a.stat]||0);
    const key='ach_done_'+a.id;
    if(cur>=a.goal && !U[key]){
      U[key]=true; newOnes.push(a);
    }
  });
  if(newOnes.length){
    newOnes.forEach(a=>setTimeout(()=>showToast(`üèÖ Achievement: ${a.title}!`),500));
    const badge=document.getElementById('ach-new-badge');
    if(badge) badge.style.display='inline';
    U.lastSeenAch=(U.lastSeenAch||0)+newOnes.length;
    saveUser();
  }
}

// ============================================================
// üé® PREMIUM AVATARLAR
// ============================================================
const PREMIUM_AVATARS = [
  'ü¶Ñ','üêâ','ü¶Ö','üêØ','ü¶Å','üê∫','ü¶ä','üê∏',
  'üßô','üßõ','üßù','ü§¥','üë∏','ü•∑','ü¶∏','üßú',
  'üåô','‚≠ê','üî•','‚ùÑÔ∏è','‚ö°','üåä','üå∫','üçÄ',
];
let selectedPremAv = null;
function buildPremiumAvatars(){
  const grid = document.getElementById('prem-av-grid');
  if(!grid) return;
  grid.innerHTML = PREMIUM_AVATARS.map(av=>`
    <div class="prem-av-item ${U.avatarEmoji===av?'selected':''}" onclick="selectPremAv('${av}',this)">${av}</div>
  `).join('');
  if(U.avatarEmoji) document.getElementById('prem-av-selected').textContent=U.avatarEmoji;
}
function selectPremAv(av, el){
  selectedPremAv = av;
  document.querySelectorAll('.prem-av-item').forEach(e=>e.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('prem-av-selected').textContent = av;
}
function applyPremiumAvatar(){
  if(!selectedPremAv){showToast('Avatar tanlang!');return;}
  U.avatarEmoji = selectedPremAv;
  U.avatarUrl = null;
  document.getElementById('tb-av').innerHTML = selectedPremAv;
  saveUser();
  closeModal(null,'modal-prem-avatar');
  showToast('üé® Avatar yangilandi!');
}

// ============================================================
// PREMIUM YORDAMCHI FUNKSIYALAR
// ============================================================
function checkPremium(modalId){
  const isPrem = U.isPremium && U.premiumExpiry > Date.now();
  if(!isPrem){
    showToast('üíé Bu funksiya faqat Premium foydalanuvchilar uchun');
    setTimeout(()=>switchTabByName('premium'),800);
    return false;
  }
  return true;
}
function switchTabByName(name){
  const btn = document.querySelector(`.nav-b[onclick*="${name}"]`);
  if(btn) btn.click();
}

// ============================================================
// WEEKLY ACTIVITY TRACKER
// ============================================================
function trackTodayActivity(){
  if(!U.weeklyActivity) U.weeklyActivity=[0,0,0,0,0,0,0];
  if(!U.xpHistory) U.xpHistory=[0,0,0,0,0,0,0];
  const day = new Date().getDay(); // 0=Yak, 1=Du ...
  const idx = day===0?6:day-1; // Du=0 ... Ya=6
  U.weeklyActivity[idx] = (U.weeklyActivity[idx]||0)+1;
  saveUser();
}

// ============================================================
// INITPREMIUMFEATURES GA QO'SHIMCHALAR
// ============================================================
const _origInitPremium = initPremiumFeatures;
function initPremiumFeatures(){
  _origInitPremium();
  updateBoostUI();
  checkNewAchievements();
  // Monthly streak freeze reset
  const monthKey = new Date().toISOString().slice(0,7);
  if(U.freezeMonth!==monthKey && U.isPremium){
    U.streakFreezes=2; U.freezeMonth=monthKey;
    if(!U.boostsLeft||U.boostsLeftMonth!==monthKey){ U.boostsLeft=3; U.boostsLeftMonth=monthKey; }
    saveUser();
  }
  trackTodayActivity();
}

// ===== END =====

<!-- SURVIVAL MODE MODAL -->
<div class="overlay" id="modal-survival" onclick="closeModal(event,'modal-survival')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-survival')">‚úï</div>
    <div class="sb">
      <div class="st">‚ù§Ô∏è Survival Mode</div>
      <div class="surv-lives" id="surv-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
      <div style="background:var(--s2);border-radius:10px;padding:8px 12px;margin-bottom:8px;display:flex;justify-content:space-between">
        <span style="font-size:12px;color:var(--muted)">To'plangan so'zlar</span>
        <span style="font-size:13px;font-weight:800;color:var(--green)" id="surv-score">0</span>
      </div>
      <div class="surv-streak-bar"><div class="surv-streak-fill" id="surv-streak-fill" style="width:0%"></div></div>
      <div class="gword" id="surv-word">‚Äî</div>
      <div class="gopts" id="surv-opts"></div>
      <div id="surv-res" style="text-align:center;font-size:13px;min-height:20px;margin-top:8px"></div>
    </div>
  </div>
</div>

<!-- DAILY CHALLENGE MODAL -->
<div class="overlay" id="modal-daily" onclick="closeModal(event,'modal-daily')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-daily')">‚úï</div>
    <div class="sb">
      <div class="st">üåü Daily Challenge</div>
      <div style="display:flex;justify-content:space-between;align-items:center;background:var(--s2);border-radius:12px;padding:10px 14px;margin-bottom:12px">
        <div><div style="font-size:11px;color:var(--muted)">Bugungi ball</div><div style="font-size:20px;font-weight:800;color:var(--gold)" id="dc-myscore">0</div></div>
        <div style="text-align:right"><div style="font-size:11px;color:var(--muted)">Vaqt</div><div style="font-size:20px;font-weight:800;color:var(--blue)" id="dc-gametime">60</div></div>
      </div>
      <div class="gword" id="dc-word">‚Äî</div>
      <div class="gopts" id="dc-opts"></div>
      <div id="dc-res" style="text-align:center;font-size:13px;min-height:20px;margin-top:8px"></div>
      <div style="margin-top:14px">
        <div style="font-size:11px;font-weight:800;color:var(--muted);margin-bottom:8px">BUGUNGI TOP 5</div>
        <div id="dc-lb"></div>
      </div>
    </div>
  </div>
</div>

<!-- WEAK WORDS MODAL -->
<div class="overlay" id="modal-weak" onclick="closeModal(event,'modal-weak')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-weak')">‚úï</div>
    <div class="sb">
      <div class="st">‚ö†Ô∏è Zaif So'zlar</div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:14px">Ko'p xato qilingan so'zlar ‚Äî qayta o'rganing</div>
      <div id="weak-list"></div>
      <button onclick="practiceWeak()" style="width:100%;margin-top:12px;padding:12px;background:linear-gradient(135deg,var(--red),#c73030);border:none;border-radius:12px;color:white;font-weight:800;font-size:14px;cursor:pointer;font-family:'Nunito',sans-serif">
        üîÅ Qayta mashq qilish
      </button>
    </div>
  </div>
</div>

<!-- CUSTOM WORDS MODAL -->
<div class="overlay" id="modal-custom-words" onclick="closeModal(event,'modal-custom-words')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-custom-words')">‚úï</div>
    <div class="sb">
      <div class="st">üìù Shaxsiy So'zlar</div>
      <input class="custom-inp" id="cw-word" placeholder="So'z (inglizcha)" />
      <input class="custom-inp" id="cw-trans" placeholder="Tarjima (o'zbek)" />
      <input class="custom-inp" id="cw-def" placeholder="Ta'rif (ixtiyoriy)" />
      <input class="custom-inp" id="cw-ex" placeholder="Misol jumla (ixtiyoriy)" />
      <button onclick="addCustomWord()" style="width:100%;padding:12px;background:linear-gradient(135deg,var(--accent),#5b3fd4);border:none;border-radius:12px;color:white;font-weight:800;font-size:14px;cursor:pointer;font-family:'Nunito',sans-serif;margin-bottom:14px">
        ‚ûï Qo'shish
      </button>
      <div style="font-size:11px;font-weight:800;color:var(--muted);margin-bottom:8px">MENING SO'ZLARIM (<span id="cw-count">0</span>)</div>
      <div id="cw-list"></div>
    </div>
  </div>
</div>

<!-- CERTIFICATE MODAL -->
<div class="overlay" id="modal-cert" onclick="closeModal(event,'modal-cert')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-cert')">‚úï</div>
    <div class="sb">
      <div class="st">üéì Sertifikatlar</div>
      <div id="cert-list"></div>
      <div style="font-size:12px;color:var(--muted);text-align:center;margin-top:10px">
        Sertifikat olish uchun kitobning barcha unitlarini tugating
      </div>
    </div>
  </div>
</div>

<!-- GROUP BATTLE MODAL -->
<div class="overlay" id="modal-group" onclick="closeModal(event,'modal-group')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-group')">‚úï</div>
    <div class="sb">
      <div class="st">üë• Guruh Battle</div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:14px">Do'stlaringiz bilan guruhda jang qiling!</div>
      <div style="font-size:11px;font-weight:800;color:var(--muted);margin-bottom:6px">MENING KODUM</div>
      <div class="group-code" id="group-my-code" onclick="copyGroupCode()">------</div>
      <div style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:14px">Bosib nusxa oling</div>
      <div style="font-size:11px;font-weight:800;color:var(--muted);margin-bottom:6px">KODGA QO'SHILISH</div>
      <div style="display:flex;gap:8px;margin-bottom:14px">
        <input class="custom-inp" id="group-code-inp" placeholder="6 xonali kod" style="margin-bottom:0;flex:1;font-family:'Syne',sans-serif;font-weight:800;letter-spacing:.1em;font-size:16px">
        <button onclick="joinGroup()" style="padding:10px 16px;background:var(--accent);border:none;border-radius:11px;color:white;font-weight:800;cursor:pointer;font-family:'Nunito',sans-serif">Kirish</button>
      </div>
      <div id="group-members" style="display:flex;flex-direction:column;gap:6px"></div>
    </div>
  </div>
</div>

<!-- TOURNAMENT MODAL -->
<div class="overlay" id="modal-tournament" onclick="closeModal(event,'modal-tournament')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-tournament')">‚úï</div>
    <div class="sb">
      <div class="st">üèÜ Haftalik Tournament</div>
      <div style="background:rgba(245,197,66,.08);border:1px solid rgba(245,197,66,.2);border-radius:12px;padding:12px 14px;margin-bottom:14px">
        <div style="font-size:11px;color:var(--muted);margin-bottom:4px">Hafta tugashiga</div>
        <div style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800;color:var(--gold)" id="tourn-timer">--:--:--</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">Eng ko'p XP to'plagan g'alaba qiladi</div>
      </div>
      <div style="font-size:11px;font-weight:800;color:var(--muted);margin-bottom:10px">JORIY REYTING</div>
      <div id="tourn-lb"></div>
      <button onclick="closeModal(null,'modal-tournament');switchTabByName('battle')" style="width:100%;margin-top:12px;padding:12px;background:linear-gradient(135deg,var(--orange),var(--gold));border:none;border-radius:12px;color:#080d14;font-weight:800;font-size:14px;cursor:pointer;font-family:'Nunito',sans-serif">
        ‚öîÔ∏è XP to'plash uchun jang!
      </button>
    </div>
  </div>
</div>

<!-- STREAK FREEZE MODAL -->
<div class="overlay" id="modal-streak-freeze" onclick="closeModal(event,'modal-streak-freeze')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-streak-freeze')">‚úï</div>
    <div class="sb">
      <div class="st">üéØ Streak Freeze</div>
      <div style="text-align:center;padding:10px 0 16px">
        <div style="font-size:56px;margin-bottom:8px">üßä</div>
        <div style="font-size:13px;color:var(--muted);line-height:1.5">Streak Freeze ‚Äî mashg'ulot o'tkazib yuborsangiz ham streakingiz saqlanadi. Har oy <b style="color:var(--gold)">2 ta bepul</b> Freeze beriladi.</div>
      </div>
      <div style="background:var(--s2);border-radius:14px;padding:14px;margin-bottom:14px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <span style="font-size:13px;font-weight:700">Mavjud Freeze</span>
          <span style="font-size:22px;font-weight:800;color:var(--blue)" id="sf-available">0</span>
        </div>
        <div style="display:flex;gap:8px" id="sf-icons"></div>
      </div>
      <div style="background:var(--s2);border-radius:14px;padding:14px;margin-bottom:14px">
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px">JORIY STREAK</div>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:32px">üî•</span>
          <span style="font-size:28px;font-weight:800;color:var(--gold)" id="sf-streak-val">0</span>
          <span style="font-size:12px;color:var(--muted)">kun</span>
        </div>
      </div>
      <button onclick="useStreakFreeze()" id="sf-use-btn" style="width:100%;padding:13px;background:linear-gradient(135deg,var(--blue),var(--accent));border:none;border-radius:13px;color:white;font-weight:800;font-size:14px;cursor:pointer;font-family:'Nunito',sans-serif">
        üßä Bugungi Freeze ishlatish
      </button>
      <div style="text-align:center;font-size:11px;color:var(--muted);margin-top:8px" id="sf-status-text">Premium foydalanuvchilar oyiga 2 ta bepul Freeze oladi</div>
    </div>
  </div>
</div>

<!-- XP BOOST MODAL -->
<div class="overlay" id="modal-xp-boost" onclick="closeModal(event,'modal-xp-boost')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-xp-boost')">‚úï</div>
    <div class="sb">
      <div class="st">üî• XP Boost</div>
      <div style="text-align:center;padding:10px 0 16px">
        <div style="font-size:64px;margin-bottom:8px">‚ö°</div>
        <div style="font-size:22px;font-weight:800;color:var(--orange)">2√ó XP</div>
        <div style="font-size:12px;color:var(--muted);margin-top:6px">24 soat davomida barcha XP ikki barobar bo'ladi</div>
      </div>
      <div id="boost-active-card" style="display:none;background:linear-gradient(135deg,rgba(249,123,79,.15),rgba(245,197,66,.1));border:1px solid rgba(249,123,79,.4);border-radius:14px;padding:14px;margin-bottom:14px;text-align:center">
        <div style="font-size:11px;color:var(--muted);margin-bottom:4px">BOOST TUGASHIGA</div>
        <div style="font-size:28px;font-weight:800;color:var(--orange)" id="boost-timer">--:--:--</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
        <div style="display:flex;align-items:center;gap:10px;background:var(--s2);border-radius:11px;padding:10px 14px"><span>üéÆ</span><span style="font-size:13px">O'yin to'g'ri javob: 1 ‚Üí <b style="color:var(--orange)">2 XP</b></span></div>
        <div style="display:flex;align-items:center;gap:10px;background:var(--s2);border-radius:11px;padding:10px 14px"><span>üìñ</span><span style="font-size:13px">So'z o'rganish: 1 ‚Üí <b style="color:var(--orange)">2 XP</b></span></div>
        <div style="display:flex;align-items:center;gap:10px;background:var(--s2);border-radius:11px;padding:10px 14px"><span>‚öîÔ∏è</span><span style="font-size:13px">Battle g'alaba: 10 ‚Üí <b style="color:var(--orange)">20 XP</b></span></div>
      </div>
      <button onclick="activateXPBoost()" id="boost-activate-btn" style="width:100%;padding:13px;background:linear-gradient(135deg,var(--orange),var(--gold));border:none;border-radius:13px;color:#080d14;font-weight:800;font-size:14px;cursor:pointer;font-family:'Nunito',sans-serif">
        ‚ö° Boostni Faollashtirish
      </button>
      <div style="text-align:center;font-size:11px;color:var(--muted);margin-top:8px">Premium: oyiga 3 ta bepul Boost</div>
    </div>
  </div>
</div>

<!-- DETAILED STATS MODAL -->
<div class="overlay" id="modal-stats-detail" onclick="closeModal(event,'modal-stats-detail')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-stats-detail')">‚úï</div>
    <div class="sb">
      <div class="st">üìä Batafsil Statistika</div>
      <!-- Asosiy raqamlar -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px" id="stats-grid">
        <div style="background:var(--s2);border-radius:12px;padding:12px;text-align:center"><div style="font-size:24px;font-weight:800;color:var(--green)" id="ds-words">0</div><div style="font-size:11px;color:var(--muted)">O'rganilgan so'z</div></div>
        <div style="background:var(--s2);border-radius:12px;padding:12px;text-align:center"><div style="font-size:24px;font-weight:800;color:var(--gold)" id="ds-streak">0</div><div style="font-size:11px;color:var(--muted)">Streak üî•</div></div>
        <div style="background:var(--s2);border-radius:12px;padding:12px;text-align:center"><div style="font-size:24px;font-weight:800;color:var(--purple)" id="ds-xp">0</div><div style="font-size:11px;color:var(--muted)">Jami XP</div></div>
        <div style="background:var(--s2);border-radius:12px;padding:12px;text-align:center"><div style="font-size:24px;font-weight:800;color:var(--blue)" id="ds-battles">0</div><div style="font-size:11px;color:var(--muted)">Battle g'alabasi</div></div>
      </div>
      <!-- Haftalik faollik heatmap -->
      <div style="font-size:11px;font-weight:800;color:var(--muted);margin-bottom:8px">HAFTALIK FAOLLIK</div>
      <div style="display:flex;gap:4px;margin-bottom:14px" id="week-heatmap"></div>
      <!-- XP grafigi -->
      <div style="font-size:11px;font-weight:800;color:var(--muted);margin-bottom:8px">XP TARIXI (so'nggi 7 kun)</div>
      <div style="background:var(--s2);border-radius:12px;padding:12px;height:80px;display:flex;align-items:flex-end;gap:4px" id="xp-chart"></div>
      <!-- Kuchli/Zaif tomonlar -->
      <div style="font-size:11px;font-weight:800;color:var(--muted);margin:14px 0 8px">TAHLIL</div>
      <div id="stats-analysis" style="display:flex;flex-direction:column;gap:7px"></div>
    </div>
  </div>
</div>

<!-- TRANSLATOR MODE MODAL -->
<div class="overlay" id="modal-translator" onclick="closeModal(event,'modal-translator')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-translator')">‚úï</div>
    <div class="sb">
      <div class="st">üåç Tarjimon Rejimi</div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:14px">So'zning kontekstdagi ishlatilishini ko'ring</div>
      <div style="position:relative;margin-bottom:10px">
        <input id="tr-input" class="custom-inp" placeholder="So'z yoki jumla kiriting..." style="margin-bottom:0;padding-right:44px" oninput="translateLive(this.value)">
        <button onclick="speakTranslation()" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:20px;cursor:pointer">üîä</button>
      </div>
      <div id="tr-result" style="background:var(--s2);border-radius:12px;padding:14px;min-height:60px;margin-bottom:12px">
        <div style="font-size:12px;color:var(--muted)">Natija bu yerda ko'rinadi</div>
      </div>
      <div style="font-size:11px;font-weight:800;color:var(--muted);margin-bottom:8px">MISOL GAPLAR</div>
      <div id="tr-examples" style="display:flex;flex-direction:column;gap:6px"></div>
    </div>
  </div>
</div>

<!-- REMINDER MODAL -->
<div class="overlay" id="modal-reminder" onclick="closeModal(event,'modal-reminder')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-reminder')">‚úï</div>
    <div class="sb">
      <div class="st">‚è∞ Kunlik Eslatma</div>
      <div style="text-align:center;padding:8px 0 16px">
        <div style="font-size:48px;margin-bottom:8px">üîî</div>
        <div style="font-size:13px;color:var(--muted)">Har kuni bir vaqtda o'rganish uchun eslatma o'rnating</div>
      </div>
      <div style="font-size:11px;font-weight:800;color:var(--muted);margin-bottom:8px">VAQTNI TANLANG</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:14px" id="reminder-times">
        <button class="rem-pill" onclick="setReminderTime('07:00')">üåÖ 07:00</button>
        <button class="rem-pill" onclick="setReminderTime('09:00')">‚òÄÔ∏è 09:00</button>
        <button class="rem-pill" onclick="setReminderTime('12:00')">üïõ 12:00</button>
        <button class="rem-pill" onclick="setReminderTime('18:00')">üåÜ 18:00</button>
        <button class="rem-pill" onclick="setReminderTime('20:00')">üåô 20:00</button>
        <button class="rem-pill" onclick="setReminderTime('22:00')">üåÉ 22:00</button>
      </div>
      <div style="background:var(--s2);border-radius:12px;padding:12px;margin-bottom:12px;display:flex;align-items:center;gap:10px">
        <span style="font-size:20px">‚è∞</span>
        <div><div style="font-size:12px;color:var(--muted)">Tanlangan vaqt</div><div style="font-size:16px;font-weight:800;color:var(--text)" id="selected-reminder-time">Tanlanmagan</div></div>
      </div>
      <button onclick="saveReminder()" style="width:100%;padding:13px;background:linear-gradient(135deg,var(--purple),var(--accent));border:none;border-radius:13px;color:white;font-weight:800;font-size:14px;cursor:pointer;font-family:'Nunito',sans-serif">
        üîî Eslatmani Saqlash
      </button>
      <div style="text-align:center;font-size:11px;color:var(--muted);margin-top:8px" id="reminder-status">Hali eslatma o'rnatilmagan</div>
    </div>
  </div>
</div>

<!-- ACHIEVEMENTS MODAL -->
<div class="overlay" id="modal-achievements" onclick="closeModal(event,'modal-achievements')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-achievements')">‚úï</div>
    <div class="sb">
      <div class="st">üèÖ Achievementlar</div>
      <div style="display:flex;justify-content:space-between;align-items:center;background:var(--s2);border-radius:12px;padding:10px 14px;margin-bottom:14px">
        <div style="font-size:12px;color:var(--muted)">Ochilgan</div>
        <div style="font-size:16px;font-weight:800;color:var(--gold)"><span id="ach-unlocked">0</span> / <span id="ach-total">0</span></div>
      </div>
      <div id="ach-list" style="display:flex;flex-direction:column;gap:8px"></div>
    </div>
  </div>
</div>

<!-- PREMIUM AVATARS MODAL -->
<div class="overlay" id="modal-prem-avatar" onclick="closeModal(event,'modal-prem-avatar')">
  <div class="sheet">
    <div class="sh"></div>
    <div class="sc" onclick="closeModal(null,'modal-prem-avatar')">‚úï</div>
    <div class="sb">
      <div class="st">üé® Premium Avatarlar</div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:14px">Eksklyuziv premium avatar kolleksiyasi</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px" id="prem-av-grid"></div>
      <div style="background:var(--s2);border-radius:12px;padding:12px;text-align:center">
        <div style="font-size:12px;color:var(--muted)">Tanlangan</div>
        <div style="font-size:36px;margin:6px 0" id="prem-av-selected">‚Äî</div>
      </div>
      <button onclick="applyPremiumAvatar()" style="width:100%;margin-top:12px;padding:13px;background:linear-gradient(135deg,var(--purple),var(--accent));border:none;border-radius:13px;color:white;font-weight:800;font-size:14px;cursor:pointer;font-family:'Nunito',sans-serif">
        ‚úÖ Qo'llash
      </button>
    </div>
  </div>
</div>

</script>

</body>
</html>
